---
import BaseLayout from "../layouts/BaseLayout.astro";
import { getCollection } from 'astro:content';
import readingTime from '../utils/readingTime';
import { plainExcerpt } from '../utils/excerpt';
import TableOfContents from '../components/TableOfContents.astro';

export async function getStaticPaths() {
  const posts = await getCollection('posts');
  return posts.map(post => ({ params: { slug: post.slug } }));
}

const { slug } = Astro.params;
const posts = await getCollection('posts');
const post = posts.find(p => p.slug === slug);
if (!post) throw new Error(`Post not found for slug: ${slug}`);
const stats = readingTime(post.body);
const excerpt = plainExcerpt(post.body, 30, 160);
const canonical = `/${post.slug}/`;
const structuredData = {
  '@context': 'https://schema.org',
  '@type': 'Article',
  headline: post.data.title,
  datePublished: post.data.pubDate.toISOString(),
  dateModified: post.data.pubDate.toISOString(),
  author: {
    '@type': 'Person',
    name: 'AREZKI El Mehdi'
  },
  mainEntityOfPage: {
    '@type': 'WebPage',
    '@id': 'https://earezki.com' + canonical
  },
  description: excerpt
};
const { Content } = await post.render();
---
<BaseLayout title={post.data.title} description={excerpt} canonical={canonical} structuredData={structuredData}>
  <div class="post-layout">
    <aside class="sidebar-left">
      <TableOfContents markdown={post.body} />
    </aside>
    <article class="post">
      <header class="post-header">
        <h1>{post.data.title}</h1>
        <div class="meta">
          <time datetime={post.data.pubDate.toISOString()}>{post.data.pubDate.toDateString()}</time>
          <span>• {stats.text}</span>
        </div>
        {post.data.categories && <div class="tag-row">{post.data.categories.map(c => {
          const slugTag = c.toLowerCase().replace(/\s+/g,'-');
          const isAINews = c.toLowerCase() === 'ai news';
          return <a class={`tag ${isAINews ? 'ai-news-tag' : ''}`} href={`/tags/${encodeURIComponent(slugTag)}/`}>{c}</a>;
        })}</div>}
      </header>
      <div class="post-body prose">
        <Content />
      </div>
    </article>
  </div>
  <div class="back-link"><a href="/">← Back to home</a></div>
</BaseLayout>

<style>
  .post-layout { display:grid; grid-template-columns: 260px 1fr; gap:2.5rem; }
  .sidebar-left { position:relative; }
  @media (max-width: 1080px) { .post-layout { grid-template-columns: 1fr; } }
</style>
