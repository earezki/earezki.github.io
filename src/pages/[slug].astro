---
import BaseLayout from "../layouts/BaseLayout.astro";
import { getCollection } from 'astro:content';
import readingTime from '../utils/readingTime';
import { plainExcerpt } from '../utils/excerpt';
import TableOfContents from '../components/TableOfContents.astro';
import Breadcrumbs from '../components/Breadcrumbs.astro';
import RelatedPosts from '../components/RelatedPosts.astro';
import SeriesNavigation from '../components/SeriesNavigation.astro';
import { findRelatedPosts, detectSeries, findSeriesPosts, generateBreadcrumbs } from '../utils/relatedContent';

export async function getStaticPaths() {
  const posts = await getCollection('posts');
  return posts.map(post => ({ params: { slug: post.slug } }));
}

const { slug } = Astro.params;
const posts = await getCollection('posts');
const ainews = await getCollection('ainews');
const post = posts.find(p => p.slug === slug);
if (!post) throw new Error(`Post not found for slug: ${slug}`);

// Calculate post metadata
const stats = readingTime(post.body);
const excerpt = plainExcerpt(post.body, 30, 160);
const canonical = `/${post.slug}/`;
const postImage = `https://earezki.com/assets/og-image-default.jpg`;
const postKeywords = post.data.categories?.join(', ') || 'software architecture, backend development';

// Generate breadcrumbs
const breadcrumbs = generateBreadcrumbs(canonical, post.data.title);

// Find related content (cross-collection)
const relatedPosts = findRelatedPosts(post, posts, ainews, 3);
const series = detectSeries(post);
const seriesPosts = series ? findSeriesPosts(post, posts) : [];

const structuredData = {
  '@context': 'https://schema.org',
  '@type': 'BlogPosting',
  headline: post.data.title,
  description: excerpt,
  image: postImage,
  datePublished: post.data.pubDate.toISOString(),
  dateModified: post.data.pubDate.toISOString(),
  author: {
    '@type': 'Person',
    name: 'El Mehdi Arezki',
    url: 'https://earezki.com/about',
    jobTitle: 'Lead Software Engineer',
    sameAs: [
      'https://github.com/earezki',
      'https://www.linkedin.com/in/mehdi-arezki'
    ]
  },
  publisher: {
    '@type': 'Organization',
    name: 'Dev|Journal',
    url: 'https://earezki.com',
    logo: {
      '@type': 'ImageObject',
      url: 'https://earezki.com/assets/logo.png'
    }
  },
  mainEntityOfPage: {
    '@type': 'WebPage',
    '@id': 'https://earezki.com' + canonical
  }
};
const { Content } = await post.render();
---
<BaseLayout 
  title={post.data.title} 
  description={excerpt} 
  keywords={postKeywords}
  canonical={canonical} 
  image={postImage}
  structuredData={structuredData}>
  <Breadcrumbs breadcrumbs={breadcrumbs} />
  <div class="post-layout">
    <aside class="sidebar-left">
      <TableOfContents markdown={post.body} />
    </aside>
    <article class="post">
      <header class="post-header">
        <h1>{post.data.title}</h1>
        <div class="meta">
          <time datetime={post.data.pubDate.toISOString()}>{post.data.pubDate.toDateString()}</time>
          <span>• {stats.text}</span>
        </div>
        {post.data.categories && <div class="tag-row">{post.data.categories.map((c: string) => {
          const slugTag = c.toLowerCase().replace(/\s+/g,'-');
          const isAINews = c.toLowerCase() === 'ai news';
          return <a class={`tag ${isAINews ? 'ai-news-tag' : ''}`} href={`/tags/${encodeURIComponent(slugTag)}/`}>{c}</a>;
        })}</div>}
      </header>
      <div class="post-body prose">
        <Content />
      </div>
      
      {/* Series Navigation - appears if post is part of a series */}
      {series && seriesPosts.length > 1 && (
        <SeriesNavigation series={series} posts={seriesPosts} currentSlug={slug!} />
      )}
      
      {/* Related Posts */}
      <RelatedPosts posts={relatedPosts} />
    </article>
  </div>
  <div class="back-link"><a href="/">← Back to home</a></div>
</BaseLayout>

<style>
  .post-layout { display:grid; grid-template-columns: 260px 1fr; gap:2.5rem; }
  .sidebar-left { position:relative; }
  @media (max-width: 1080px) { .post-layout { grid-template-columns: 1fr; } }
</style>
