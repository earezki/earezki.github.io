---
import { slugify } from '../utils/slugify';

interface Props { 
  /** Markdown content to extract headings from */
  markdown: string; 
  /** Minimum heading level (default: 2 for h2) */
  min?: number; 
  /** Maximum heading level (default: 4 for h4) */
  max?: number; 
}

interface TocItem {
  depth: number;
  text: string;
  slug: string;
}

const { markdown, min = 2, max = 4 } = Astro.props;

// Extract headings from markdown
const headingRegex = new RegExp(`^#{${min},${max}}\\s+(.+)$`, 'gm');
const items: TocItem[] = [];
let match: RegExpExecArray | null;

while ((match = headingRegex.exec(markdown)) !== null) {
  const line = match[0];
  const text = match[1].trim();
  const depth = line.match(/^#+/)![0].length;
  const slug = slugify(text);
  
  items.push({ depth, text, slug });
}

// Don't render TOC if no headings found
if (items.length === 0) {
  return null;
}
---

<nav class="toc" aria-label="Table of Contents">
  <div class="toc-title">On this page</div>
  <ul>
    {items.map(item => (
      <li class={`d-${item.depth}`}>
        <a href={`#${item.slug}`}>
          {item.text}
        </a>
      </li>
    ))}
  </ul>
</nav>

<style>
  .toc { 
    position: sticky; 
    top: 90px; 
    max-height: calc(100vh - 120px); 
    overflow: auto; 
    padding: 1rem 1rem 1.2rem; 
    background: var(--color-bg-alt); 
    border: 1px solid var(--color-border); 
    border-radius: var(--radius-md); 
    font-size: 0.8rem; 
    line-height: 1.3; 
  }
  
  .toc-title { 
    font-weight: 600; 
    font-size: 0.75rem; 
    text-transform: uppercase; 
    letter-spacing: 0.08em; 
    margin-bottom: 0.6rem; 
    color: var(--color-text-alt); 
  }
  
  .toc ul { 
    list-style: none; 
    margin: 0; 
    padding: 0; 
    display: flex; 
    flex-direction: column; 
    gap: 0.35rem; 
  }
  
  .toc a { 
    text-decoration: none; 
    color: var(--color-text-alt);
    transition: color var(--transition);
  }
  
  .toc a:hover { 
    color: var(--color-accent); 
  }
  
  /* Indentation for nested headings */
  .toc li[class*='d-3'] { 
    margin-left: 0.75rem; 
  }
  
  .toc li[class*='d-4'] { 
    margin-left: 1.4rem; 
  }
  
  /* Hide TOC on smaller screens */
  @media (max-width: 1080px) { 
    .toc { 
      display: none; 
    } 
  }
</style>
