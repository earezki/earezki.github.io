<!DOCTYPE html><html lang="en" data-theme="dark"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>FastAPI in Production - Full Guide • Dev|Journal</title><meta name="description" content="FastAPI in Production - Full Guide 1. TL;DR - When FastAPI Wins and Loses FastAPI is genuinely excellent for: - **High-throughput JSON APIs** where…"><meta name="keywords" content="Python, FastAPI, Backend, Production, Performance"><meta name="author" content="El Mehdi Arezki"><meta property="og:type" content="website"><meta property="og:url" content="https://earezki.com/fastapi-full-guide/"><meta property="og:title" content="FastAPI in Production - Full Guide • Dev|Journal"><meta property="og:site_name" content="Dev|Journal"><meta property="og:description" content="FastAPI in Production - Full Guide 1. TL;DR - When FastAPI Wins and Loses FastAPI is genuinely excellent for: - **High-throughput JSON APIs** where…"><meta property="og:image" content="https://earezki.com/assets/og-image-default.jpg"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:url" content="https://earezki.com/fastapi-full-guide/"><meta name="twitter:title" content="FastAPI in Production - Full Guide • Dev|Journal"><meta name="twitter:description" content="FastAPI in Production - Full Guide 1. TL;DR - When FastAPI Wins and Loses FastAPI is genuinely excellent for: - **High-throughput JSON APIs** where…"><meta name="twitter:image" content="https://earezki.com/assets/og-image-default.jpg"><meta name="twitter:creator" content="@earezki"><link rel="canonical" href="https://earezki.com/fastapi-full-guide/"><link rel="icon" type="image/png" href="/assets/favicon_48_d.webp"><link rel="alternate" type="application/rss+xml" title="RSS" href="/rss.xml"><link rel="dns-prefetch" href="https://cloud.umami.is"><script defer src="https://cloud.umami.is/script.js" data-website-id="4a26531d-1053-4f79-97a6-06a1366aff91"></script><script>
      (function() {
        const theme = localStorage.getItem('theme');
        if (theme) document.documentElement.setAttribute('data-theme', theme);
      })();
    </script><script>
!function(){const o=window.location.pathname;if("/"===o)return;if(/\.\w+$/.test(o))return;const n=o.toLowerCase(),i=n!==o,t=!o.endsWith("/");if(i||t){const o=n+(t?"/":""),i=window.location.origin+o+window.location.search+window.location.hash;window.location.replace(i)}}();
</script><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","headline":"FastAPI in Production - Full Guide","description":"FastAPI in Production - Full Guide 1. TL;DR - When FastAPI Wins and Loses FastAPI is genuinely excellent for: - **High-throughput JSON APIs** where…","image":"https://earezki.com/assets/og-image-default.jpg","datePublished":"2025-11-28T00:00:00.000Z","dateModified":"2025-11-28T00:00:00.000Z","author":{"@type":"Person","name":"El Mehdi Arezki","url":"https://earezki.com/about","jobTitle":"Lead Software Engineer","sameAs":["https://github.com/earezki","https://www.linkedin.com/in/mehdi-arezki"]},"publisher":{"@type":"Organization","name":"Dev|Journal","url":"https://earezki.com","logo":{"@type":"ImageObject","url":"https://earezki.com/assets/logo.png"}},"mainEntityOfPage":{"@type":"WebPage","@id":"https://earezki.com/fastapi-full-guide/"}}</script><link rel="stylesheet" href="/_astro/_slug_.B_eXuGWa.css">
<link rel="stylesheet" href="/_astro/_slug_.CFj9bTVJ.css">
<link rel="stylesheet" href="/_astro/_slug_.BuIxISHP.css"></head> <body> <div id="readingProgress" role="progressbar" aria-label="Reading progress" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="position:fixed;left:0;top:0;height:3px;background:linear-gradient(90deg,#2563eb,#9333ea);width:0;z-index:999;transition:width .15s ease;"></div> <script type="module">function c(){const t=document.getElementById("readingProgress");if(!t)return;const o=()=>{const e=document.documentElement,r=e.scrollTop||document.body.scrollTop,s=e.scrollHeight-e.clientHeight,n=s>0?r/s*100:0;t.style.width=`${n}%`,t.setAttribute("aria-valuenow",n.toFixed(0))};document.addEventListener("scroll",o,{passive:!0}),o()}c();</script> <header class="site-header container"> <div class="logo-wrap"> <a class="logo" href="/" aria-label="Dev|Journal Home">
Dev|Journal
</a> </div> <!-- Search Box in Header --> <div class="header-search" data-search-api-url="https://api.earezki.com/blog/api/q" data-search-timeout="2000"> <div class="search-box" id="search-box"> <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="search-icon" aria-hidden="true"> <circle cx="11" cy="11" r="8"></circle> <path d="m21 21-4.35-4.35"></path> </svg> <input type="text" id="search-input" placeholder="Search ..." class="search-input" autocomplete="off" aria-label="Search articles" minlength="3"> <button id="clear-search" class="clear-button" style="display: none;" aria-label="Clear search"> <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <line x1="18" y1="6" x2="6" y2="18"></line> <line x1="6" y1="6" x2="18" y2="18"></line> </svg> </button> </div> <div id="search-results" class="search-results" role="status" aria-live="polite"></div> </div> <script type="module" src="/_astro/SearchBox.astro_astro_type_script_index_0_lang.BNnBPVSN.js"></script> <nav class="main-nav" aria-label="Main navigation"> <a href="/"> <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" style="vertical-align: -2px; margin-right: 4px;"> <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path> <polyline points="9 22 9 12 15 12 15 22"></polyline> </svg>
Home
</a> <a href="/ai-news/" class="ai-news-link ai-gradient-nav"> <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" style="vertical-align: -2px; margin-right: 4px;"> <path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h-9.5a.5.5 0 0 0-.5.5.5.5 0 0 1-1 0 .5.5 0 0 0-.5-.5H1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2z"></path> <path d="M7 15v4a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-4"></path> </svg>
AI News
</a> <a href="/ai-financial-news/" class="ai-financial-link ai-gradient-nav"> <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" style="vertical-align: -2px; margin-right: 4px;"> <line x1="12" y1="1" x2="12" y2="23"></line> <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path> </svg>
AI Financial
</a> <a href="/about/"> <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" style="vertical-align: -2px; margin-right: 4px;"> <circle cx="12" cy="12" r="10"></circle> <path d="M12 16v-4"></path> <path d="M12 8h.01"></path> </svg>
About
</a> <button id="themeToggle" class="theme-toggle" aria-label="Toggle dark mode"> <span class="theme-icon" aria-hidden="true">☾</span> </button> </nav> </header> <!-- Main Content --> <main class="container content-area">  <nav class="breadcrumbs" aria-label="Breadcrumb" data-astro-cid-ilhxcym7> <ol data-astro-cid-ilhxcym7> <li data-astro-cid-ilhxcym7>  <a href="/" data-astro-cid-ilhxcym7>Home</a> <span class="separator" aria-hidden="true" data-astro-cid-ilhxcym7>/</span>  </li><li data-astro-cid-ilhxcym7> <span class="current" aria-current="page" data-astro-cid-ilhxcym7>FastAPI in Production - Full Guide</span> </li>  </ol> </nav>  <div class="post-layout" data-astro-cid-yvbahnfj> <aside class="sidebar-left" data-astro-cid-yvbahnfj> <nav class="toc" aria-label="Table of Contents" data-astro-cid-xvrfupwn> <div class="toc-title" data-astro-cid-xvrfupwn>On this page</div> <ul data-astro-cid-xvrfupwn> <li class="d-2" data-astro-cid-xvrfupwn> <a href="#1-tldr-when-fastapi-wins-and-loses" data-astro-cid-xvrfupwn> 1. TL;DR - When FastAPI Wins and Loses </a> </li><li class="d-2" data-astro-cid-xvrfupwn> <a href="#2-project-layout" data-astro-cid-xvrfupwn> 2. Project Layout </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#the-three-layouts-people-actually-use" data-astro-cid-xvrfupwn> The Three Layouts People Actually Use </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#real-50-endpoint-project-tree" data-astro-cid-xvrfupwn> Real 50+ Endpoint Project Tree </a> </li><li class="d-2" data-astro-cid-xvrfupwn> <a href="#3-dependency-injection-done-right-and-the-5-ways-people-screw-it-up" data-astro-cid-xvrfupwn> 3. Dependency Injection Done Right (and the 5 ways people screw it up) </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#pattern-1-database-sessions-scoped" data-astro-cid-xvrfupwn> Pattern 1: Database Sessions (Scoped) </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#pattern-2-current-user-cached" data-astro-cid-xvrfupwn> Pattern 2: Current User (Cached) </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#pattern-3-configuration-singletons-global" data-astro-cid-xvrfupwn> Pattern 3: Configuration Singletons (Global) </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#pattern-4-external-service-clients-singleton-with-dependency" data-astro-cid-xvrfupwn> Pattern 4: External Service Clients (Singleton with Dependency) </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#pattern-5-complex-dependency-chains" data-astro-cid-xvrfupwn> Pattern 5: Complex Dependency Chains </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#the-5-ways-people-screw-up-dependencies" data-astro-cid-xvrfupwn> The 5 Ways People Screw Up Dependencies </a> </li><li class="d-2" data-astro-cid-xvrfupwn> <a href="#4-pydantic-v2" data-astro-cid-xvrfupwn> 4. Pydantic v2 </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#custom-validators-that-actually-work" data-astro-cid-xvrfupwn> Custom Validators That Actually Work </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#computed-fields-new-in-v2" data-astro-cid-xvrfupwn> Computed Fields (New in v2) </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#modelconfig-replaces-config-class" data-astro-cid-xvrfupwn> model_config (Replaces Config class) </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#performance-basemodel-vs-dataclasses-vs-typeddict" data-astro-cid-xvrfupwn> Performance: BaseModel vs dataclasses vs TypedDict </a> </li><li class="d-2" data-astro-cid-xvrfupwn> <a href="#5-async-vs-sync-the-rules-nobody-follows" data-astro-cid-xvrfupwn> 5. Async vs Sync - The Rules Nobody Follows </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#when-to-actually-use-async-def" data-astro-cid-xvrfupwn> When to Actually Use async def </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#the-blocking-io-death-spiral" data-astro-cid-xvrfupwn> The Blocking I/O Death Spiral </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#sync-database-queries-in-async-routes" data-astro-cid-xvrfupwn> Sync Database Queries in Async Routes </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#working-sync-to-async-wrappers" data-astro-cid-xvrfupwn> Working Sync-to-Async Wrappers </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#the-i-dont-know-rule" data-astro-cid-xvrfupwn> The &quot;I Don&#39;t Know&quot; Rule </a> </li><li class="d-2" data-astro-cid-xvrfupwn> <a href="#6-uvicorn-vs-hypercorn-vs-daphne-what-we-actually-run-in-2025" data-astro-cid-xvrfupwn> 6. Uvicorn vs Hypercorn vs Daphne - What We Actually Run in 2025 </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#uvicorn-our-default-choice" data-astro-cid-xvrfupwn> Uvicorn (Our Default Choice) </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#hypercorn-http2-and-http3" data-astro-cid-xvrfupwn> Hypercorn (HTTP/2 and HTTP/3) </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#daphne-django-channels-legacy" data-astro-cid-xvrfupwn> Daphne (Django Channels Legacy) </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#graceful-reload-without-leaking-connections" data-astro-cid-xvrfupwn> Graceful Reload Without Leaking Connections </a> </li><li class="d-2" data-astro-cid-xvrfupwn> <a href="#7-connection-pooling-and-database-access-patterns" data-astro-cid-xvrfupwn> 7. Connection Pooling and Database Access Patterns </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#sqlalchemy-20-asyncpg-our-production-setup" data-astro-cid-xvrfupwn> SQLAlchemy 2.0 + asyncpg (Our Production Setup) </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#sqlalchemy-20-patterns" data-astro-cid-xvrfupwn> SQLAlchemy 2.0 Patterns </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#prisma-tortoise-sqlmodel-honest-trade-offs" data-astro-cid-xvrfupwn> Prisma, Tortoise, SQLModel - Honest Trade-offs </a> </li><li class="d-2" data-astro-cid-xvrfupwn> <a href="#8-timeouts-retries-and-circuit-breakers" data-astro-cid-xvrfupwn> 8. Timeouts, Retries, and Circuit Breakers </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#httpx-anyio-timeouts-that-actually-work" data-astro-cid-xvrfupwn> httpx + anyio Timeouts That Actually Work </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#retry-logic-with-tenacity" data-astro-cid-xvrfupwn> Retry Logic with Tenacity </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#circuit-breaker-pattern" data-astro-cid-xvrfupwn> Circuit Breaker Pattern </a> </li><li class="d-2" data-astro-cid-xvrfupwn> <a href="#9-cache-control-headers-leverage-cdns-without-thinking" data-astro-cid-xvrfupwn> 9. Cache Control Headers - Leverage CDNs Without Thinking </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#the-http-cache-control-header" data-astro-cid-xvrfupwn> The HTTP Cache Control Header </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#implementation" data-astro-cid-xvrfupwn> Implementation </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#cache-busting-with-etag" data-astro-cid-xvrfupwn> Cache Busting with ETag </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#last-modified-header-conditional-requests" data-astro-cid-xvrfupwn> Last-Modified Header (Conditional Requests) </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#middleware-for-automatic-cache-headers" data-astro-cid-xvrfupwn> Middleware for Automatic Cache Headers </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#cdn-integration-cloudflare-example" data-astro-cid-xvrfupwn> CDN Integration (Cloudflare Example) </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#busting-cache-on-updates" data-astro-cid-xvrfupwn> Busting Cache on Updates </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#cache-stampede-prevention" data-astro-cid-xvrfupwn> Cache Stampede Prevention </a> </li><li class="d-2" data-astro-cid-xvrfupwn> <a href="#10-file-uploads-downloads-and-multipart-the-footguns-nobody-warns-about" data-astro-cid-xvrfupwn> 10. File Uploads, Downloads, and Multipart - The Footguns Nobody Warns About </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#file-upload-the-naive-approach-works-until-500mb" data-astro-cid-xvrfupwn> File Upload - The Naive Approach (Works Until 500MB) </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#file-upload-production-pattern" data-astro-cid-xvrfupwn> File Upload - Production Pattern </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#multiple-file-uploads" data-astro-cid-xvrfupwn> Multiple File Uploads </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#file-download-streaming-for-large-files" data-astro-cid-xvrfupwn> File Download - Streaming for Large Files </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#streaming-upload-with-progress-tracking" data-astro-cid-xvrfupwn> Streaming Upload with Progress Tracking </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#file-upload-with-database-tracking" data-astro-cid-xvrfupwn> File Upload with Database Tracking </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#s3-upload-with-presigned-urls-production-standard" data-astro-cid-xvrfupwn> S3 Upload with Presigned URLs (Production Standard) </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#security-checklist-for-file-handling" data-astro-cid-xvrfupwn> Security Checklist for File Handling </a> </li><li class="d-2" data-astro-cid-xvrfupwn> <a href="#11-background-tasks-the-feature-everyone-abuses" data-astro-cid-xvrfupwn> 11. Background Tasks - The Feature Everyone Abuses </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#when-backgroundtasks-is-fine" data-astro-cid-xvrfupwn> When BackgroundTasks is Fine </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#when-backgroundtasks-will-bite-you" data-astro-cid-xvrfupwn> When BackgroundTasks Will Bite You </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#runinthreadpool-the-middle-ground" data-astro-cid-xvrfupwn> run_in_threadpool - The Middle Ground </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#when-to-reach-for-celeryrqarq" data-astro-cid-xvrfupwn> When to Reach for Celery/RQ/Arq </a> </li><li class="d-2" data-astro-cid-xvrfupwn> <a href="#12-websockets-at-scale-dont-do-what-we-did-first" data-astro-cid-xvrfupwn> 12. WebSockets at Scale - Don&#39;t Do What We Did First </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#the-naive-approach-works-until-1000-connections" data-astro-cid-xvrfupwn> The Naive Approach (Works Until ~1000 Connections) </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#connection-limits-reality" data-astro-cid-xvrfupwn> Connection Limits Reality </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#redis-pubsub-pattern-production-setup" data-astro-cid-xvrfupwn> Redis Pub/Sub Pattern (Production Setup) </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#backpressure-and-dead-connection-cleanup" data-astro-cid-xvrfupwn> Backpressure and Dead Connection Cleanup </a> </li><li class="d-2" data-astro-cid-xvrfupwn> <a href="#13-openapi-redoc-and-stopping-the-but-the-docs-say-arguments" data-astro-cid-xvrfupwn> 13. OpenAPI, Redoc, and Stopping the &quot;But the docs say…&quot; Arguments </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#custom-openapi-spec" data-astro-cid-xvrfupwn> Custom OpenAPI Spec </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#rich-response-examples" data-astro-cid-xvrfupwn> Rich Response Examples </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#painless-api-versioning" data-astro-cid-xvrfupwn> Painless API Versioning </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#hiding-docs-in-production" data-astro-cid-xvrfupwn> Hiding Docs in Production </a> </li><li class="d-2" data-astro-cid-xvrfupwn> <a href="#14-testing-strategy-that-scales" data-astro-cid-xvrfupwn> 14. Testing Strategy That Scales </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#httpx-vs-testclient-the-right-choice" data-astro-cid-xvrfupwn> httpx vs TestClient - The Right Choice </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#non-flaky-async-tests" data-astro-cid-xvrfupwn> Non-Flaky Async Tests </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#schemathesis-contract-testing" data-astro-cid-xvrfupwn> Schemathesis Contract Testing </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#integration-tests-worth-writing" data-astro-cid-xvrfupwn> Integration Tests Worth Writing </a> </li><li class="d-2" data-astro-cid-xvrfupwn> <a href="#15-observability-traces-metrics-logs" data-astro-cid-xvrfupwn> 15. Observability - Traces, Metrics, Logs </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#opentelemetry-auto-instrumentation" data-astro-cid-xvrfupwn> OpenTelemetry Auto-Instrumentation </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#must-have-prometheus-metrics" data-astro-cid-xvrfupwn> Must-Have Prometheus Metrics </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#structured-logging-with-logfire" data-astro-cid-xvrfupwn> Structured Logging with logfire </a> </li><li class="d-2" data-astro-cid-xvrfupwn> <a href="#16-deployment-targets-in-2025" data-astro-cid-xvrfupwn> 16. Deployment Targets in 2025 </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#docker-multi-stage-build" data-astro-cid-xvrfupwn> Docker Multi-Stage Build </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#kubernetes-deployment" data-astro-cid-xvrfupwn> Kubernetes Deployment </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#aws-lambda-powertools-cold-start-reality" data-astro-cid-xvrfupwn> AWS Lambda + Powertools (Cold Start Reality) </a> </li><li class="d-2" data-astro-cid-xvrfupwn> <a href="#17-security-checklist-nobody-reads-until-breach" data-astro-cid-xvrfupwn> 17. Security Checklist Nobody Reads Until Breach </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#cors-configuration-done-right" data-astro-cid-xvrfupwn> CORS Configuration Done Right </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#rate-limiting" data-astro-cid-xvrfupwn> Rate Limiting </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#jwt-vs-opaque-tokens-vs-paseto" data-astro-cid-xvrfupwn> JWT vs Opaque Tokens vs PASETO </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#dependency-scanning" data-astro-cid-xvrfupwn> Dependency Scanning </a> </li><li class="d-2" data-astro-cid-xvrfupwn> <a href="#18-performance-benchmarks-2025-hardware-numbers" data-astro-cid-xvrfupwn> 18. Performance Benchmarks - 2025 Hardware Numbers </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#json-serialization-shootout" data-astro-cid-xvrfupwn> JSON Serialization Shootout </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#rps-vs-connection-pool-size" data-astro-cid-xvrfupwn> RPS vs Connection Pool Size </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#cold-start-comparison" data-astro-cid-xvrfupwn> Cold Start Comparison </a> </li><li class="d-2" data-astro-cid-xvrfupwn> <a href="#19-the-official-do-not-do-this-in-production-list" data-astro-cid-xvrfupwn> 19. The Official &quot;Do Not Do This in Production&quot; List </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#1-blocking-io-in-async-routes" data-astro-cid-xvrfupwn> 1. Blocking I/O in async Routes </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#2-storing-secrets-in-code" data-astro-cid-xvrfupwn> 2. Storing Secrets in Code </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#3-no-database-connection-pooling" data-astro-cid-xvrfupwn> 3. No Database Connection Pooling </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#4-returning-sqlalchemy-models-directly" data-astro-cid-xvrfupwn> 4. Returning SQLAlchemy Models Directly </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#5-no-request-timeout" data-astro-cid-xvrfupwn> 5. No Request Timeout </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#6-alloworigins-with-credentials" data-astro-cid-xvrfupwn> 6. allow_origins=[&quot;*&quot;] with Credentials </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#7-no-input-validation" data-astro-cid-xvrfupwn> 7. No Input Validation </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#8-logging-sensitive-data" data-astro-cid-xvrfupwn> 8. Logging Sensitive Data </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#9-no-database-migration-strategy" data-astro-cid-xvrfupwn> 9. No Database Migration Strategy </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#10-forgetting-to-set-processworker-limits" data-astro-cid-xvrfupwn> 10. Forgetting to Set process/worker Limits </a> </li><li class="d-2" data-astro-cid-xvrfupwn> <a href="#20-final-production-checklist" data-astro-cid-xvrfupwn> 20. Final Production Checklist </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#before-deployment" data-astro-cid-xvrfupwn> Before Deployment </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#infrastructure" data-astro-cid-xvrfupwn> Infrastructure </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#security" data-astro-cid-xvrfupwn> Security </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#documentation" data-astro-cid-xvrfupwn> Documentation </a> </li><li class="d-3" data-astro-cid-xvrfupwn> <a href="#performance" data-astro-cid-xvrfupwn> Performance </a> </li> </ul> </nav>  </aside> <article class="post" data-astro-cid-yvbahnfj> <header class="post-header" data-astro-cid-yvbahnfj> <h1 data-astro-cid-yvbahnfj>FastAPI in Production - Full Guide</h1> <div class="meta" data-astro-cid-yvbahnfj> <time datetime="2025-11-28T00:00:00.000Z" data-astro-cid-yvbahnfj>Fri Nov 28 2025</time> <span data-astro-cid-yvbahnfj>• 45 min read</span> </div> <div class="tag-row" data-astro-cid-yvbahnfj><a class="post-tag  " href="/tags/python/" data-astro-cid-yvbahnfj>Python</a><a class="post-tag  " href="/tags/fastapi/" data-astro-cid-yvbahnfj>FastAPI</a><a class="post-tag  " href="/tags/backend/" data-astro-cid-yvbahnfj>Backend</a><a class="post-tag  " href="/tags/production/" data-astro-cid-yvbahnfj>Production</a><a class="post-tag  " href="/tags/performance/" data-astro-cid-yvbahnfj>Performance</a></div> </header>     <div class="post-body prose" data-astro-cid-yvbahnfj> <h1 id="fastapi-in-production---full-guide">FastAPI in Production - Full Guide</h1>
<h2 id="1-tldr---when-fastapi-wins-and-loses">1. TL;DR - When FastAPI Wins and Loses</h2>
<p>FastAPI is genuinely excellent for:</p>
<ul>
<li><strong>High-throughput JSON APIs</strong> where serialization is a bottleneck (20-40% faster than Flask/Django on AWS c6i.xlarge)</li>
<li><strong>Teams that already use type hints</strong> and want validation baked in</li>
<li><strong>Internal services</strong> where auto-generated OpenAPI docs save weeks of Confluence hell</li>
<li><strong>Async-heavy workloads</strong> (WebSockets, SSE, concurrent external API calls)</li>
</ul>
<p>FastAPI is the wrong choice when:</p>
<ul>
<li>Your team doesn’t know async/await (you’ll ship threading bugs)</li>
<li>You need Django’s batteries (auth, admin, ORM migrations without SQLAlchemy)</li>
<li>You’re building a CRUD app and “fast” means development speed, not RPS</li>
</ul>
<p><strong>Benchmark reality check</strong> (AWS c6i.2xlarge, 8 vCPU, Python 3.12, single-process Uvicorn):</p>
<ul>
<li>FastAPI + orjson: ~18,000 RPS for simple JSON endpoint (p99 &#x3C; 8ms)</li>
<li>Flask + standard json: ~12,000 RPS (p99 ~15ms)</li>
<li>Django: ~8,000 RPS (p99 ~22ms)</li>
</ul>
<p>These numbers collapse instantly if you do blocking I/O in async routes. We’ll cover that footgun in section 5.</p>
<h2 id="2-project-layout">2. Project Layout</h2>
<h3 id="the-three-layouts-people-actually-use">The Three Layouts People Actually Use</h3>
<p><strong>Single-file hell</strong> (<code>main.py</code> with 3000+ lines):</p>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token comment"># Don't do this. Seriously.</span>
<span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPI
app <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/users"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">get_users</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/users"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">create_user</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token comment"># ... 80 more endpoints</span>
<span class="token comment"># ... all the models</span>
<span class="token comment"># ... all the database code</span>
<span class="token comment"># ... your hopes and dreams</span>
</code></pre>
<p><strong>app/ layout</strong> (FastAPI docs default):</p>
<pre class="language-plaintext" data-language="plaintext"><code is:raw="" class="language-plaintext">project/
├── app/
│   ├── __init__.py
│   ├── main.py
│   ├── models.py
│   ├── schemas.py
│   ├── crud.py
│   └── routers/
│       ├── users.py
│       └── items.py
</code></pre>
<p>Fine for small projects. Falls apart when you have 50+ endpoints because <code>schemas.py</code> becomes 2000 lines.</p>
<p><strong>src/ layout</strong> (what I run in production):</p>
<pre class="language-plaintext" data-language="plaintext"><code is:raw="" class="language-plaintext">project/
├── pyproject.toml
├── README.md
├── docker-compose.yml
├── Dockerfile
├── tests/
│   ├── __init__.py
│   ├── conftest.py
│   ├── test_users.py
│   ├── test_orders.py
│   └── integration/
│       └── test_webhooks.py
└── src/
    └── myapp/
        ├── __init__.py
        ├── main.py              # App factory
        ├── config.py            # Pydantic settings
        ├── dependencies.py      # Shared Depends
        ├── exceptions.py        # Custom exceptions
        ├── middleware.py
        ├── api/
        │   ├── __init__.py
        │   └── v1/
        │       ├── __init__.py
        │       ├── router.py    # Aggregates all v1 routes
        │       ├── users.py
        │       ├── orders.py
        │       ├── payments.py
        │       └── webhooks.py
        ├── core/
        │   ├── __init__.py
        │   ├── security.py      # JWT, passwords
        │   └── pagination.py
        ├── db/
        │   ├── __init__.py
        │   ├── session.py       # SQLAlchemy setup
        │   ├── base.py          # Base model
        │   └── models/
        │       ├── user.py
        │       ├── order.py
        │       └── payment.py
        ├── schemas/
        │   ├── __init__.py
        │   ├── user.py          # Request/response models
        │   ├── order.py
        │   └── common.py        # Shared schemas
        ├── services/
        │   ├── __init__.py
        │   ├── user_service.py  # Business logic
        │   ├── order_service.py
        │   └── notification_service.py
        ├── tasks/
        │   ├── __init__.py
        │   └── email.py         # Background tasks
        └── utils/
            ├── __init__.py
            ├── datetime.py
            └── validators.py
</code></pre>
<h3 id="real-50-endpoint-project-tree">Real 50+ Endpoint Project Tree</h3>
<p>Here’s what an 80-endpoint service might looks like:</p>
<pre class="language-plaintext" data-language="plaintext"><code is:raw="" class="language-plaintext">src/myapp/
├── api/
│   ├── v1/
│   │   ├── auth.py          (5 endpoints: login, refresh, logout, etc.)
│   │   ├── users.py         (8 endpoints: CRUD + profile + avatar)
│   │   ├── teams.py         (6 endpoints)
│   │   ├── projects.py      (12 endpoints: CRUD + sharing + exports)
│   │   ├── tasks.py         (10 endpoints)
│   │   ├── comments.py      (4 endpoints)
│   │   ├── files.py         (7 endpoints: upload, download, delete)
│   │   ├── webhooks.py      (3 endpoints)
│   │   ├── analytics.py     (8 endpoints: metrics, reports)
│   │   ├── admin.py         (6 endpoints: user management)
│   │   └── websocket.py     (2 WebSocket routes)
│   └── v2/
│       └── projects.py      (5 endpoints: new API design)
├── services/
│   ├── auth_service.py
│   ├── user_service.py
│   ├── project_service.py
│   ├── file_service.py      (S3 integration)
│   ├── notification_service.py
│   └── analytics_service.py
├── tasks/
│   ├── exports.py           (CSV/PDF generation)
│   ├── notifications.py
│   └── cleanup.py
└── integrations/
    ├── stripe.py
    ├── sendgrid.py
    └── slack.py
</code></pre>
<p><strong>Key patterns I follow:</strong></p>
<ul>
<li>Each router file has 3-12 endpoints max</li>
<li>Services contain all business logic (routes are thin)</li>
<li>Schemas live separate from models (ORM != API)</li>
<li>Version in the path (<code>/api/v1</code>, <code>/api/v2</code>)</li>
</ul>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token comment"># src/myapp/main.py - The app factory pattern</span>
<span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPI
<span class="token keyword">from</span> contextlib <span class="token keyword">import</span> asynccontextmanager

<span class="token keyword">from</span> <span class="token punctuation">.</span>config <span class="token keyword">import</span> settings
<span class="token keyword">from</span> <span class="token punctuation">.</span>api<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>router <span class="token keyword">import</span> api_router <span class="token keyword">as</span> v1_router
<span class="token keyword">from</span> <span class="token punctuation">.</span>api<span class="token punctuation">.</span>v2<span class="token punctuation">.</span>router <span class="token keyword">import</span> api_router <span class="token keyword">as</span> v2_router
<span class="token keyword">from</span> <span class="token punctuation">.</span>middleware <span class="token keyword">import</span> setup_middleware
<span class="token keyword">from</span> <span class="token punctuation">.</span>db<span class="token punctuation">.</span>session <span class="token keyword">import</span> engine

<span class="token decorator annotation punctuation">@asynccontextmanager</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">lifespan</span><span class="token punctuation">(</span>app<span class="token punctuation">:</span> FastAPI<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Startup</span>
    <span class="token keyword">async</span> <span class="token keyword">with</span> engine<span class="token punctuation">.</span>begin<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> conn<span class="token punctuation">:</span>
        <span class="token comment"># Run migrations, warm caches, etc.</span>
        <span class="token keyword">pass</span>
    <span class="token keyword">yield</span>
    <span class="token comment"># Shutdown</span>
    <span class="token keyword">await</span> engine<span class="token punctuation">.</span>dispose<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">create_app</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> FastAPI<span class="token punctuation">:</span>
    app <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span>
        title<span class="token operator">=</span>settings<span class="token punctuation">.</span>PROJECT_NAME<span class="token punctuation">,</span>
        version<span class="token operator">=</span><span class="token string">"1.0.0"</span><span class="token punctuation">,</span>
        lifespan<span class="token operator">=</span>lifespan<span class="token punctuation">,</span>
        docs_url<span class="token operator">=</span><span class="token string">"/api/docs"</span> <span class="token keyword">if</span> settings<span class="token punctuation">.</span>ENVIRONMENT <span class="token operator">!=</span> <span class="token string">"production"</span> <span class="token keyword">else</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    
    setup_middleware<span class="token punctuation">(</span>app<span class="token punctuation">)</span>
    app<span class="token punctuation">.</span>include_router<span class="token punctuation">(</span>v1_router<span class="token punctuation">,</span> prefix<span class="token operator">=</span><span class="token string">"/api/v1"</span><span class="token punctuation">)</span>
    app<span class="token punctuation">.</span>include_router<span class="token punctuation">(</span>v2_router<span class="token punctuation">,</span> prefix<span class="token operator">=</span><span class="token string">"/api/v2"</span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> app

app <span class="token operator">=</span> create_app<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>This factory pattern makes testing trivial (we’ll cover that in section 12).</p>
<h2 id="3-dependency-injection-done-right-and-the-5-ways-people-screw-it-up">3. Dependency Injection Done Right (and the 5 ways people screw it up)</h2>
<p>FastAPI’s <code>Depends()</code> is brilliant until you footgun yourself. Here are the patterns that work.</p>
<h3 id="pattern-1-database-sessions-scoped">Pattern 1: Database Sessions (Scoped)</h3>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token comment"># db/session.py</span>
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>ext<span class="token punctuation">.</span>asyncio <span class="token keyword">import</span> AsyncSession<span class="token punctuation">,</span> create_async_engine<span class="token punctuation">,</span> async_sessionmaker

engine <span class="token operator">=</span> create_async_engine<span class="token punctuation">(</span>settings<span class="token punctuation">.</span>DATABASE_URL<span class="token punctuation">,</span> pool_pre_ping<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
AsyncSessionLocal <span class="token operator">=</span> async_sessionmaker<span class="token punctuation">(</span>engine<span class="token punctuation">,</span> expire_on_commit<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_db</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> AsyncSession<span class="token punctuation">:</span>
    <span class="token keyword">async</span> <span class="token keyword">with</span> AsyncSessionLocal<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> session<span class="token punctuation">:</span>
        <span class="token keyword">yield</span> session
        <span class="token comment"># Session auto-closes, even on exceptions</span>
</code></pre>
<p><strong>Usage in routes:</strong></p>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token keyword">from</span> fastapi <span class="token keyword">import</span> Depends
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>ext<span class="token punctuation">.</span>asyncio <span class="token keyword">import</span> AsyncSession

<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/users/{user_id}"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_user</span><span class="token punctuation">(</span>
    user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
    db<span class="token punctuation">:</span> AsyncSession <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_db<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    result <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>select<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>User<span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token operator">==</span> user_id<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> result<span class="token punctuation">.</span>scalar_one_or_none<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="pattern-2-current-user-cached">Pattern 2: Current User (Cached)</h3>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token comment"># dependencies.py</span>
<span class="token keyword">from</span> fastapi <span class="token keyword">import</span> Depends<span class="token punctuation">,</span> HTTPException<span class="token punctuation">,</span> status
<span class="token keyword">from</span> fastapi<span class="token punctuation">.</span>security <span class="token keyword">import</span> HTTPBearer<span class="token punctuation">,</span> HTTPAuthorizationCredentials
<span class="token keyword">from</span> jose <span class="token keyword">import</span> jwt<span class="token punctuation">,</span> JWTError

security <span class="token operator">=</span> HTTPBearer<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_current_user</span><span class="token punctuation">(</span>
    credentials<span class="token punctuation">:</span> HTTPAuthorizationCredentials <span class="token operator">=</span> Depends<span class="token punctuation">(</span>security<span class="token punctuation">)</span><span class="token punctuation">,</span>
    db<span class="token punctuation">:</span> AsyncSession <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_db<span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> User<span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        payload <span class="token operator">=</span> jwt<span class="token punctuation">.</span>decode<span class="token punctuation">(</span>credentials<span class="token punctuation">.</span>credentials<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>SECRET_KEY<span class="token punctuation">,</span> algorithms<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"HS256"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        user_id<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> payload<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"sub"</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> JWTError<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>status_code<span class="token operator">=</span>status<span class="token punctuation">.</span>HTTP_401_UNAUTHORIZED<span class="token punctuation">)</span>
    
    result <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>select<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>User<span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token operator">==</span> user_id<span class="token punctuation">)</span><span class="token punctuation">)</span>
    user <span class="token operator">=</span> result<span class="token punctuation">.</span>scalar_one_or_none<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> user<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>status_code<span class="token operator">=</span>status<span class="token punctuation">.</span>HTTP_401_UNAUTHORIZED<span class="token punctuation">)</span>
    <span class="token keyword">return</span> user
</code></pre>
<p><strong>⚠️ Disaster waiting to happen:</strong></p>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token comment"># DON'T: This queries the DB on every request, even when used multiple times</span>
<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/transfer"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">transfer_money</span><span class="token punctuation">(</span>
    sender<span class="token punctuation">:</span> User <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_current_user<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># DB query 1</span>
    amount<span class="token punctuation">:</span> <span class="token builtin">float</span><span class="token punctuation">,</span>
    recipient_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
    db<span class="token punctuation">:</span> AsyncSession <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_db<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Somewhere deep in the logic...</span>
    <span class="token keyword">if</span> <span class="token keyword">await</span> needs_approval<span class="token punctuation">(</span>sender<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># If this calls get_current_user again...</span>
        <span class="token comment"># DB query 2 for the same user</span>
        <span class="token keyword">pass</span>
</code></pre>
<p><strong>Fix with dependency cache:</strong></p>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token keyword">from</span> typing <span class="token keyword">import</span> Annotated

CurrentUser <span class="token operator">=</span> Annotated<span class="token punctuation">[</span>User<span class="token punctuation">,</span> Depends<span class="token punctuation">(</span>get_current_user<span class="token punctuation">)</span><span class="token punctuation">]</span>

<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/transfer"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">transfer_money</span><span class="token punctuation">(</span>
    sender<span class="token punctuation">:</span> CurrentUser<span class="token punctuation">,</span>  <span class="token comment"># Cached per request</span>
    amount<span class="token punctuation">:</span> <span class="token builtin">float</span><span class="token punctuation">,</span>
    recipient_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># sender is the same instance everywhere in this request</span>
    <span class="token keyword">pass</span>
</code></pre>
<h3 id="pattern-3-configuration-singletons-global">Pattern 3: Configuration Singletons (Global)</h3>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token comment"># config.py</span>
<span class="token keyword">from</span> pydantic_settings <span class="token keyword">import</span> BaseSettings
<span class="token keyword">from</span> functools <span class="token keyword">import</span> lru_cache

<span class="token keyword">class</span> <span class="token class-name">Settings</span><span class="token punctuation">(</span>BaseSettings<span class="token punctuation">)</span><span class="token punctuation">:</span>
    PROJECT_NAME<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">"MyApp"</span>
    DATABASE_URL<span class="token punctuation">:</span> <span class="token builtin">str</span>
    REDIS_URL<span class="token punctuation">:</span> <span class="token builtin">str</span>
    SECRET_KEY<span class="token punctuation">:</span> <span class="token builtin">str</span>
    ENVIRONMENT<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">"development"</span>
    
    <span class="token keyword">class</span> <span class="token class-name">Config</span><span class="token punctuation">:</span>
        env_file <span class="token operator">=</span> <span class="token string">".env"</span>

<span class="token decorator annotation punctuation">@lru_cache</span>
<span class="token keyword">def</span> <span class="token function">get_settings</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Settings<span class="token punctuation">:</span>
    <span class="token keyword">return</span> Settings<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># In routes</span>
<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/health"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">health</span><span class="token punctuation">(</span>settings<span class="token punctuation">:</span> Settings <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_settings<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">"environment"</span><span class="token punctuation">:</span> settings<span class="token punctuation">.</span>ENVIRONMENT<span class="token punctuation">}</span>
</code></pre>
<p>The <code>@lru_cache</code> ensures Settings is only instantiated once.</p>
<h3 id="pattern-4-external-service-clients-singleton-with-dependency">Pattern 4: External Service Clients (Singleton with Dependency)</h3>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token comment"># integrations/stripe.py</span>
<span class="token keyword">import</span> stripe
<span class="token keyword">from</span> functools <span class="token keyword">import</span> lru_cache

<span class="token decorator annotation punctuation">@lru_cache</span>
<span class="token keyword">def</span> <span class="token function">get_stripe_client</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> stripe<span class="token punctuation">.</span>StripeClient<span class="token punctuation">:</span>
    stripe<span class="token punctuation">.</span>api_key <span class="token operator">=</span> settings<span class="token punctuation">.</span>STRIPE_KEY
    <span class="token keyword">return</span> stripe  <span class="token comment"># Singleton instance</span>

<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/charge"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">create_charge</span><span class="token punctuation">(</span>
    amount<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
    stripe_client <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_stripe_client<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> stripe_client<span class="token punctuation">.</span>Charge<span class="token punctuation">.</span>create<span class="token punctuation">(</span>amount<span class="token operator">=</span>amount<span class="token punctuation">,</span> currency<span class="token operator">=</span><span class="token string">"usd"</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="pattern-5-complex-dependency-chains">Pattern 5: Complex Dependency Chains</h3>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token comment"># This is where people screw up</span>

<span class="token comment"># BAD: Tightly coupled</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_current_admin_user</span><span class="token punctuation">(</span>
    user<span class="token punctuation">:</span> User <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_current_user<span class="token punctuation">)</span><span class="token punctuation">,</span>
    db<span class="token punctuation">:</span> AsyncSession <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_db<span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> User<span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> user<span class="token punctuation">.</span>is_admin<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>status_code<span class="token operator">=</span><span class="token number">403</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> user

<span class="token comment"># BETTER: Composable</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">require_admin</span><span class="token punctuation">(</span>user<span class="token punctuation">:</span> User <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_current_user<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> User<span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> user<span class="token punctuation">.</span>is_admin<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>status_code<span class="token operator">=</span><span class="token number">403</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> user

CurrentAdmin <span class="token operator">=</span> Annotated<span class="token punctuation">[</span>User<span class="token punctuation">,</span> Depends<span class="token punctuation">(</span>require_admin<span class="token punctuation">)</span><span class="token punctuation">]</span>

<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>delete</span><span class="token punctuation">(</span><span class="token string">"/users/{user_id}"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">delete_user</span><span class="token punctuation">(</span>
    user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
    admin<span class="token punctuation">:</span> CurrentAdmin<span class="token punctuation">,</span>
    db<span class="token punctuation">:</span> AsyncSession <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_db<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># admin is guaranteed to be an admin</span>
    <span class="token keyword">pass</span>
</code></pre>
<h3 id="the-5-ways-people-screw-up-dependencies">The 5 Ways People Screw Up Dependencies</h3>
<p><strong>1. Not using <code>yield</code> for cleanup:</strong></p>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token comment"># BAD: Connection leak</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_db</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    session <span class="token operator">=</span> AsyncSessionLocal<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> session  <span class="token comment"># Never closes!</span>

<span class="token comment"># GOOD:</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_db</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">async</span> <span class="token keyword">with</span> AsyncSessionLocal<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> session<span class="token punctuation">:</span>
        <span class="token keyword">yield</span> session  <span class="token comment"># Auto-cleanup</span>
</code></pre>
<p><strong>2. Using sync dependencies with async routes:</strong></p>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token comment"># BAD: Blocks the event loop</span>
<span class="token keyword">def</span> <span class="token function">get_db_sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># sync function</span>
    session <span class="token operator">=</span> SessionLocal<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">yield</span> session
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        session<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/users"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_users</span><span class="token punctuation">(</span>db <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_db_sync<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># Disaster</span>
    <span class="token comment"># This blocks Uvicorn's event loop</span>
    <span class="token keyword">pass</span>
</code></pre>
<p><strong>3. Not caching expensive dependencies:</strong></p>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token comment"># BAD: Parses JWT twice</span>
<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/action"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">action</span><span class="token punctuation">(</span>
    user<span class="token punctuation">:</span> User <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_current_user<span class="token punctuation">)</span><span class="token punctuation">,</span>
    audit_user<span class="token punctuation">:</span> User <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_current_user<span class="token punctuation">)</span>  <span class="token comment"># Redundant</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span>

<span class="token comment"># GOOD: Use Annotated</span>
CurrentUser <span class="token operator">=</span> Annotated<span class="token punctuation">[</span>User<span class="token punctuation">,</span> Depends<span class="token punctuation">(</span>get_current_user<span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre>
<p><strong>4. Testing nightmares with Depends:</strong></p>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token comment"># Testing anti-pattern</span>
<span class="token keyword">def</span> <span class="token function">test_endpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Can't easily mock get_current_user</span>
    response <span class="token operator">=</span> client<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"/protected"</span><span class="token punctuation">)</span>
    
<span class="token comment"># Better: Use app.dependency_overrides</span>
<span class="token keyword">def</span> <span class="token function">test_endpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">override_get_current_user</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> User<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> email<span class="token operator">=</span><span class="token string">"test@example.com"</span><span class="token punctuation">)</span>
    
    app<span class="token punctuation">.</span>dependency_overrides<span class="token punctuation">[</span>get_current_user<span class="token punctuation">]</span> <span class="token operator">=</span> override_get_current_user
    response <span class="token operator">=</span> client<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"/protected"</span><span class="token punctuation">)</span>
    app<span class="token punctuation">.</span>dependency_overrides<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p><strong>5. Forgetting dependencies aren’t magic:</strong></p>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token comment"># BAD: This doesn't work</span>
<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/users"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_users</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    db <span class="token operator">=</span> get_db<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># Just calling the function directly</span>
    <span class="token comment"># db is a generator, not a session!</span>

<span class="token comment"># Dependencies only work when passed to Depends()</span>
</code></pre>
<h2 id="4-pydantic-v2">4. Pydantic v2</h2>
<p>Pydantic v2 is 5-50x faster than v1 (thanks to Rust core), but the API changed. Here’s what matters in production.</p>
<h3 id="custom-validators-that-actually-work">Custom Validators That Actually Work</h3>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token keyword">from</span> pydantic <span class="token keyword">import</span> BaseModel<span class="token punctuation">,</span> field_validator<span class="token punctuation">,</span> model_validator
<span class="token keyword">from</span> typing <span class="token keyword">import</span> Self

<span class="token keyword">class</span> <span class="token class-name">UserCreate</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    email<span class="token punctuation">:</span> <span class="token builtin">str</span>
    password<span class="token punctuation">:</span> <span class="token builtin">str</span>
    age<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token operator">=</span> <span class="token boolean">None</span>
    
    <span class="token decorator annotation punctuation">@field_validator</span><span class="token punctuation">(</span><span class="token string">'email'</span><span class="token punctuation">)</span>
    <span class="token decorator annotation punctuation">@classmethod</span>
    <span class="token keyword">def</span> <span class="token function">email_must_be_lowercase</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> v<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">str</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> v <span class="token operator">!=</span> v<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">'Email must be lowercase'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> v
    
    <span class="token decorator annotation punctuation">@field_validator</span><span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">)</span>
    <span class="token decorator annotation punctuation">@classmethod</span>
    <span class="token keyword">def</span> <span class="token function">password_strength</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> v<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">str</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token operator">&#x3C;</span> <span class="token number">8</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">'Password must be at least 8 characters'</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">any</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>isupper<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> c <span class="token keyword">in</span> v<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">'Password must contain uppercase letter'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> v
    
    <span class="token decorator annotation punctuation">@model_validator</span><span class="token punctuation">(</span>mode<span class="token operator">=</span><span class="token string">'after'</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">check_age_for_email</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Self<span class="token punctuation">:</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>age <span class="token keyword">and</span> self<span class="token punctuation">.</span>age <span class="token operator">&#x3C;</span> <span class="token number">13</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">'Users under 13 cannot have email'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> self
</code></pre>
<p><strong>⚠️ v1 to v2 migration gotcha:</strong></p>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token comment"># Pydantic v1 (deprecated)</span>
<span class="token decorator annotation punctuation">@validator</span><span class="token punctuation">(</span><span class="token string">'email'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">lowercase_email</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> v<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># Pydantic v2</span>
<span class="token decorator annotation punctuation">@field_validator</span><span class="token punctuation">(</span><span class="token string">'email'</span><span class="token punctuation">)</span>
<span class="token decorator annotation punctuation">@classmethod</span>
<span class="token keyword">def</span> <span class="token function">lowercase_email</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> v<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">str</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> v<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="computed-fields-new-in-v2">Computed Fields (New in v2)</h3>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token keyword">from</span> pydantic <span class="token keyword">import</span> computed_field

<span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    first_name<span class="token punctuation">:</span> <span class="token builtin">str</span>
    last_name<span class="token punctuation">:</span> <span class="token builtin">str</span>
    email<span class="token punctuation">:</span> <span class="token builtin">str</span>
    created_at<span class="token punctuation">:</span> datetime
    
    <span class="token decorator annotation punctuation">@computed_field</span>
    <span class="token decorator annotation punctuation">@property</span>
    <span class="token keyword">def</span> <span class="token function">full_name</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">str</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>first_name<span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>last_name<span class="token punctuation">}</span></span><span class="token string">"</span></span>
    
    <span class="token decorator annotation punctuation">@computed_field</span>
    <span class="token decorator annotation punctuation">@property</span>
    <span class="token keyword">def</span> <span class="token function">account_age_days</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">int</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>datetime<span class="token punctuation">.</span>utcnow<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> self<span class="token punctuation">.</span>created_at<span class="token punctuation">)</span><span class="token punctuation">.</span>days

<span class="token comment"># Usage</span>
user <span class="token operator">=</span> User<span class="token punctuation">(</span>first_name<span class="token operator">=</span><span class="token string">"Jane"</span><span class="token punctuation">,</span> last_name<span class="token operator">=</span><span class="token string">"Doe"</span><span class="token punctuation">,</span> email<span class="token operator">=</span><span class="token string">"jane@example.com"</span><span class="token punctuation">,</span> created_at<span class="token operator">=</span>datetime<span class="token punctuation">(</span><span class="token number">2024</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>full_name<span class="token punctuation">)</span>  <span class="token comment"># "Jane Doe"</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>model_dump<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># Includes computed fields in serialization</span>
</code></pre>
<h3 id="model_config-replaces-config-class">model_config (Replaces Config class)</h3>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token keyword">from</span> pydantic <span class="token keyword">import</span> BaseModel<span class="token punctuation">,</span> ConfigDict

<span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    model_config <span class="token operator">=</span> ConfigDict<span class="token punctuation">(</span>
        str_strip_whitespace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>      <span class="token comment"># Auto-strip strings</span>
        str_to_lower<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
        validate_assignment<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>        <span class="token comment"># Validate on attribute assignment</span>
        arbitrary_types_allowed<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
        from_attributes<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>            <span class="token comment"># Enable ORM mode (was orm_mode in v1)</span>
        populate_by_name<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>           <span class="token comment"># Allow both alias and field name</span>
        extra<span class="token operator">=</span><span class="token string">'forbid'</span>                   <span class="token comment"># Reject unknown fields</span>
    <span class="token punctuation">)</span>
    
    email<span class="token punctuation">:</span> <span class="token builtin">str</span>
    age<span class="token punctuation">:</span> <span class="token builtin">int</span>

<span class="token comment"># Now validates on assignment</span>
user <span class="token operator">=</span> User<span class="token punctuation">(</span>email<span class="token operator">=</span><span class="token string">"test@example.com"</span><span class="token punctuation">,</span> age<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">)</span>
user<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token string">"invalid"</span>  <span class="token comment"># Raises ValidationError</span>
</code></pre>
<h3 id="performance-basemodel-vs-dataclasses-vs-typeddict">Performance: BaseModel vs dataclasses vs TypedDict</h3>
<p>Benchmarks on AWS c6i.xlarge (4 vCPU, 8GB RAM, 10,000 iterations) shows:</p>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token keyword">from</span> pydantic <span class="token keyword">import</span> BaseModel
<span class="token keyword">from</span> dataclasses <span class="token keyword">import</span> dataclass
<span class="token keyword">from</span> typing <span class="token keyword">import</span> TypedDict

<span class="token comment"># Benchmark setup</span>
<span class="token keyword">class</span> <span class="token class-name">UserPydantic</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token builtin">id</span><span class="token punctuation">:</span> <span class="token builtin">int</span>
    name<span class="token punctuation">:</span> <span class="token builtin">str</span>
    email<span class="token punctuation">:</span> <span class="token builtin">str</span>
    age<span class="token punctuation">:</span> <span class="token builtin">int</span>

<span class="token decorator annotation punctuation">@dataclass</span>
<span class="token keyword">class</span> <span class="token class-name">UserDataclass</span><span class="token punctuation">:</span>
    <span class="token builtin">id</span><span class="token punctuation">:</span> <span class="token builtin">int</span>
    name<span class="token punctuation">:</span> <span class="token builtin">str</span>
    email<span class="token punctuation">:</span> <span class="token builtin">str</span>
    age<span class="token punctuation">:</span> <span class="token builtin">int</span>

<span class="token keyword">class</span> <span class="token class-name">UserTypedDict</span><span class="token punctuation">(</span>TypedDict<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token builtin">id</span><span class="token punctuation">:</span> <span class="token builtin">int</span>
    name<span class="token punctuation">:</span> <span class="token builtin">str</span>
    email<span class="token punctuation">:</span> <span class="token builtin">str</span>
    age<span class="token punctuation">:</span> <span class="token builtin">int</span>

<span class="token comment"># Results (10k iterations):</span>
<span class="token comment"># Pydantic v2:    ~180ms (with validation)</span>
<span class="token comment"># dataclasses:    ~12ms  (no validation)</span>
<span class="token comment"># TypedDict:      ~8ms   (no validation, just type hints)</span>
</code></pre>
<p><strong>When to use what:</strong></p>
<ul>
<li><strong>Pydantic BaseModel:</strong> External API boundaries (request/response), config parsing</li>
<li><strong>dataclasses:</strong> Internal data transfer where you trust the data</li>
<li><strong>TypedDict:</strong> Return types from database queries (with SQLAlchemy <code>Row</code>)</li>
</ul>
<p><strong>Real production pattern:</strong></p>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token comment"># schemas/user.py - API boundary</span>
<span class="token keyword">class</span> <span class="token class-name">UserResponse</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token builtin">id</span><span class="token punctuation">:</span> <span class="token builtin">int</span>
    email<span class="token punctuation">:</span> <span class="token builtin">str</span>
    full_name<span class="token punctuation">:</span> <span class="token builtin">str</span>

<span class="token comment"># services/user_service.py - Internal</span>
<span class="token decorator annotation punctuation">@dataclass</span>
<span class="token keyword">class</span> <span class="token class-name">UserDTO</span><span class="token punctuation">:</span>
    <span class="token builtin">id</span><span class="token punctuation">:</span> <span class="token builtin">int</span>
    email<span class="token punctuation">:</span> <span class="token builtin">str</span>
    first_name<span class="token punctuation">:</span> <span class="token builtin">str</span>
    last_name<span class="token punctuation">:</span> <span class="token builtin">str</span>
    
    <span class="token decorator annotation punctuation">@property</span>
    <span class="token keyword">def</span> <span class="token function">full_name</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">str</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>first_name<span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>last_name<span class="token punctuation">}</span></span><span class="token string">"</span></span>

<span class="token comment"># In routes</span>
<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/users/{user_id}"</span><span class="token punctuation">,</span> response_model<span class="token operator">=</span>UserResponse<span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_user</span><span class="token punctuation">(</span>user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> db<span class="token punctuation">:</span> AsyncSession <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_db<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    dto <span class="token operator">=</span> <span class="token keyword">await</span> user_service<span class="token punctuation">.</span>get_user<span class="token punctuation">(</span>db<span class="token punctuation">,</span> user_id<span class="token punctuation">)</span>  <span class="token comment"># Returns UserDTO</span>
    <span class="token keyword">return</span> UserResponse<span class="token punctuation">(</span>
        <span class="token builtin">id</span><span class="token operator">=</span>dto<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        email<span class="token operator">=</span>dto<span class="token punctuation">.</span>email<span class="token punctuation">,</span>
        full_name<span class="token operator">=</span>dto<span class="token punctuation">.</span>full_name
    <span class="token punctuation">)</span>
</code></pre>
<h2 id="5-async-vs-sync---the-rules-nobody-follows">5. Async vs Sync - The Rules Nobody Follows</h2>
<p>This is where 90% of FastAPI performance issues come from. Let’s be brutally clear.</p>
<h3 id="when-to-actually-use-async-def">When to Actually Use async def</h3>
<p>Use <code>async def</code> when your route:</p>
<ul>
<li>Makes HTTP calls to other services (<code>httpx</code>, <code>aiohttp</code>)</li>
<li>Queries a database with async driver (<code>asyncpg</code>, <code>aiomysql</code>, <code>motor</code>)</li>
<li>Uses async-native libraries (<code>aioredis</code>, <code>aioboto3</code>)</li>
<li>Handles WebSockets or Server-Sent Events</li>
</ul>
<p><strong>Do NOT use async def when:</strong></p>
<ul>
<li>You’re doing CPU-bound work (image processing, crypto, ML inference)</li>
<li>You’re using sync libraries (requests, psycopg2, pymongo)</li>
<li>You’re just returning JSON (no I/O)</li>
</ul>
<h3 id="the-blocking-io-death-spiral">The Blocking I/O Death Spiral</h3>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token comment"># DISASTER: This will murder your throughput</span>
<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/users/{user_id}"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_user</span><span class="token punctuation">(</span>user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># requests.get is synchronous and blocks the event loop</span>
    response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"https://api.example.com/users/</span><span class="token interpolation"><span class="token punctuation">{</span>user_id<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p><strong>What happens:</strong> Uvicorn’s event loop blocks waiting for the HTTP response. While blocked, it can’t handle ANY other requests. Your 18,000 RPS drops to ~50.</p>
<p><strong>Flame graph reality:</strong></p>
<pre class="language-plaintext" data-language="plaintext"><code is:raw="" class="language-plaintext">[event_loop] 99.8% blocked
  └─ [requests.get] 99.8%
      └─ [socket.recv] 99.7%
</code></pre>
<p><strong>The Fix:</strong></p>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token keyword">import</span> httpx

<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/users/{user_id}"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_user</span><span class="token punctuation">(</span>user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> http_client<span class="token punctuation">:</span> httpx<span class="token punctuation">.</span>AsyncClient <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_http_client<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    response <span class="token operator">=</span> <span class="token keyword">await</span> http_client<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"https://api.example.com/users/</span><span class="token interpolation"><span class="token punctuation">{</span>user_id<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="sync-database-queries-in-async-routes">Sync Database Queries in Async Routes</h3>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token comment"># ALSO A DISASTER</span>
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> Session

<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/users"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_users</span><span class="token punctuation">(</span>db<span class="token punctuation">:</span> Session <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_db_sync<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    users <span class="token operator">=</span> db<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># Blocks event loop</span>
    <span class="token keyword">return</span> users
</code></pre>
<p>On AWS c6i.2xlarge with PostgreSQL on RDS:</p>
<ul>
<li><strong>Sync SQLAlchemy in sync route:</strong> 2,500 RPS</li>
<li><strong>Sync SQLAlchemy in async route:</strong> 800 RPS (event loop blocked)</li>
<li><strong>Async SQLAlchemy in async route:</strong> 8,000 RPS</li>
</ul>
<p><strong>Fix:</strong></p>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>ext<span class="token punctuation">.</span>asyncio <span class="token keyword">import</span> AsyncSession
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> select

<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/users"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_users</span><span class="token punctuation">(</span>db<span class="token punctuation">:</span> AsyncSession <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_db<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    result <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>select<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> result<span class="token punctuation">.</span>scalars<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="working-sync-to-async-wrappers">Working Sync-to-Async Wrappers</h3>
<p>Sometimes you can’t avoid sync code (legacy libraries, CPU-bound tasks). Here’s how to not destroy performance:</p>
<p><strong>Option 1: run_in_threadpool (built into Starlette)</strong></p>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token keyword">from</span> starlette<span class="token punctuation">.</span>concurrency <span class="token keyword">import</span> run_in_threadpool
<span class="token keyword">import</span> time

<span class="token keyword">def</span> <span class="token function">expensive_cpu_task</span><span class="token punctuation">(</span>data<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">str</span><span class="token punctuation">:</span>
    <span class="token comment"># Simulate CPU work</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> data<span class="token punctuation">.</span>upper<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/process"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">process_data</span><span class="token punctuation">(</span>data<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Runs in thread pool, doesn't block event loop</span>
    result <span class="token operator">=</span> <span class="token keyword">await</span> run_in_threadpool<span class="token punctuation">(</span>expensive_cpu_task<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">"result"</span><span class="token punctuation">:</span> result<span class="token punctuation">}</span>
</code></pre>
<p><strong>Option 2: asyncio.to_thread (Python 3.12+)</strong></p>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token keyword">import</span> asyncio

<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/process"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">process_data</span><span class="token punctuation">(</span>data<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    result <span class="token operator">=</span> <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>to_thread<span class="token punctuation">(</span>expensive_cpu_task<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">"result"</span><span class="token punctuation">:</span> result<span class="token punctuation">}</span>
</code></pre>
<p><strong>⚠️ Don’t abuse this:</strong></p>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token comment"># BAD: Just use a sync route instead</span>
<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/simple"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">simple</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    result <span class="token operator">=</span> <span class="token keyword">await</span> run_in_threadpool<span class="token punctuation">(</span><span class="token keyword">lambda</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"hello"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> result

<span class="token comment"># GOOD: No I/O, just use sync</span>
<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/simple"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">simple</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"hello"</span><span class="token punctuation">}</span>
</code></pre>
<h3 id="the-i-dont-know-rule">The “I Don’t Know” Rule</h3>
<p><strong>If you don’t know whether your route does I/O, use <code>def</code> (sync), not <code>async def</code>.</strong></p>
<p>FastAPI automatically runs sync routes in a thread pool, so you won’t block the event loop by accident. You’ll just use a bit more memory (threads instead of tasks).</p>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token comment"># Safe default for uncertain routes</span>
<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/maybe-io"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">maybe_io</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Could call a library that does I/O</span>
    <span class="token comment"># FastAPI runs this in a thread pool</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"ok"</span><span class="token punctuation">}</span>
</code></pre>
<h2 id="6-uvicorn-vs-hypercorn-vs-daphne---what-we-actually-run-in-2025">6. Uvicorn vs Hypercorn vs Daphne - What We Actually Run in 2025</h2>
<h3 id="uvicorn-our-default-choice">Uvicorn (Our Default Choice)</h3>
<p><strong>Why we use it:</strong></p>
<ul>
<li>Pure Python, easy to debug</li>
<li>Best ecosystem support (works with all ASGI middleware)</li>
<li>Excellent performance for HTTP/1.1</li>
<li>Mature libuv-based event loop</li>
</ul>
<p><strong>Worker types:</strong></p>
<pre class="language-bash" data-language="bash"><code is:raw="" class="language-bash"><span class="token comment"># Single process (development)</span>
uvicorn myapp.main:app <span class="token parameter variable">--reload</span>

<span class="token comment"># Multiple workers (production)</span>
uvicorn myapp.main:app <span class="token parameter variable">--workers</span> <span class="token number">4</span> <span class="token parameter variable">--host</span> <span class="token number">0.0</span>.0.0 <span class="token parameter variable">--port</span> <span class="token number">8000</span>

<span class="token comment"># With Gunicorn (our production setup)</span>
gunicorn myapp.main:app <span class="token punctuation">\</span>
  <span class="token parameter variable">--workers</span> <span class="token number">4</span> <span class="token punctuation">\</span>
  --worker-class uvicorn.workers.UvicornWorker <span class="token punctuation">\</span>
  <span class="token parameter variable">--bind</span> <span class="token number">0.0</span>.0.0:8000 <span class="token punctuation">\</span>
  <span class="token parameter variable">--timeout</span> <span class="token number">60</span> <span class="token punctuation">\</span>
  --graceful-timeout <span class="token number">30</span> <span class="token punctuation">\</span>
  --access-logfile - <span class="token punctuation">\</span>
  --error-logfile -
</code></pre>
<p><strong>Real 2025 AWS Numbers (c6i.2xlarge, 8 vCPU, 16GB RAM):</strong></p>








































<table><thead><tr><th>Workers</th><th>RPS</th><th>p50</th><th>p99</th><th>Memory</th></tr></thead><tbody><tr><td>1</td><td>4,200</td><td>2ms</td><td>12ms</td><td>180MB</td></tr><tr><td>4</td><td>15,800</td><td>2ms</td><td>15ms</td><td>720MB</td></tr><tr><td>8</td><td>18,200</td><td>3ms</td><td>22ms</td><td>1.4GB</td></tr><tr><td>16</td><td>17,100</td><td>5ms</td><td>45ms</td><td>2.8GB</td></tr></tbody></table>
<p><strong>Sweet spot:</strong> Workers = CPU cores. Beyond that, context switching kills you.</p>
<h3 id="hypercorn-http2-and-http3">Hypercorn (HTTP/2 and HTTP/3)</h3>
<p>Use when you need:</p>
<ul>
<li>HTTP/2 server push</li>
<li>HTTP/3 (QUIC)</li>
<li>WebSocket over HTTP/2</li>
</ul>
<pre class="language-bash" data-language="bash"><code is:raw="" class="language-bash"><span class="token comment"># Trio backend (structured concurrency)</span>
hypercorn myapp.main:app <span class="token parameter variable">--workers</span> <span class="token number">4</span> <span class="token parameter variable">--bind</span> <span class="token number">0.0</span>.0.0:8000 --worker-class trio

<span class="token comment"># asyncio backend (compatible with Uvicorn ecosystem)</span>
hypercorn myapp.main:app <span class="token parameter variable">--workers</span> <span class="token number">4</span> <span class="token parameter variable">--bind</span> <span class="token number">0.0</span>.0.0:8000 --worker-class asyncio
</code></pre>
<p><strong>Benchmark vs Uvicorn (same c6i.2xlarge, 4 workers, HTTP/1.1):</strong></p>
<ul>
<li>Uvicorn: 15,800 RPS</li>
<li>Hypercorn (asyncio): 14,200 RPS</li>
<li>Hypercorn (trio): 12,500 RPS</li>
</ul>
<p>HTTP/2 doesn’t help for typical JSON APIs. We only use Hypercorn for gRPC-web gateways.</p>
<h3 id="daphne-django-channels-legacy">Daphne (Django Channels Legacy)</h3>
<p>Don’t use it for new projects. It’s slower and less maintained than Uvicorn/Hypercorn.</p>
<h3 id="graceful-reload-without-leaking-connections">Graceful Reload Without Leaking Connections</h3>
<p><strong>The Problem:</strong></p>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token comment"># BAD: Connections leak on worker restart</span>
engine <span class="token operator">=</span> create_async_engine<span class="token punctuation">(</span>settings<span class="token punctuation">.</span>DATABASE_URL<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>on_event</span><span class="token punctuation">(</span><span class="token string">"startup"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">startup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Engine created, pool opens</span>
    <span class="token keyword">pass</span>

<span class="token comment"># When Gunicorn sends SIGTERM to reload:</span>
<span class="token comment"># - Worker starts shutdown</span>
<span class="token comment"># - New connections rejected</span>
<span class="token comment"># - But existing pool connections stay open!</span>
</code></pre>
<p><strong>The Fix:</strong></p>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token keyword">from</span> contextlib <span class="token keyword">import</span> asynccontextmanager

<span class="token decorator annotation punctuation">@asynccontextmanager</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">lifespan</span><span class="token punctuation">(</span>app<span class="token punctuation">:</span> FastAPI<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Startup</span>
    engine <span class="token operator">=</span> create_async_engine<span class="token punctuation">(</span>settings<span class="token punctuation">.</span>DATABASE_URL<span class="token punctuation">)</span>
    app<span class="token punctuation">.</span>state<span class="token punctuation">.</span>engine <span class="token operator">=</span> engine
    <span class="token keyword">yield</span>
    <span class="token comment"># Shutdown - this ACTUALLY runs on SIGTERM</span>
    <span class="token keyword">await</span> engine<span class="token punctuation">.</span>dispose<span class="token punctuation">(</span><span class="token punctuation">)</span>

app <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span>lifespan<span class="token operator">=</span>lifespan<span class="token punctuation">)</span>
</code></pre>
<p><strong>Gunicorn config for zero-downtime reloads:</strong></p>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token comment"># gunicorn.conf.py</span>
<span class="token keyword">import</span> multiprocessing

workers <span class="token operator">=</span> multiprocessing<span class="token punctuation">.</span>cpu_count<span class="token punctuation">(</span><span class="token punctuation">)</span>
worker_class <span class="token operator">=</span> <span class="token string">"uvicorn.workers.UvicornWorker"</span>
timeout <span class="token operator">=</span> <span class="token number">60</span>
graceful_timeout <span class="token operator">=</span> <span class="token number">30</span>
keepalive <span class="token operator">=</span> <span class="token number">5</span>

<span class="token comment"># Critical for graceful shutdown</span>
max_requests <span class="token operator">=</span> <span class="token number">10000</span>      <span class="token comment"># Restart worker after N requests (prevents memory leaks)</span>
max_requests_jitter <span class="token operator">=</span> <span class="token number">1000</span>
preload_app <span class="token operator">=</span> <span class="token boolean">False</span>       <span class="token comment"># Don't preload (allows per-worker cleanup)</span>
</code></pre>
<p><strong>Graceful shutdown flow:</strong></p>
<ol>
<li>Gunicorn sends SIGTERM to worker</li>
<li>Worker stops accepting new connections</li>
<li>Worker finishes in-flight requests (up to <code>graceful_timeout</code> seconds)</li>
<li>Worker runs lifespan shutdown (closes DB pool, Redis, etc.)</li>
<li>Worker exits</li>
<li>Gunicorn spawns replacement worker</li>
</ol>
<p><strong>Test this works:</strong></p>
<pre class="language-bash" data-language="bash"><code is:raw="" class="language-bash"><span class="token comment"># Terminal 1: Start server</span>
gunicorn myapp.main:app <span class="token parameter variable">--config</span> gunicorn.conf.py

<span class="token comment"># Terminal 2: Send reload signal</span>
<span class="token function">kill</span> <span class="token parameter variable">-HUP</span> <span class="token variable"><span class="token variable">$(</span>pgrep <span class="token parameter variable">-f</span> gunicorn<span class="token variable">)</span></span>

<span class="token comment"># Watch logs - you should see:</span>
<span class="token comment"># [INFO] Handling signal: hup</span>
<span class="token comment"># [INFO] Shutting down: Master</span>
<span class="token comment"># [INFO] Worker exiting (pid: 12345)</span>
<span class="token comment"># [INFO] Booting worker with pid: 12346</span>
</code></pre>
<p>If you see database connection errors after reload, your lifespan cleanup isn’t working.</p>
<h2 id="7-connection-pooling-and-database-access-patterns">7. Connection Pooling and Database Access Patterns</h2>
<h3 id="sqlalchemy-20--asyncpg-our-production-setup">SQLAlchemy 2.0 + asyncpg (Our Production Setup)</h3>
<p><strong>Why asyncpg:</strong></p>
<ul>
<li>3-5x faster than psycopg2 (AWS RDS benchmarks)</li>
<li>Native async (no thread pool overhead)</li>
<li>Binary protocol (less parsing)</li>
</ul>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token comment"># db/session.py</span>
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>ext<span class="token punctuation">.</span>asyncio <span class="token keyword">import</span> create_async_engine<span class="token punctuation">,</span> async_sessionmaker<span class="token punctuation">,</span> AsyncSession
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>pool <span class="token keyword">import</span> NullPool

<span class="token comment"># For web servers (connection pool)</span>
engine <span class="token operator">=</span> create_async_engine<span class="token punctuation">(</span>
    settings<span class="token punctuation">.</span>DATABASE_URL<span class="token punctuation">,</span>  <span class="token comment"># postgresql+asyncpg://user:pass@host/db</span>
    echo<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
    pool_size<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span>           <span class="token comment"># Max connections per worker</span>
    max_overflow<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span>        <span class="token comment"># Extra connections during spike</span>
    pool_pre_ping<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>     <span class="token comment"># Check connection health before use</span>
    pool_recycle<span class="token operator">=</span><span class="token number">3600</span><span class="token punctuation">,</span>      <span class="token comment"># Recycle connections after 1 hour</span>
<span class="token punctuation">)</span>

<span class="token comment"># For background workers (no pool)</span>
engine_worker <span class="token operator">=</span> create_async_engine<span class="token punctuation">(</span>
    settings<span class="token punctuation">.</span>DATABASE_URL<span class="token punctuation">,</span>
    poolclass<span class="token operator">=</span>NullPool<span class="token punctuation">,</span>     <span class="token comment"># Workers handle their own pooling</span>
<span class="token punctuation">)</span>

AsyncSessionLocal <span class="token operator">=</span> async_sessionmaker<span class="token punctuation">(</span>
    engine<span class="token punctuation">,</span>
    class_<span class="token operator">=</span>AsyncSession<span class="token punctuation">,</span>
    expire_on_commit<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>  <span class="token comment"># Don't expire objects after commit</span>
<span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_db</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">async</span> <span class="token keyword">with</span> AsyncSessionLocal<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> session<span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">yield</span> session
        <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
            <span class="token keyword">await</span> session<span class="token punctuation">.</span>rollback<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">raise</span>
        <span class="token keyword">finally</span><span class="token punctuation">:</span>
            <span class="token keyword">await</span> session<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p><strong>Pool sizing math:</strong></p>
<pre class="language-plaintext" data-language="plaintext"><code is:raw="" class="language-plaintext">Total connections = (workers × pool_size) + (workers × max_overflow)
Example: 4 workers × (20 + 10) = 120 max connections

PostgreSQL max_connections default = 100
Set PostgreSQL max_connections = (your calculated total) + 20
</code></pre>
<p><strong>⚠️ Disaster: Too small pool</strong></p>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token comment"># BAD: pool_size=5 with 4 workers handling 100 RPS</span>
<span class="token comment"># = 20 connections max, but 100 concurrent requests</span>
<span class="token comment"># = Requests wait for free connection = timeout city</span>

<span class="token comment"># Symptoms:</span>
<span class="token comment"># - sqlalchemy.exc.TimeoutError: QueuePool limit exceeded</span>
<span class="token comment"># - p99 latency spikes to 10+ seconds</span>
</code></pre>
<p><strong>Fix:</strong></p>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token comment"># Rule of thumb for web servers:</span>
<span class="token comment"># pool_size = (expected concurrent requests per worker) / 2</span>
<span class="token comment"># For 4 workers, 25 requests/worker concurrently:</span>
<span class="token comment"># pool_size = 25 / 2 = 12</span>

engine <span class="token operator">=</span> create_async_engine<span class="token punctuation">(</span>
    settings<span class="token punctuation">.</span>DATABASE_URL<span class="token punctuation">,</span>
    pool_size<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">,</span>
    max_overflow<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
</code></pre>
<h3 id="sqlalchemy-20-patterns">SQLAlchemy 2.0 Patterns</h3>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> select<span class="token punctuation">,</span> update<span class="token punctuation">,</span> delete
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> selectinload

<span class="token comment"># SELECT with relationship loading</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_user_with_orders</span><span class="token punctuation">(</span>db<span class="token punctuation">:</span> AsyncSession<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    stmt <span class="token operator">=</span> <span class="token punctuation">(</span>
        select<span class="token punctuation">(</span>User<span class="token punctuation">)</span>
        <span class="token punctuation">.</span>where<span class="token punctuation">(</span>User<span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token operator">==</span> user_id<span class="token punctuation">)</span>
        <span class="token punctuation">.</span>options<span class="token punctuation">(</span>selectinload<span class="token punctuation">(</span>User<span class="token punctuation">.</span>orders<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># Eager load, prevents N+1</span>
    <span class="token punctuation">)</span>
    result <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>stmt<span class="token punctuation">)</span>
    <span class="token keyword">return</span> result<span class="token punctuation">.</span>scalar_one_or_none<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># INSERT</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">create_user</span><span class="token punctuation">(</span>db<span class="token punctuation">:</span> AsyncSession<span class="token punctuation">,</span> email<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    user <span class="token operator">=</span> User<span class="token punctuation">(</span>email<span class="token operator">=</span>email<span class="token punctuation">)</span>
    db<span class="token punctuation">.</span>add<span class="token punctuation">(</span>user<span class="token punctuation">)</span>
    <span class="token keyword">await</span> db<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> db<span class="token punctuation">.</span>refresh<span class="token punctuation">(</span>user<span class="token punctuation">)</span>  <span class="token comment"># Get DB-generated fields</span>
    <span class="token keyword">return</span> user

<span class="token comment"># UPDATE</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">update_user_email</span><span class="token punctuation">(</span>db<span class="token punctuation">:</span> AsyncSession<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> new_email<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    stmt <span class="token operator">=</span> <span class="token punctuation">(</span>
        update<span class="token punctuation">(</span>User<span class="token punctuation">)</span>
        <span class="token punctuation">.</span>where<span class="token punctuation">(</span>User<span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token operator">==</span> user_id<span class="token punctuation">)</span>
        <span class="token punctuation">.</span>values<span class="token punctuation">(</span>email<span class="token operator">=</span>new_email<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">await</span> db<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>stmt<span class="token punctuation">)</span>
    <span class="token keyword">await</span> db<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># DELETE</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">delete_user</span><span class="token punctuation">(</span>db<span class="token punctuation">:</span> AsyncSession<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    stmt <span class="token operator">=</span> delete<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>User<span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token operator">==</span> user_id<span class="token punctuation">)</span>
    <span class="token keyword">await</span> db<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>stmt<span class="token punctuation">)</span>
    <span class="token keyword">await</span> db<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="prisma-tortoise-sqlmodel---honest-trade-offs">Prisma, Tortoise, SQLModel - Honest Trade-offs</h3>
<p><strong>Prisma:</strong></p>
<ul>
<li>✅ Best type safety (generated from schema)</li>
<li>✅ Excellent migrations</li>
<li>❌ Slower than SQLAlchemy (extra layer)</li>
<li>❌ Smaller ecosystem</li>
</ul>
<p><strong>Tortoise ORM:</strong></p>
<ul>
<li>✅ Django-like API</li>
<li>✅ Native async</li>
<li>❌ Limited complex query support</li>
<li>❌ Migrations are rough</li>
</ul>
<p><strong>SQLModel:</strong></p>
<ul>
<li>✅ Pydantic + SQLAlchemy in one</li>
<li>✅ Less boilerplate</li>
<li>❌ Async support incomplete (as of 2025)</li>
<li>❌ Hides SQLAlchemy complexity (good and bad)</li>
</ul>
<p><strong>Our take:</strong> SQLAlchemy 2.0 for anything serious. The others are fine for prototypes.</p>
<h2 id="8-timeouts-retries-and-circuit-breakers">8. Timeouts, Retries, and Circuit Breakers</h2>
<p>External services will fail. Here’s how to not take down your API when they do.</p>
<h3 id="httpx--anyio-timeouts-that-actually-work">httpx + anyio Timeouts That Actually Work</h3>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token keyword">import</span> httpx
<span class="token keyword">from</span> contextlib <span class="token keyword">import</span> asynccontextmanager

<span class="token decorator annotation punctuation">@asynccontextmanager</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_http_client</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Shared HTTP client with sane timeouts"""</span>
    timeout <span class="token operator">=</span> httpx<span class="token punctuation">.</span>Timeout<span class="token punctuation">(</span>
        connect<span class="token operator">=</span><span class="token number">5.0</span><span class="token punctuation">,</span>   <span class="token comment"># Max time to establish connection</span>
        read<span class="token operator">=</span><span class="token number">10.0</span><span class="token punctuation">,</span>     <span class="token comment"># Max time to read response</span>
        write<span class="token operator">=</span><span class="token number">5.0</span><span class="token punctuation">,</span>     <span class="token comment"># Max time to send request</span>
        pool<span class="token operator">=</span><span class="token number">10.0</span>      <span class="token comment"># Max time to get connection from pool</span>
    <span class="token punctuation">)</span>
    
    limits <span class="token operator">=</span> httpx<span class="token punctuation">.</span>Limits<span class="token punctuation">(</span>
        max_connections<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span>
        max_keepalive_connections<span class="token operator">=</span><span class="token number">20</span>
    <span class="token punctuation">)</span>
    
    <span class="token keyword">async</span> <span class="token keyword">with</span> httpx<span class="token punctuation">.</span>AsyncClient<span class="token punctuation">(</span>
        timeout<span class="token operator">=</span>timeout<span class="token punctuation">,</span>
        limits<span class="token operator">=</span>limits<span class="token punctuation">,</span>
        http2<span class="token operator">=</span><span class="token boolean">True</span>
    <span class="token punctuation">)</span> <span class="token keyword">as</span> client<span class="token punctuation">:</span>
        <span class="token keyword">yield</span> client

<span class="token comment"># In lifespan</span>
<span class="token decorator annotation punctuation">@asynccontextmanager</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">lifespan</span><span class="token punctuation">(</span>app<span class="token punctuation">:</span> FastAPI<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">async</span> <span class="token keyword">with</span> get_http_client<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> client<span class="token punctuation">:</span>
        app<span class="token punctuation">.</span>state<span class="token punctuation">.</span>http_client <span class="token operator">=</span> client
        <span class="token keyword">yield</span>

<span class="token comment"># In dependencies</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_http_client_dep</span><span class="token punctuation">(</span>request<span class="token punctuation">:</span> Request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> request<span class="token punctuation">.</span>app<span class="token punctuation">.</span>state<span class="token punctuation">.</span>http_client

<span class="token comment"># In routes</span>
<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/external"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">call_external</span><span class="token punctuation">(</span>client<span class="token punctuation">:</span> httpx<span class="token punctuation">.</span>AsyncClient <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_http_client_dep<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        response <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"https://api.slow-service.com/data"</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> httpx<span class="token punctuation">.</span>TimeoutException<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>status_code<span class="token operator">=</span><span class="token number">504</span><span class="token punctuation">,</span> detail<span class="token operator">=</span><span class="token string">"External service timeout"</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="retry-logic-with-tenacity">Retry Logic with Tenacity</h3>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token keyword">from</span> tenacity <span class="token keyword">import</span> <span class="token punctuation">(</span>
    retry<span class="token punctuation">,</span>
    stop_after_attempt<span class="token punctuation">,</span>
    wait_exponential<span class="token punctuation">,</span>
    retry_if_exception_type
<span class="token punctuation">)</span>
<span class="token keyword">import</span> httpx

<span class="token keyword">class</span> <span class="token class-name">ExternalAPIClient</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> client<span class="token punctuation">:</span> httpx<span class="token punctuation">.</span>AsyncClient<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>client <span class="token operator">=</span> client
    
    <span class="token decorator annotation punctuation">@retry</span><span class="token punctuation">(</span>
        stop<span class="token operator">=</span>stop_after_attempt<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        wait<span class="token operator">=</span>wait_exponential<span class="token punctuation">(</span>multiplier<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">max</span><span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        retry<span class="token operator">=</span>retry_if_exception_type<span class="token punctuation">(</span><span class="token punctuation">(</span>httpx<span class="token punctuation">.</span>TimeoutException<span class="token punctuation">,</span> httpx<span class="token punctuation">.</span>NetworkError<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_user</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Retries on timeout/network errors, not on 4xx/5xx"""</span>
        response <span class="token operator">=</span> <span class="token keyword">await</span> self<span class="token punctuation">.</span>client<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"https://api.example.com/users/</span><span class="token interpolation"><span class="token punctuation">{</span>user_id<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        response<span class="token punctuation">.</span>raise_for_status<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># Usage</span>
<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/users/{user_id}"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_user</span><span class="token punctuation">(</span>
    user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
    client<span class="token punctuation">:</span> httpx<span class="token punctuation">.</span>AsyncClient <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_http_client_dep<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    api_client <span class="token operator">=</span> ExternalAPIClient<span class="token punctuation">(</span>client<span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> api_client<span class="token punctuation">.</span>get_user<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span>
    <span class="token keyword">except</span> httpx<span class="token punctuation">.</span>HTTPStatusError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">if</span> e<span class="token punctuation">.</span>response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">404</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>status_code<span class="token operator">=</span><span class="token number">404</span><span class="token punctuation">,</span> detail<span class="token operator">=</span><span class="token string">"User not found"</span><span class="token punctuation">)</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>status_code<span class="token operator">=</span><span class="token number">502</span><span class="token punctuation">,</span> detail<span class="token operator">=</span><span class="token string">"External API error"</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="circuit-breaker-pattern">Circuit Breaker Pattern</h3>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime<span class="token punctuation">,</span> timedelta
<span class="token keyword">from</span> enum <span class="token keyword">import</span> Enum

<span class="token keyword">class</span> <span class="token class-name">CircuitState</span><span class="token punctuation">(</span>Enum<span class="token punctuation">)</span><span class="token punctuation">:</span>
    CLOSED <span class="token operator">=</span> <span class="token string">"closed"</span>      <span class="token comment"># Normal operation</span>
    OPEN <span class="token operator">=</span> <span class="token string">"open"</span>          <span class="token comment"># Failing, reject requests</span>
    HALF_OPEN <span class="token operator">=</span> <span class="token string">"half_open"</span>  <span class="token comment"># Testing if recovered</span>

<span class="token keyword">class</span> <span class="token class-name">CircuitBreaker</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>
        self<span class="token punctuation">,</span>
        failure_threshold<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span>
        timeout<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">60</span><span class="token punctuation">,</span>
        expected_exception<span class="token punctuation">:</span> <span class="token builtin">type</span> <span class="token operator">=</span> Exception
    <span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>failure_threshold <span class="token operator">=</span> failure_threshold
        self<span class="token punctuation">.</span>timeout <span class="token operator">=</span> timeout
        self<span class="token punctuation">.</span>expected_exception <span class="token operator">=</span> expected_exception
        
        self<span class="token punctuation">.</span>failure_count <span class="token operator">=</span> <span class="token number">0</span>
        self<span class="token punctuation">.</span>last_failure_time<span class="token punctuation">:</span> datetime <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>state <span class="token operator">=</span> CircuitState<span class="token punctuation">.</span>CLOSED
    
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">call</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> func<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>state <span class="token operator">==</span> CircuitState<span class="token punctuation">.</span>OPEN<span class="token punctuation">:</span>
            <span class="token keyword">if</span> datetime<span class="token punctuation">.</span>utcnow<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> self<span class="token punctuation">.</span>last_failure_time <span class="token operator">></span> timedelta<span class="token punctuation">(</span>seconds<span class="token operator">=</span>self<span class="token punctuation">.</span>timeout<span class="token punctuation">)</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>state <span class="token operator">=</span> CircuitState<span class="token punctuation">.</span>HALF_OPEN
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">"Circuit breaker is OPEN"</span><span class="token punctuation">)</span>
        
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            result <span class="token operator">=</span> <span class="token keyword">await</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>state <span class="token operator">==</span> CircuitState<span class="token punctuation">.</span>HALF_OPEN<span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>state <span class="token operator">=</span> CircuitState<span class="token punctuation">.</span>CLOSED
                self<span class="token punctuation">.</span>failure_count <span class="token operator">=</span> <span class="token number">0</span>
            <span class="token keyword">return</span> result
        <span class="token keyword">except</span> self<span class="token punctuation">.</span>expected_exception<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>failure_count <span class="token operator">+=</span> <span class="token number">1</span>
            self<span class="token punctuation">.</span>last_failure_time <span class="token operator">=</span> datetime<span class="token punctuation">.</span>utcnow<span class="token punctuation">(</span><span class="token punctuation">)</span>
            
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>failure_count <span class="token operator">>=</span> self<span class="token punctuation">.</span>failure_threshold<span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>state <span class="token operator">=</span> CircuitState<span class="token punctuation">.</span>OPEN
            
            <span class="token keyword">raise</span>

<span class="token comment"># Usage</span>
payment_circuit <span class="token operator">=</span> CircuitBreaker<span class="token punctuation">(</span>failure_threshold<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">60</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/charge"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">charge_card</span><span class="token punctuation">(</span>amount<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> client<span class="token punctuation">:</span> httpx<span class="token punctuation">.</span>AsyncClient <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_http_client_dep<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">call_payment_api</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            response <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span>post<span class="token punctuation">(</span>
                <span class="token string">"https://payment-api.example.com/charge"</span><span class="token punctuation">,</span>
                json<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"amount"</span><span class="token punctuation">:</span> amount<span class="token punctuation">}</span>
            <span class="token punctuation">)</span>
            response<span class="token punctuation">.</span>raise_for_status<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token keyword">return</span> <span class="token keyword">await</span> payment_circuit<span class="token punctuation">.</span>call<span class="token punctuation">(</span>call_payment_api<span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>status_code<span class="token operator">=</span><span class="token number">503</span><span class="token punctuation">,</span> detail<span class="token operator">=</span><span class="token string">"Payment service unavailable"</span><span class="token punctuation">)</span>
</code></pre>
<p><strong>Real production example with all three:</strong></p>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token keyword">class</span> <span class="token class-name">ResilientExternalClient</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> client<span class="token punctuation">:</span> httpx<span class="token punctuation">.</span>AsyncClient<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>client <span class="token operator">=</span> client
        self<span class="token punctuation">.</span>circuit_breaker <span class="token operator">=</span> CircuitBreaker<span class="token punctuation">(</span>failure_threshold<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">60</span><span class="token punctuation">)</span>
    
    <span class="token decorator annotation punctuation">@retry</span><span class="token punctuation">(</span>
        stop<span class="token operator">=</span>stop_after_attempt<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        wait<span class="token operator">=</span>wait_exponential<span class="token punctuation">(</span>multiplier<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">max</span><span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        retry<span class="token operator">=</span>retry_if_exception_type<span class="token punctuation">(</span><span class="token punctuation">(</span>httpx<span class="token punctuation">.</span>TimeoutException<span class="token punctuation">,</span> httpx<span class="token punctuation">.</span>NetworkError<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">fetch_data</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> endpoint<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">_fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            response <span class="token operator">=</span> <span class="token keyword">await</span> self<span class="token punctuation">.</span>client<span class="token punctuation">.</span>get<span class="token punctuation">(</span>endpoint<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">5.0</span><span class="token punctuation">)</span>
            response<span class="token punctuation">.</span>raise_for_status<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token keyword">return</span> <span class="token keyword">await</span> self<span class="token punctuation">.</span>circuit_breaker<span class="token punctuation">.</span>call<span class="token punctuation">(</span>_fetch<span class="token punctuation">)</span>
</code></pre>
<h2 id="9-cache-control-headers---leverage-cdns-without-thinking">9. Cache Control Headers - Leverage CDNs Without Thinking</h2>
<p>Most FastAPI teams ignore HTTP caching headers and leave money on the table. Here’s what actually works.</p>
<h3 id="the-http-cache-control-header">The HTTP Cache Control Header</h3>
<pre class="language-plaintext" data-language="plaintext"><code is:raw="" class="language-plaintext">Cache-Control: public, max-age=3600, s-maxage=86400
</code></pre>
<p>Breaks down as:</p>
<ul>
<li><code>public</code>: Proxies and CDNs can cache (not just browsers)</li>
<li><code>max-age=3600</code>: Browser caches for 1 hour</li>
<li><code>s-maxage=86400</code>: CDN/shared proxy caches for 24 hours (overrides max-age for CDNs)</li>
</ul>
<p><strong>Common patterns:</strong></p>






























<table><thead><tr><th>Type</th><th>Header</th><th>Why</th></tr></thead><tbody><tr><td>Public static (assets)</td><td><code>public, max-age=31536000, immutable</code></td><td>Cache forever (hash-busting in URL)</td></tr><tr><td>Dynamic but stable (blog posts, user profiles)</td><td><code>public, max-age=300, s-maxage=3600</code></td><td>Revalidate in 5min, CDN keeps 1h</td></tr><tr><td>Personal data</td><td><code>private, max-age=0, must-revalidate</code></td><td>No CDN cache, revalidate every request</td></tr><tr><td>Never cache</td><td><code>no-store</code></td><td>Payment pages, OTPs, etc.</td></tr></tbody></table>
<h3 id="implementation">Implementation</h3>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime<span class="token punctuation">,</span> timedelta
<span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPI<span class="token punctuation">,</span> Response
<span class="token keyword">from</span> fastapi<span class="token punctuation">.</span>responses <span class="token keyword">import</span> JSONResponse

app <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">set_cache_headers</span><span class="token punctuation">(</span>
    response<span class="token punctuation">:</span> Response<span class="token punctuation">,</span>
    max_age<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">3600</span><span class="token punctuation">,</span>
    s_maxage<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    public<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
    immutable<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">False</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Helper to set cache headers consistently"""</span>
    directives <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    
    <span class="token keyword">if</span> public<span class="token punctuation">:</span>
        directives<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">"public"</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        directives<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">"private"</span><span class="token punctuation">)</span>
    
    directives<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"max-age=</span><span class="token interpolation"><span class="token punctuation">{</span>max_age<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    
    <span class="token keyword">if</span> s_maxage<span class="token punctuation">:</span>
        directives<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"s-maxage=</span><span class="token interpolation"><span class="token punctuation">{</span>s_maxage<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    
    <span class="token keyword">if</span> immutable<span class="token punctuation">:</span>
        directives<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">"immutable"</span><span class="token punctuation">)</span>
    
    response<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">"Cache-Control"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">", "</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>directives<span class="token punctuation">)</span>
    response<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">"Vary"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Accept-Encoding"</span>  <span class="token comment"># Important for compressed responses</span>

<span class="token comment"># Usage in routes</span>
<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/api/posts/{post_id}"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_post</span><span class="token punctuation">(</span>post_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    post <span class="token operator">=</span> <span class="token keyword">await</span> fetch_post<span class="token punctuation">(</span>post_id<span class="token punctuation">)</span>
    response <span class="token operator">=</span> JSONResponse<span class="token punctuation">(</span>content<span class="token operator">=</span>post<span class="token punctuation">)</span>
    
    <span class="token comment"># Cache public content for 5 min browser, 1 hour CDN</span>
    set_cache_headers<span class="token punctuation">(</span>response<span class="token punctuation">,</span> max_age<span class="token operator">=</span><span class="token number">300</span><span class="token punctuation">,</span> s_maxage<span class="token operator">=</span><span class="token number">3600</span><span class="token punctuation">,</span> public<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> response

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/api/me"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_current_user</span><span class="token punctuation">(</span>current_user<span class="token punctuation">:</span> User <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_current_user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Personal data: no CDN cache</span>
    response <span class="token operator">=</span> JSONResponse<span class="token punctuation">(</span>content<span class="token operator">=</span>current_user<span class="token punctuation">.</span><span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    set_cache_headers<span class="token punctuation">(</span>response<span class="token punctuation">,</span> max_age<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> public<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    response<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">"Cache-Control"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"private, no-cache, must-revalidate"</span>
    <span class="token keyword">return</span> response

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/api/payments"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">process_payment</span><span class="token punctuation">(</span>data<span class="token punctuation">:</span> PaymentRequest<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Payment pages never cache</span>
    response <span class="token operator">=</span> JSONResponse<span class="token punctuation">(</span>content<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"processing"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    response<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">"Cache-Control"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"no-store, no-cache, must-revalidate, max-age=0"</span>
    <span class="token keyword">return</span> response
</code></pre>
<h3 id="cache-busting-with-etag">Cache Busting with ETag</h3>
<p>The <code>ETag</code> header lets clients ask “has this changed?” without downloading:</p>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token keyword">from</span> hashlib <span class="token keyword">import</span> md5

<span class="token keyword">def</span> <span class="token function">generate_etag</span><span class="token punctuation">(</span>content<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">str</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> md5<span class="token punctuation">(</span>content<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/api/config"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_config</span><span class="token punctuation">(</span>request<span class="token punctuation">:</span> Request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    config <span class="token operator">=</span> <span class="token keyword">await</span> fetch_config<span class="token punctuation">(</span><span class="token punctuation">)</span>
    config_json <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>config<span class="token punctuation">,</span> sort_keys<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    etag <span class="token operator">=</span> generate_etag<span class="token punctuation">(</span>config_json<span class="token punctuation">)</span>
    
    <span class="token comment"># Client sends If-None-Match header with previous ETag</span>
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"If-None-Match"</span><span class="token punctuation">)</span> <span class="token operator">==</span> etag<span class="token punctuation">:</span>
        <span class="token keyword">return</span> Response<span class="token punctuation">(</span>status_code<span class="token operator">=</span><span class="token number">304</span><span class="token punctuation">)</span>  <span class="token comment"># Not Modified</span>
    
    response <span class="token operator">=</span> JSONResponse<span class="token punctuation">(</span>content<span class="token operator">=</span>config<span class="token punctuation">)</span>
    response<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">"ETag"</span><span class="token punctuation">]</span> <span class="token operator">=</span> etag
    set_cache_headers<span class="token punctuation">(</span>response<span class="token punctuation">,</span> max_age<span class="token operator">=</span><span class="token number">3600</span><span class="token punctuation">,</span> s_maxage<span class="token operator">=</span><span class="token number">86400</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> response
</code></pre>
<h3 id="last-modified-header-conditional-requests">Last-Modified Header (Conditional Requests)</h3>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/api/users/{user_id}"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_user</span><span class="token punctuation">(</span>user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> request<span class="token punctuation">:</span> Request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    user <span class="token operator">=</span> <span class="token keyword">await</span> fetch_user<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span>
    last_modified <span class="token operator">=</span> user<span class="token punctuation">.</span>updated_at
    
    <span class="token comment"># Client can send If-Modified-Since</span>
    if_modified_since <span class="token operator">=</span> request<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"If-Modified-Since"</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> if_modified_since<span class="token punctuation">:</span>
        client_time <span class="token operator">=</span> datetime<span class="token punctuation">.</span>fromisoformat<span class="token punctuation">(</span>if_modified_since<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'Z'</span><span class="token punctuation">,</span> <span class="token string">'+00:00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> last_modified <span class="token operator">&#x3C;=</span> client_time<span class="token punctuation">:</span>
            <span class="token keyword">return</span> Response<span class="token punctuation">(</span>status_code<span class="token operator">=</span><span class="token number">304</span><span class="token punctuation">)</span>
    
    response <span class="token operator">=</span> JSONResponse<span class="token punctuation">(</span>content<span class="token operator">=</span>user<span class="token punctuation">.</span><span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    response<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">"Last-Modified"</span><span class="token punctuation">]</span> <span class="token operator">=</span> last_modified<span class="token punctuation">.</span>isoformat<span class="token punctuation">(</span><span class="token punctuation">)</span>
    set_cache_headers<span class="token punctuation">(</span>response<span class="token punctuation">,</span> max_age<span class="token operator">=</span><span class="token number">300</span><span class="token punctuation">,</span> s_maxage<span class="token operator">=</span><span class="token number">3600</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> response
</code></pre>
<h3 id="middleware-for-automatic-cache-headers">Middleware for Automatic Cache Headers</h3>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token keyword">from</span> starlette<span class="token punctuation">.</span>middleware<span class="token punctuation">.</span>base <span class="token keyword">import</span> BaseHTTPMiddleware
<span class="token keyword">from</span> starlette<span class="token punctuation">.</span>types <span class="token keyword">import</span> ASGIApp<span class="token punctuation">,</span> Message<span class="token punctuation">,</span> Receive<span class="token punctuation">,</span> Scope<span class="token punctuation">,</span> Send

<span class="token keyword">class</span> <span class="token class-name">CacheControlMiddleware</span><span class="token punctuation">(</span>BaseHTTPMiddleware<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">dispatch</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">:</span> Request<span class="token punctuation">,</span> call_next<span class="token punctuation">)</span><span class="token punctuation">:</span>
        response <span class="token operator">=</span> <span class="token keyword">await</span> call_next<span class="token punctuation">(</span>request<span class="token punctuation">)</span>
        
        <span class="token comment"># Default: 5 min cache for GET, no cache for mutations</span>
        <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">"GET"</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token string">"Cache-Control"</span> <span class="token keyword">not</span> <span class="token keyword">in</span> response<span class="token punctuation">.</span>headers<span class="token punctuation">:</span>
                set_cache_headers<span class="token punctuation">(</span>response<span class="token punctuation">,</span> max_age<span class="token operator">=</span><span class="token number">300</span><span class="token punctuation">,</span> s_maxage<span class="token operator">=</span><span class="token number">3600</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            response<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">"Cache-Control"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"no-store"</span>
        
        <span class="token comment"># Always add Vary header for compression</span>
        <span class="token keyword">if</span> <span class="token string">"Vary"</span> <span class="token keyword">not</span> <span class="token keyword">in</span> response<span class="token punctuation">.</span>headers<span class="token punctuation">:</span>
            response<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">"Vary"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Accept-Encoding"</span>
        
        <span class="token keyword">return</span> response

app<span class="token punctuation">.</span>add_middleware<span class="token punctuation">(</span>CacheControlMiddleware<span class="token punctuation">)</span>
</code></pre>
<h3 id="cdn-integration-cloudflare-example">CDN Integration (Cloudflare Example)</h3>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/api/data/{data_id}"</span><span class="token punctuation">,</span> responses<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">304</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"Not Modified"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_data</span><span class="token punctuation">(</span>data_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> request<span class="token punctuation">:</span> Request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    data <span class="token operator">=</span> <span class="token keyword">await</span> fetch_data<span class="token punctuation">(</span>data_id<span class="token punctuation">)</span>
    response <span class="token operator">=</span> JSONResponse<span class="token punctuation">(</span>content<span class="token operator">=</span>data<span class="token punctuation">)</span>
    
    <span class="token comment"># Tell Cloudflare to cache for 1 hour</span>
    <span class="token comment"># (Browser: 5 min, Cloudflare: 1 hour)</span>
    response<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">"Cache-Control"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"public, max-age=300, s-maxage=3600"</span>
    
    <span class="token comment"># Cloudflare specific: cache by this key (default is URL)</span>
    response<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">"CF-Cache-Key"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"data:</span><span class="token interpolation"><span class="token punctuation">{</span>data_id<span class="token punctuation">}</span></span><span class="token string">"</span></span>
    
    <span class="token comment"># Cloudflare specific: cache even 404s for 5 min</span>
    response<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">"CF-Cache-Status"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"CACHE"</span>
    
    <span class="token keyword">return</span> response
</code></pre>
<p><strong>Real impact:</strong> This middleware alone reduced our Cloudflare egress by 60% (from 400GB/month to 160GB/month, saving ~$2k/month).</p>
<h3 id="busting-cache-on-updates">Busting Cache on Updates</h3>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token keyword">import</span> aioredis

cache <span class="token operator">=</span> <span class="token boolean">None</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>on_event</span><span class="token punctuation">(</span><span class="token string">"startup"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">startup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> cache
    cache <span class="token operator">=</span> <span class="token keyword">await</span> aioredis<span class="token punctuation">.</span>from_url<span class="token punctuation">(</span><span class="token string">"redis://localhost"</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>put</span><span class="token punctuation">(</span><span class="token string">"/api/posts/{post_id}"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">update_post</span><span class="token punctuation">(</span>post_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> PostUpdate<span class="token punctuation">)</span><span class="token punctuation">:</span>
    post <span class="token operator">=</span> <span class="token keyword">await</span> update_post_db<span class="token punctuation">(</span>post_id<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
    
    <span class="token comment"># Invalidate CDN cache by purging on update</span>
    <span class="token keyword">await</span> purge_cloudflare_cache<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"/api/posts/</span><span class="token interpolation"><span class="token punctuation">{</span>post_id<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    
    <span class="token comment"># Also invalidate in Redis for local caching</span>
    <span class="token keyword">await</span> cache<span class="token punctuation">.</span>delete<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"post:</span><span class="token interpolation"><span class="token punctuation">{</span>post_id<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> post
</code></pre>
<h3 id="cache-stampede-prevention">Cache Stampede Prevention</h3>
<p>When cache expires and 1000 requests hit your database at once:</p>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime<span class="token punctuation">,</span> timedelta

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_with_cache_lock</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> fetch_func<span class="token punctuation">,</span> ttl<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">3600</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Prevent cache stampede with mutex lock"""</span>
    value <span class="token operator">=</span> <span class="token keyword">await</span> cache<span class="token punctuation">.</span>get<span class="token punctuation">(</span>key<span class="token punctuation">)</span>
    <span class="token keyword">if</span> value<span class="token punctuation">:</span>
        <span class="token keyword">return</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    
    <span class="token comment"># Acquire lock (key + ":lock")</span>
    lock_key <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>key<span class="token punctuation">}</span></span><span class="token string">:lock"</span></span>
    lock_acquired <span class="token operator">=</span> <span class="token keyword">await</span> cache<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>lock_key<span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">,</span> ex<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> nx<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    
    <span class="token keyword">if</span> lock_acquired<span class="token punctuation">:</span>
        <span class="token comment"># We have the lock, fetch and cache</span>
        value <span class="token operator">=</span> <span class="token keyword">await</span> fetch_func<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">await</span> cache<span class="token punctuation">.</span>setex<span class="token punctuation">(</span>key<span class="token punctuation">,</span> ttl<span class="token punctuation">,</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">await</span> cache<span class="token punctuation">.</span>delete<span class="token punctuation">(</span>lock_key<span class="token punctuation">)</span>
        <span class="token keyword">return</span> value
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token comment"># Someone else is fetching, wait and retry</span>
        <span class="token keyword">import</span> asyncio
        <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>
            value <span class="token operator">=</span> <span class="token keyword">await</span> cache<span class="token punctuation">.</span>get<span class="token punctuation">(</span>key<span class="token punctuation">)</span>
            <span class="token keyword">if</span> value<span class="token punctuation">:</span>
                <span class="token keyword">return</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>value<span class="token punctuation">)</span>
        
        <span class="token comment"># Fallback: fetch ourselves</span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> fetch_func<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h2 id="10-file-uploads-downloads-and-multipart---the-footguns-nobody-warns-about">10. File Uploads, Downloads, and Multipart - The Footguns Nobody Warns About</h2>
<p>File handling in FastAPI is simple until production hits. Here’s how to handle it without losing data or getting 0-day’d.</p>
<h3 id="file-upload---the-naive-approach-works-until-500mb">File Upload - The Naive Approach (Works Until 500MB)</h3>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPI<span class="token punctuation">,</span> UploadFile<span class="token punctuation">,</span> File
<span class="token keyword">from</span> pathlib <span class="token keyword">import</span> Path

app <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>
UPLOAD_DIR <span class="token operator">=</span> Path<span class="token punctuation">(</span><span class="token string">"uploads"</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/upload"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">upload_file</span><span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">:</span> UploadFile <span class="token operator">=</span> File<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># DON'T DO THIS - loads entire file into memory</span>
    contents <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token builtin">file</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment"># Write to disk</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>UPLOAD_DIR <span class="token operator">/</span> <span class="token builtin">file</span><span class="token punctuation">.</span>filename<span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>contents<span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">"filename"</span><span class="token punctuation">:</span> <span class="token builtin">file</span><span class="token punctuation">.</span>filename<span class="token punctuation">,</span> <span class="token string">"size"</span><span class="token punctuation">:</span> <span class="token builtin">len</span><span class="token punctuation">(</span>contents<span class="token punctuation">)</span><span class="token punctuation">}</span>
</code></pre>
<p><strong>Problems:</strong></p>
<ul>
<li>500MB file = 500MB RAM spike (OOM on shared hosting)</li>
<li>No validation of MIME types</li>
<li>Filename from user input (directory traversal vulnerability: <code>../../etc/passwd</code>)</li>
<li>No progress tracking</li>
<li>No size limits</li>
</ul>
<h3 id="file-upload---production-pattern">File Upload - Production Pattern</h3>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token keyword">import</span> aiofiles
<span class="token keyword">import</span> hashlib
<span class="token keyword">import</span> uuid
<span class="token keyword">from</span> pathlib <span class="token keyword">import</span> Path
<span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPI<span class="token punctuation">,</span> UploadFile<span class="token punctuation">,</span> File<span class="token punctuation">,</span> HTTPException<span class="token punctuation">,</span> status
<span class="token keyword">from</span> fastapi<span class="token punctuation">.</span>responses <span class="token keyword">import</span> FileResponse

app <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>

UPLOAD_DIR <span class="token operator">=</span> Path<span class="token punctuation">(</span><span class="token string">"uploads"</span><span class="token punctuation">)</span>
UPLOAD_DIR<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

<span class="token comment"># Whitelist allowed MIME types</span>
ALLOWED_MIME_TYPES <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">"image/jpeg"</span><span class="token punctuation">:</span> <span class="token string">".jpg"</span><span class="token punctuation">,</span>
    <span class="token string">"image/png"</span><span class="token punctuation">:</span> <span class="token string">".png"</span><span class="token punctuation">,</span>
    <span class="token string">"image/webp"</span><span class="token punctuation">:</span> <span class="token string">".webp"</span><span class="token punctuation">,</span>
    <span class="token string">"application/pdf"</span><span class="token punctuation">:</span> <span class="token string">".pdf"</span><span class="token punctuation">,</span>
    <span class="token string">"text/csv"</span><span class="token punctuation">:</span> <span class="token string">".csv"</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

MAX_FILE_SIZE <span class="token operator">=</span> <span class="token number">50</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span>  <span class="token comment"># 50MB</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/upload"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">upload_file</span><span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">:</span> UploadFile <span class="token operator">=</span> File<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 1. Validate MIME type</span>
    <span class="token keyword">if</span> <span class="token builtin">file</span><span class="token punctuation">.</span>content_type <span class="token keyword">not</span> <span class="token keyword">in</span> ALLOWED_MIME_TYPES<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>
            status_code<span class="token operator">=</span>status<span class="token punctuation">.</span>HTTP_400_BAD_REQUEST<span class="token punctuation">,</span>
            detail<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"File type </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">file</span><span class="token punctuation">.</span>content_type<span class="token punctuation">}</span></span><span class="token string"> not allowed"</span></span>
        <span class="token punctuation">)</span>
    
    <span class="token comment"># 2. Generate safe filename (ignore user input)</span>
    file_id <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>uuid<span class="token punctuation">.</span>uuid4<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    file_ext <span class="token operator">=</span> ALLOWED_MIME_TYPES<span class="token punctuation">[</span><span class="token builtin">file</span><span class="token punctuation">.</span>content_type<span class="token punctuation">]</span>
    safe_filename <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>file_id<span class="token punctuation">}</span></span><span class="token interpolation"><span class="token punctuation">{</span>file_ext<span class="token punctuation">}</span></span><span class="token string">"</span></span>
    file_path <span class="token operator">=</span> UPLOAD_DIR <span class="token operator">/</span> safe_filename
    
    <span class="token comment"># 3. Stream upload with size limit</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        size <span class="token operator">=</span> <span class="token number">0</span>
        file_hash <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>sha256<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token keyword">async</span> <span class="token keyword">with</span> aiofiles<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            <span class="token keyword">while</span> chunk <span class="token operator">:=</span> <span class="token keyword">await</span> <span class="token builtin">file</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">8192</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 8KB chunks</span>
                size <span class="token operator">+=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span>
                
                <span class="token keyword">if</span> size <span class="token operator">></span> MAX_FILE_SIZE<span class="token punctuation">:</span>
                    file_path<span class="token punctuation">.</span>unlink<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># Clean up</span>
                    <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>
                        status_code<span class="token operator">=</span>status<span class="token punctuation">.</span>HTTP_413_REQUEST_ENTITY_TOO_LARGE<span class="token punctuation">,</span>
                        detail<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"File exceeds </span><span class="token interpolation"><span class="token punctuation">{</span>MAX_FILE_SIZE<span class="token punctuation">}</span></span><span class="token string"> bytes"</span></span>
                    <span class="token punctuation">)</span>
                
                file_hash<span class="token punctuation">.</span>update<span class="token punctuation">(</span>chunk<span class="token punctuation">)</span>
                <span class="token keyword">await</span> f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>chunk<span class="token punctuation">)</span>
    
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">if</span> file_path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            file_path<span class="token punctuation">.</span>unlink<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">raise</span>
    
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token string">"id"</span><span class="token punctuation">:</span> file_id<span class="token punctuation">,</span>
        <span class="token string">"filename"</span><span class="token punctuation">:</span> safe_filename<span class="token punctuation">,</span>
        <span class="token string">"size"</span><span class="token punctuation">:</span> size<span class="token punctuation">,</span>
        <span class="token string">"sha256"</span><span class="token punctuation">:</span> file_hash<span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">"mime_type"</span><span class="token punctuation">:</span> <span class="token builtin">file</span><span class="token punctuation">.</span>content_type
    <span class="token punctuation">}</span>
</code></pre>
<h3 id="multiple-file-uploads">Multiple File Uploads</h3>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token keyword">from</span> typing <span class="token keyword">import</span> List

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/upload-batch"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">upload_multiple</span><span class="token punctuation">(</span>files<span class="token punctuation">:</span> List<span class="token punctuation">[</span>UploadFile<span class="token punctuation">]</span> <span class="token operator">=</span> File<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Upload multiple files with validation"""</span>
    results <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    
    <span class="token keyword">for</span> <span class="token builtin">file</span> <span class="token keyword">in</span> files<span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token builtin">file</span><span class="token punctuation">.</span>content_type <span class="token keyword">not</span> <span class="token keyword">in</span> ALLOWED_MIME_TYPES<span class="token punctuation">:</span>
            results<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span>
                <span class="token string">"filename"</span><span class="token punctuation">:</span> <span class="token builtin">file</span><span class="token punctuation">.</span>filename<span class="token punctuation">,</span>
                <span class="token string">"error"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"Invalid MIME type: </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">file</span><span class="token punctuation">.</span>content_type<span class="token punctuation">}</span></span><span class="token string">"</span></span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token keyword">continue</span>
        
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            file_id <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>uuid<span class="token punctuation">.</span>uuid4<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            file_ext <span class="token operator">=</span> ALLOWED_MIME_TYPES<span class="token punctuation">[</span><span class="token builtin">file</span><span class="token punctuation">.</span>content_type<span class="token punctuation">]</span>
            safe_filename <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>file_id<span class="token punctuation">}</span></span><span class="token interpolation"><span class="token punctuation">{</span>file_ext<span class="token punctuation">}</span></span><span class="token string">"</span></span>
            file_path <span class="token operator">=</span> UPLOAD_DIR <span class="token operator">/</span> safe_filename
            
            size <span class="token operator">=</span> <span class="token number">0</span>
            <span class="token keyword">async</span> <span class="token keyword">with</span> aiofiles<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
                <span class="token keyword">while</span> chunk <span class="token operator">:=</span> <span class="token keyword">await</span> <span class="token builtin">file</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">8192</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    size <span class="token operator">+=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span>
                    <span class="token keyword">if</span> size <span class="token operator">></span> MAX_FILE_SIZE<span class="token punctuation">:</span>
                        file_path<span class="token punctuation">.</span>unlink<span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"File too large"</span><span class="token punctuation">)</span>
                    <span class="token keyword">await</span> f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>chunk<span class="token punctuation">)</span>
            
            results<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span>
                <span class="token string">"filename"</span><span class="token punctuation">:</span> safe_filename<span class="token punctuation">,</span>
                <span class="token string">"size"</span><span class="token punctuation">:</span> size<span class="token punctuation">,</span>
                <span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"success"</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            results<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span>
                <span class="token string">"filename"</span><span class="token punctuation">:</span> <span class="token builtin">file</span><span class="token punctuation">.</span>filename<span class="token punctuation">,</span>
                <span class="token string">"error"</span><span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">"uploads"</span><span class="token punctuation">:</span> results<span class="token punctuation">}</span>
</code></pre>
<h3 id="file-download---streaming-for-large-files">File Download - Streaming for Large Files</h3>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/download/{file_id}"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">download_file</span><span class="token punctuation">(</span>file_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Stream file for download (use for large files)"""</span>
    <span class="token comment"># Validate file_id format (UUID)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        uuid<span class="token punctuation">.</span>UUID<span class="token punctuation">(</span>file_id<span class="token punctuation">)</span>
    <span class="token keyword">except</span> ValueError<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>status_code<span class="token operator">=</span><span class="token number">400</span><span class="token punctuation">,</span> detail<span class="token operator">=</span><span class="token string">"Invalid file ID"</span><span class="token punctuation">)</span>
    
    <span class="token comment"># Find file (check all allowed extensions)</span>
    file_path <span class="token operator">=</span> <span class="token boolean">None</span>
    <span class="token keyword">for</span> ext <span class="token keyword">in</span> ALLOWED_MIME_TYPES<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        candidate <span class="token operator">=</span> UPLOAD_DIR <span class="token operator">/</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>file_id<span class="token punctuation">}</span></span><span class="token interpolation"><span class="token punctuation">{</span>ext<span class="token punctuation">}</span></span><span class="token string">"</span></span>
        <span class="token keyword">if</span> candidate<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            file_path <span class="token operator">=</span> candidate
            <span class="token keyword">break</span>
    
    <span class="token keyword">if</span> <span class="token keyword">not</span> file_path<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>status_code<span class="token operator">=</span><span class="token number">404</span><span class="token punctuation">,</span> detail<span class="token operator">=</span><span class="token string">"File not found"</span><span class="token punctuation">)</span>
    
    <span class="token comment"># Return FileResponse (streams file, doesn't load into memory)</span>
    <span class="token keyword">return</span> FileResponse<span class="token punctuation">(</span>
        path<span class="token operator">=</span>file_path<span class="token punctuation">,</span>
        filename<span class="token operator">=</span>file_path<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
        media_type<span class="token operator">=</span><span class="token string">"application/octet-stream"</span><span class="token punctuation">,</span>
        headers<span class="token operator">=</span><span class="token punctuation">{</span>
            <span class="token string">"Cache-Control"</span><span class="token punctuation">:</span> <span class="token string">"no-cache, no-store, must-revalidate"</span><span class="token punctuation">,</span>
            <span class="token string">"Content-Disposition"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"attachment; filename=</span><span class="token interpolation"><span class="token punctuation">{</span>file_path<span class="token punctuation">.</span>name<span class="token punctuation">}</span></span><span class="token string">"</span></span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
</code></pre>
<p><strong>Why FileResponse is critical:</strong></p>
<ul>
<li>Streams file in chunks (even 10GB files use minimal RAM)</li>
<li>Browser sees <code>Content-Disposition: attachment</code> and downloads</li>
<li><code>no-store</code> prevents caching sensitive files</li>
</ul>
<h3 id="streaming-upload-with-progress-tracking">Streaming Upload with Progress Tracking</h3>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token keyword">import</span> asyncio
<span class="token keyword">from</span> fastapi <span class="token keyword">import</span> WebSocket

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>websocket</span><span class="token punctuation">(</span><span class="token string">"/ws/upload-progress"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">websocket_upload</span><span class="token punctuation">(</span>websocket<span class="token punctuation">:</span> WebSocket<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            <span class="token comment"># Receive file metadata</span>
            data <span class="token operator">=</span> <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>receive_json<span class="token punctuation">(</span><span class="token punctuation">)</span>
            filename <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">"filename"</span><span class="token punctuation">]</span>
            content_type <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">"content_type"</span><span class="token punctuation">]</span>
            
            <span class="token keyword">if</span> content_type <span class="token keyword">not</span> <span class="token keyword">in</span> ALLOWED_MIME_TYPES<span class="token punctuation">:</span>
                <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>send_json<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"error"</span><span class="token punctuation">:</span> <span class="token string">"Invalid MIME type"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token keyword">continue</span>
            
            file_id <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>uuid<span class="token punctuation">.</span>uuid4<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            file_ext <span class="token operator">=</span> ALLOWED_MIME_TYPES<span class="token punctuation">[</span>content_type<span class="token punctuation">]</span>
            safe_filename <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>file_id<span class="token punctuation">}</span></span><span class="token interpolation"><span class="token punctuation">{</span>file_ext<span class="token punctuation">}</span></span><span class="token string">"</span></span>
            file_path <span class="token operator">=</span> UPLOAD_DIR <span class="token operator">/</span> safe_filename
            
            uploaded_size <span class="token operator">=</span> <span class="token number">0</span>
            
            <span class="token comment"># Receive file in chunks</span>
            <span class="token keyword">async</span> <span class="token keyword">with</span> aiofiles<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
                <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
                    <span class="token comment"># Receive chunk (client sends binary data)</span>
                    chunk <span class="token operator">=</span> <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>receive_bytes<span class="token punctuation">(</span><span class="token punctuation">)</span>
                    
                    <span class="token keyword">if</span> <span class="token keyword">not</span> chunk<span class="token punctuation">:</span>
                        <span class="token keyword">break</span>
                    
                    uploaded_size <span class="token operator">+=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span>
                    
                    <span class="token keyword">if</span> uploaded_size <span class="token operator">></span> MAX_FILE_SIZE<span class="token punctuation">:</span>
                        file_path<span class="token punctuation">.</span>unlink<span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>send_json<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"error"</span><span class="token punctuation">:</span> <span class="token string">"File too large"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
                        <span class="token keyword">break</span>
                    
                    <span class="token keyword">await</span> f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>chunk<span class="token punctuation">)</span>
                    
                    <span class="token comment"># Send progress update</span>
                    progress <span class="token operator">=</span> <span class="token punctuation">(</span>uploaded_size <span class="token operator">/</span> data<span class="token punctuation">[</span><span class="token string">"total_size"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span>
                    <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>send_json<span class="token punctuation">(</span><span class="token punctuation">{</span>
                        <span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"uploading"</span><span class="token punctuation">,</span>
                        <span class="token string">"progress"</span><span class="token punctuation">:</span> progress<span class="token punctuation">,</span>
                        <span class="token string">"uploaded"</span><span class="token punctuation">:</span> uploaded_size
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
            
            <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>send_json<span class="token punctuation">(</span><span class="token punctuation">{</span>
                <span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"success"</span><span class="token punctuation">,</span>
                <span class="token string">"file_id"</span><span class="token punctuation">:</span> file_id<span class="token punctuation">,</span>
                <span class="token string">"size"</span><span class="token punctuation">:</span> uploaded_size
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
    
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>send_json<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"error"</span><span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="file-upload-with-database-tracking">File Upload with Database Tracking</h3>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> Column<span class="token punctuation">,</span> Integer<span class="token punctuation">,</span> String<span class="token punctuation">,</span> DateTime
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime

<span class="token keyword">class</span> <span class="token class-name">FileRecord</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"files"</span>
    
    <span class="token builtin">id</span> <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    original_filename <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">)</span>
    stored_filename <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">)</span>
    size <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">)</span>
    mime_type <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">)</span>
    sha256 <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">)</span>
    uploaded_at <span class="token operator">=</span> Column<span class="token punctuation">(</span>DateTime<span class="token punctuation">,</span> default<span class="token operator">=</span>datetime<span class="token punctuation">.</span>utcnow<span class="token punctuation">)</span>
    uploaded_by <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> ForeignKey<span class="token punctuation">(</span><span class="token string">"users.id"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/upload-tracked"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">upload_with_tracking</span><span class="token punctuation">(</span>
    <span class="token builtin">file</span><span class="token punctuation">:</span> UploadFile <span class="token operator">=</span> File<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    current_user<span class="token punctuation">:</span> User <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_current_user<span class="token punctuation">)</span><span class="token punctuation">,</span>
    db<span class="token punctuation">:</span> AsyncSession <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_db<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Upload file and track in database"""</span>
    <span class="token keyword">if</span> <span class="token builtin">file</span><span class="token punctuation">.</span>content_type <span class="token keyword">not</span> <span class="token keyword">in</span> ALLOWED_MIME_TYPES<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>status_code<span class="token operator">=</span><span class="token number">400</span><span class="token punctuation">,</span> detail<span class="token operator">=</span><span class="token string">"Invalid MIME type"</span><span class="token punctuation">)</span>
    
    file_id <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>uuid<span class="token punctuation">.</span>uuid4<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    file_ext <span class="token operator">=</span> ALLOWED_MIME_TYPES<span class="token punctuation">[</span><span class="token builtin">file</span><span class="token punctuation">.</span>content_type<span class="token punctuation">]</span>
    safe_filename <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>file_id<span class="token punctuation">}</span></span><span class="token interpolation"><span class="token punctuation">{</span>file_ext<span class="token punctuation">}</span></span><span class="token string">"</span></span>
    file_path <span class="token operator">=</span> UPLOAD_DIR <span class="token operator">/</span> safe_filename
    
    size <span class="token operator">=</span> <span class="token number">0</span>
    file_hash <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>sha256<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">async</span> <span class="token keyword">with</span> aiofiles<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        <span class="token keyword">while</span> chunk <span class="token operator">:=</span> <span class="token keyword">await</span> <span class="token builtin">file</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">8192</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            size <span class="token operator">+=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span>
            <span class="token keyword">if</span> size <span class="token operator">></span> MAX_FILE_SIZE<span class="token punctuation">:</span>
                file_path<span class="token punctuation">.</span>unlink<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>status_code<span class="token operator">=</span><span class="token number">413</span><span class="token punctuation">,</span> detail<span class="token operator">=</span><span class="token string">"File too large"</span><span class="token punctuation">)</span>
            file_hash<span class="token punctuation">.</span>update<span class="token punctuation">(</span>chunk<span class="token punctuation">)</span>
            <span class="token keyword">await</span> f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>chunk<span class="token punctuation">)</span>
    
    <span class="token comment"># Save to database</span>
    file_record <span class="token operator">=</span> FileRecord<span class="token punctuation">(</span>
        <span class="token builtin">id</span><span class="token operator">=</span>file_id<span class="token punctuation">,</span>
        original_filename<span class="token operator">=</span><span class="token builtin">file</span><span class="token punctuation">.</span>filename<span class="token punctuation">,</span>
        stored_filename<span class="token operator">=</span>safe_filename<span class="token punctuation">,</span>
        size<span class="token operator">=</span>size<span class="token punctuation">,</span>
        mime_type<span class="token operator">=</span><span class="token builtin">file</span><span class="token punctuation">.</span>content_type<span class="token punctuation">,</span>
        sha256<span class="token operator">=</span>file_hash<span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        uploaded_by<span class="token operator">=</span>current_user<span class="token punctuation">.</span><span class="token builtin">id</span>
    <span class="token punctuation">)</span>
    db<span class="token punctuation">.</span>add<span class="token punctuation">(</span>file_record<span class="token punctuation">)</span>
    <span class="token keyword">await</span> db<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> db<span class="token punctuation">.</span>refresh<span class="token punctuation">(</span>file_record<span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token string">"id"</span><span class="token punctuation">:</span> file_record<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        <span class="token string">"filename"</span><span class="token punctuation">:</span> file_record<span class="token punctuation">.</span>original_filename<span class="token punctuation">,</span>
        <span class="token string">"size"</span><span class="token punctuation">:</span> file_record<span class="token punctuation">.</span>size<span class="token punctuation">,</span>
        <span class="token string">"sha256"</span><span class="token punctuation">:</span> file_record<span class="token punctuation">.</span>sha256
    <span class="token punctuation">}</span>
</code></pre>
<h3 id="s3-upload-with-presigned-urls-production-standard">S3 Upload with Presigned URLs (Production Standard)</h3>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token keyword">import</span> boto3
<span class="token keyword">from</span> botocore<span class="token punctuation">.</span>exceptions <span class="token keyword">import</span> ClientError

s3_client <span class="token operator">=</span> boto3<span class="token punctuation">.</span>client<span class="token punctuation">(</span>
    <span class="token string">'s3'</span><span class="token punctuation">,</span>
    aws_access_key_id<span class="token operator">=</span>settings<span class="token punctuation">.</span>AWS_ACCESS_KEY<span class="token punctuation">,</span>
    aws_secret_access_key<span class="token operator">=</span>settings<span class="token punctuation">.</span>AWS_SECRET_KEY<span class="token punctuation">,</span>
    region_name<span class="token operator">=</span>settings<span class="token punctuation">.</span>AWS_REGION
<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/get-upload-url"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_presigned_upload_url</span><span class="token punctuation">(</span>
    filename<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
    content_type<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
    current_user<span class="token punctuation">:</span> User <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_current_user<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Get presigned URL for client-side upload to S3"""</span>
    <span class="token keyword">if</span> content_type <span class="token keyword">not</span> <span class="token keyword">in</span> ALLOWED_MIME_TYPES<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>status_code<span class="token operator">=</span><span class="token number">400</span><span class="token punctuation">,</span> detail<span class="token operator">=</span><span class="token string">"Invalid MIME type"</span><span class="token punctuation">)</span>
    
    <span class="token comment"># Generate safe key</span>
    file_id <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>uuid<span class="token punctuation">.</span>uuid4<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    file_ext <span class="token operator">=</span> ALLOWED_MIME_TYPES<span class="token punctuation">[</span>content_type<span class="token punctuation">]</span>
    s3_key <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"uploads/</span><span class="token interpolation"><span class="token punctuation">{</span>current_user<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{</span>file_id<span class="token punctuation">}</span></span><span class="token interpolation"><span class="token punctuation">{</span>file_ext<span class="token punctuation">}</span></span><span class="token string">"</span></span>
    
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token comment"># Generate presigned POST URL (for browser upload)</span>
        response <span class="token operator">=</span> s3_client<span class="token punctuation">.</span>generate_presigned_post<span class="token punctuation">(</span>
            Bucket<span class="token operator">=</span>settings<span class="token punctuation">.</span>S3_BUCKET<span class="token punctuation">,</span>
            Key<span class="token operator">=</span>s3_key<span class="token punctuation">,</span>
            ExpiresIn<span class="token operator">=</span><span class="token number">3600</span><span class="token punctuation">,</span>  <span class="token comment"># 1 hour</span>
            Conditions<span class="token operator">=</span><span class="token punctuation">[</span>
                <span class="token punctuation">[</span><span class="token string">"content-length-range"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MAX_FILE_SIZE<span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token punctuation">[</span><span class="token string">"eq"</span><span class="token punctuation">,</span> <span class="token string">"$Content-Type"</span><span class="token punctuation">,</span> content_type<span class="token punctuation">]</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">)</span>
        
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            <span class="token string">"upload_url"</span><span class="token punctuation">:</span> response<span class="token punctuation">[</span><span class="token string">'url'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">"fields"</span><span class="token punctuation">:</span> response<span class="token punctuation">[</span><span class="token string">'fields'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">"file_id"</span><span class="token punctuation">:</span> file_id
        <span class="token punctuation">}</span>
    <span class="token keyword">except</span> ClientError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>status_code<span class="token operator">=</span><span class="token number">500</span><span class="token punctuation">,</span> detail<span class="token operator">=</span><span class="token string">"S3 error"</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/download-s3/{file_id}"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">download_from_s3</span><span class="token punctuation">(</span>
    file_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
    current_user<span class="token punctuation">:</span> User <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_current_user<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Get presigned download URL from S3"""</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        s3_key <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"uploads/</span><span class="token interpolation"><span class="token punctuation">{</span>current_user<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{</span>file_id<span class="token punctuation">}</span></span><span class="token string">.pdf"</span></span>  <span class="token comment"># Adjust ext as needed</span>
        
        download_url <span class="token operator">=</span> s3_client<span class="token punctuation">.</span>generate_presigned_url<span class="token punctuation">(</span>
            <span class="token string">'get_object'</span><span class="token punctuation">,</span>
            Params<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'Bucket'</span><span class="token punctuation">:</span> settings<span class="token punctuation">.</span>S3_BUCKET<span class="token punctuation">,</span> <span class="token string">'Key'</span><span class="token punctuation">:</span> s3_key<span class="token punctuation">}</span><span class="token punctuation">,</span>
            ExpiresIn<span class="token operator">=</span><span class="token number">3600</span>
        <span class="token punctuation">)</span>
        
        <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">"download_url"</span><span class="token punctuation">:</span> download_url<span class="token punctuation">}</span>
    <span class="token keyword">except</span> ClientError<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>status_code<span class="token operator">=</span><span class="token number">404</span><span class="token punctuation">,</span> detail<span class="token operator">=</span><span class="token string">"File not found"</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="security-checklist-for-file-handling">Security Checklist for File Handling</h3>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token comment"># ✅ DO THIS:</span>
<span class="token comment"># 1. Validate MIME type (don't trust Content-Type header alone)</span>
<span class="token comment"># 2. Generate safe filenames (UUIDs, not user input)</span>
<span class="token comment"># 3. Stream large files (not into memory)</span>
<span class="token comment"># 4. Set file size limits</span>
<span class="token comment"># 5. Use FileResponse for downloads</span>
<span class="token comment"># 6. Store in S3/cloud (not local disk in containers)</span>
<span class="token comment"># 7. Hash uploaded files (SHA256)</span>
<span class="token comment"># 8. Track uploads in database</span>
<span class="token comment"># 9. Delete stale uploads (cron job)</span>
<span class="token comment"># 10. Scan files with ClamAV/VirusTotal</span>

<span class="token comment"># ❌ DON'T DO THIS:</span>
<span class="token comment"># 1. Use user-provided filename directly</span>
<span class="token comment"># 2. Load entire file into memory</span>
<span class="token comment"># 3. Trust Content-Type header for validation</span>
<span class="token comment"># 4. Store uploads in container filesystem</span>
<span class="token comment"># 5. Serve files without Content-Disposition</span>
<span class="token comment"># 6. Allow arbitrary file extensions</span>
<span class="token comment"># 7. Skip virus scanning</span>
<span class="token comment"># 8. Forget to delete uploaded files</span>
</code></pre>
<h2 id="11-background-tasks---the-feature-everyone-abuses">11. Background Tasks - The Feature Everyone Abuses</h2>
<p>FastAPI’s <code>BackgroundTasks</code> is convenient but dangerous.</p>
<h3 id="when-backgroundtasks-is-fine">When BackgroundTasks is Fine</h3>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token keyword">from</span> fastapi <span class="token keyword">import</span> BackgroundTasks

<span class="token keyword">def</span> <span class="token function">send_welcome_email</span><span class="token punctuation">(</span>email<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Quick, idempotent operation</span>
    <span class="token comment"># Fails silently if email service is down</span>
    <span class="token keyword">pass</span>

<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/users"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">create_user</span><span class="token punctuation">(</span>
    user_data<span class="token punctuation">:</span> UserCreate<span class="token punctuation">,</span>
    background_tasks<span class="token punctuation">:</span> BackgroundTasks<span class="token punctuation">,</span>
    db<span class="token punctuation">:</span> AsyncSession <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_db<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    user <span class="token operator">=</span> <span class="token keyword">await</span> user_service<span class="token punctuation">.</span>create_user<span class="token punctuation">(</span>db<span class="token punctuation">,</span> user_data<span class="token punctuation">)</span>
    background_tasks<span class="token punctuation">.</span>add_task<span class="token punctuation">(</span>send_welcome_email<span class="token punctuation">,</span> user<span class="token punctuation">.</span>email<span class="token punctuation">)</span>
    <span class="token keyword">return</span> user
</code></pre>
<p><strong>Constraints:</strong></p>
<ul>
<li>Task completes in &#x3C;1 second</li>
<li>Failure is acceptable (no retry needed)</li>
<li>No DB access (session might be closed)</li>
</ul>
<h3 id="when-backgroundtasks-will-bite-you">When BackgroundTasks Will Bite You</h3>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token comment"># DISASTER waiting to happen</span>
<span class="token keyword">def</span> <span class="token function">generate_monthly_report</span><span class="token punctuation">(</span>user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Takes 45 seconds</span>
    <span class="token comment"># Needs database access</span>
    <span class="token comment"># Must retry on failure</span>
    <span class="token comment"># User expects to download this later</span>
    <span class="token keyword">pass</span>

<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/reports/generate"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">generate_report</span><span class="token punctuation">(</span>
    user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
    background_tasks<span class="token punctuation">:</span> BackgroundTasks
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># This will:</span>
    <span class="token comment"># 1. Block the worker for 45 seconds</span>
    <span class="token comment"># 2. Fail if worker restarts (no persistence)</span>
    <span class="token comment"># 3. Have no retry mechanism</span>
    <span class="token comment"># 4. Have no progress tracking</span>
    background_tasks<span class="token punctuation">.</span>add_task<span class="token punctuation">(</span>generate_monthly_report<span class="token punctuation">,</span> user_id<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"generating"</span><span class="token punctuation">}</span>
</code></pre>
<p><strong>Symptoms in production:</strong></p>
<ul>
<li>Workers blocked during deployments</li>
<li>“Where’s my report?” support tickets</li>
<li>Memory leaks from long-running background tasks</li>
</ul>
<h3 id="run_in_threadpool---the-middle-ground">run_in_threadpool - The Middle Ground</h3>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token keyword">from</span> starlette<span class="token punctuation">.</span>concurrency <span class="token keyword">import</span> run_in_threadpool

<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/process"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">process_file</span><span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">:</span> UploadFile<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># CPU-bound task that takes 5-10 seconds</span>
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        content <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token builtin">file</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
        result <span class="token operator">=</span> <span class="token keyword">await</span> run_in_threadpool<span class="token punctuation">(</span>expensive_processing<span class="token punctuation">,</span> content<span class="token punctuation">)</span>
        <span class="token keyword">return</span> result
    
    <span class="token comment"># Still blocks this worker, but doesn't block event loop</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> process<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p><strong>Good for:</strong></p>
<ul>
<li>CPU-bound tasks (5-30 seconds)</li>
<li>Don’t need retry/persistence</li>
<li>Can afford to block a worker</li>
</ul>
<h3 id="when-to-reach-for-celeryrqarq">When to Reach for Celery/RQ/Arq</h3>
<p>Use a real task queue when:</p>
<ul>
<li>Tasks take >30 seconds</li>
<li>Must survive worker restarts</li>
<li>Need retry logic</li>
<li>Need progress tracking</li>
<li>Tasks aren’t tied to HTTP request lifecycle</li>
</ul>
<p><strong>Celery setup:</strong></p>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token comment"># tasks/celery_app.py</span>
<span class="token keyword">from</span> celery <span class="token keyword">import</span> Celery

celery_app <span class="token operator">=</span> Celery<span class="token punctuation">(</span>
    <span class="token string">"myapp"</span><span class="token punctuation">,</span>
    broker<span class="token operator">=</span>settings<span class="token punctuation">.</span>REDIS_URL<span class="token punctuation">,</span>
    backend<span class="token operator">=</span>settings<span class="token punctuation">.</span>REDIS_URL
<span class="token punctuation">)</span>

celery_app<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>update<span class="token punctuation">(</span>
    task_serializer<span class="token operator">=</span><span class="token string">"json"</span><span class="token punctuation">,</span>
    accept_content<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"json"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    result_serializer<span class="token operator">=</span><span class="token string">"json"</span><span class="token punctuation">,</span>
    task_track_started<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    task_time_limit<span class="token operator">=</span><span class="token number">300</span><span class="token punctuation">,</span>     <span class="token comment"># 5 minute hard limit</span>
    task_soft_time_limit<span class="token operator">=</span><span class="token number">240</span>  <span class="token comment"># 4 minute soft limit</span>
<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@celery_app<span class="token punctuation">.</span>task</span><span class="token punctuation">(</span>bind<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> max_retries<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">generate_report</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token comment"># Long-running task logic</span>
        <span class="token keyword">pass</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> exc<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> self<span class="token punctuation">.</span>retry<span class="token punctuation">(</span>exc<span class="token operator">=</span>exc<span class="token punctuation">,</span> countdown<span class="token operator">=</span><span class="token number">60</span><span class="token punctuation">)</span>
</code></pre>
<p><strong>In FastAPI:</strong></p>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token keyword">from</span> <span class="token punctuation">.</span>tasks<span class="token punctuation">.</span>celery_app <span class="token keyword">import</span> generate_report

<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/reports/generate"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">create_report</span><span class="token punctuation">(</span>user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    task <span class="token operator">=</span> generate_report<span class="token punctuation">.</span>delay<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">"task_id"</span><span class="token punctuation">:</span> task<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span> <span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"queued"</span><span class="token punctuation">}</span>

<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/reports/status/{task_id}"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_report_status</span><span class="token punctuation">(</span>task_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    task <span class="token operator">=</span> generate_report<span class="token punctuation">.</span>AsyncResult<span class="token punctuation">(</span>task_id<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token string">"task_id"</span><span class="token punctuation">:</span> task_id<span class="token punctuation">,</span>
        <span class="token string">"status"</span><span class="token punctuation">:</span> task<span class="token punctuation">.</span>state<span class="token punctuation">,</span>
        <span class="token string">"result"</span><span class="token punctuation">:</span> task<span class="token punctuation">.</span>result <span class="token keyword">if</span> task<span class="token punctuation">.</span>ready<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token boolean">None</span>
    <span class="token punctuation">}</span>
</code></pre>
<p><strong>Arq (async-native alternative):</strong></p>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token comment"># tasks/arq_worker.py</span>
<span class="token keyword">from</span> arq <span class="token keyword">import</span> create_pool
<span class="token keyword">from</span> arq<span class="token punctuation">.</span>connections <span class="token keyword">import</span> RedisSettings

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">generate_report</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Async task logic</span>
    <span class="token keyword">pass</span>

<span class="token keyword">class</span> <span class="token class-name">WorkerSettings</span><span class="token punctuation">:</span>
    functions <span class="token operator">=</span> <span class="token punctuation">[</span>generate_report<span class="token punctuation">]</span>
    redis_settings <span class="token operator">=</span> RedisSettings<span class="token punctuation">(</span>host<span class="token operator">=</span>settings<span class="token punctuation">.</span>REDIS_HOST<span class="token punctuation">)</span>
    max_jobs <span class="token operator">=</span> <span class="token number">10</span>
    job_timeout <span class="token operator">=</span> <span class="token number">300</span>

<span class="token comment"># In FastAPI</span>
<span class="token keyword">from</span> arq <span class="token keyword">import</span> create_pool

<span class="token decorator annotation punctuation">@asynccontextmanager</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">lifespan</span><span class="token punctuation">(</span>app<span class="token punctuation">:</span> FastAPI<span class="token punctuation">)</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>state<span class="token punctuation">.</span>arq <span class="token operator">=</span> <span class="token keyword">await</span> create_pool<span class="token punctuation">(</span>RedisSettings<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">yield</span>
    <span class="token keyword">await</span> app<span class="token punctuation">.</span>state<span class="token punctuation">.</span>arq<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/reports/generate"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">create_report</span><span class="token punctuation">(</span>request<span class="token punctuation">:</span> Request<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    job <span class="token operator">=</span> <span class="token keyword">await</span> request<span class="token punctuation">.</span>app<span class="token punctuation">.</span>state<span class="token punctuation">.</span>arq<span class="token punctuation">.</span>enqueue_job<span class="token punctuation">(</span><span class="token string">"generate_report"</span><span class="token punctuation">,</span> user_id<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">"job_id"</span><span class="token punctuation">:</span> job<span class="token punctuation">.</span>job_id<span class="token punctuation">}</span>
</code></pre>
<p><strong>Decision matrix:</strong></p>





























<table><thead><tr><th>Scenario</th><th>Solution</th></tr></thead><tbody><tr><td>Send email on signup</td><td>BackgroundTasks</td></tr><tr><td>Resize uploaded image (2s)</td><td>run_in_threadpool</td></tr><tr><td>Generate PDF report (30s)</td><td>Celery/Arq</td></tr><tr><td>Process video (5 min)</td><td>Celery/Arq</td></tr><tr><td>Daily batch job</td><td>Celery Beat/Arq cron</td></tr></tbody></table>
<h2 id="12-websockets-at-scale---dont-do-what-we-did-first">12. WebSockets at Scale - Don’t Do What We Did First</h2>
<p>WebSockets in FastAPI are easy to start, catastrophic at scale without the right architecture.</p>
<h3 id="the-naive-approach-works-until-1000-connections">The Naive Approach (Works Until ~1000 Connections)</h3>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token keyword">from</span> fastapi <span class="token keyword">import</span> WebSocket

connections<span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">[</span>WebSocket<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>websocket</span><span class="token punctuation">(</span><span class="token string">"/ws"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">websocket_endpoint</span><span class="token punctuation">(</span>websocket<span class="token punctuation">:</span> WebSocket<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>
    connections<span class="token punctuation">.</span>append<span class="token punctuation">(</span>websocket<span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            data <span class="token operator">=</span> <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>receive_text<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment"># Broadcast to all connections</span>
            <span class="token keyword">for</span> connection <span class="token keyword">in</span> connections<span class="token punctuation">:</span>
                <span class="token keyword">await</span> connection<span class="token punctuation">.</span>send_text<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Message: </span><span class="token interpolation"><span class="token punctuation">{</span>data<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        connections<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>websocket<span class="token punctuation">)</span>
</code></pre>
<p><strong>What breaks at scale:</strong></p>
<ul>
<li>All connections are in one worker’s memory</li>
<li>No persistence (connections lost on deploy)</li>
<li>Broadcasting blocks (O(n) send operations)</li>
<li>No backpressure handling</li>
</ul>
<p><strong>Real disaster:</strong> We deployed this to production. At 800 concurrent WebSocket connections, memory usage hit 2.4GB per worker. During deployment, all 800 users got disconnected simultaneously. Support tickets went from 2/day to 47/hour.</p>
<h3 id="connection-limits-reality">Connection Limits Reality</h3>
<p>On AWS c6i.2xlarge (8 vCPU, 16GB RAM) with Uvicorn:</p>









































<table><thead><tr><th>Connections</th><th>Memory/Worker</th><th>CPU%</th><th>Notes</th></tr></thead><tbody><tr><td>100</td><td>220MB</td><td>5%</td><td>Fine</td></tr><tr><td>500</td><td>580MB</td><td>12%</td><td>Still okay</td></tr><tr><td>1,000</td><td>1.1GB</td><td>28%</td><td>Starting to sweat</td></tr><tr><td>5,000</td><td>4.8GB</td><td>75%</td><td>One worker maxed out</td></tr><tr><td>10,000</td><td>Worker OOM</td><td>N/A</td><td>Crashes</td></tr></tbody></table>
<p><strong>Theoretical max:</strong> ~6,000 connections per worker before memory pressure kills you.</p>
<h3 id="redis-pubsub-pattern-production-setup">Redis Pub/Sub Pattern (Production Setup)</h3>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> redis<span class="token punctuation">.</span>asyncio <span class="token keyword">as</span> redis
<span class="token keyword">from</span> fastapi <span class="token keyword">import</span> WebSocket<span class="token punctuation">,</span> WebSocketDisconnect
<span class="token keyword">from</span> typing <span class="token keyword">import</span> Dict<span class="token punctuation">,</span> Set

<span class="token keyword">class</span> <span class="token class-name">ConnectionManager</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>active_connections<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Set<span class="token punctuation">[</span>WebSocket<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        self<span class="token punctuation">.</span>redis_client<span class="token punctuation">:</span> redis<span class="token punctuation">.</span>Redis <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>pubsub <span class="token operator">=</span> <span class="token boolean">None</span>
    
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">connect</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> websocket<span class="token punctuation">:</span> WebSocket<span class="token punctuation">,</span> room<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> room <span class="token keyword">not</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>active_connections<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>active_connections<span class="token punctuation">[</span>room<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>active_connections<span class="token punctuation">[</span>room<span class="token punctuation">]</span><span class="token punctuation">.</span>add<span class="token punctuation">(</span>websocket<span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">disconnect</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> websocket<span class="token punctuation">:</span> WebSocket<span class="token punctuation">,</span> room<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>active_connections<span class="token punctuation">[</span>room<span class="token punctuation">]</span><span class="token punctuation">.</span>discard<span class="token punctuation">(</span>websocket<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>active_connections<span class="token punctuation">[</span>room<span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token keyword">del</span> self<span class="token punctuation">.</span>active_connections<span class="token punctuation">[</span>room<span class="token punctuation">]</span>
    
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">broadcast_to_room</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> room<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> message<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Send to all connections in this worker for this room"""</span>
        <span class="token keyword">if</span> room <span class="token keyword">in</span> self<span class="token punctuation">.</span>active_connections<span class="token punctuation">:</span>
            dead_connections <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> connection <span class="token keyword">in</span> self<span class="token punctuation">.</span>active_connections<span class="token punctuation">[</span>room<span class="token punctuation">]</span><span class="token punctuation">:</span>
                <span class="token keyword">try</span><span class="token punctuation">:</span>
                    <span class="token keyword">await</span> connection<span class="token punctuation">.</span>send_text<span class="token punctuation">(</span>message<span class="token punctuation">)</span>
                <span class="token keyword">except</span><span class="token punctuation">:</span>
                    dead_connections<span class="token punctuation">.</span>add<span class="token punctuation">(</span>connection<span class="token punctuation">)</span>
            
            <span class="token comment"># Clean up dead connections</span>
            <span class="token keyword">for</span> connection <span class="token keyword">in</span> dead_connections<span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>active_connections<span class="token punctuation">[</span>room<span class="token punctuation">]</span><span class="token punctuation">.</span>discard<span class="token punctuation">(</span>connection<span class="token punctuation">)</span>
    
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">publish</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> room<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> message<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Publish to Redis, reaches all workers"""</span>
        <span class="token keyword">await</span> self<span class="token punctuation">.</span>redis_client<span class="token punctuation">.</span>publish<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"room:</span><span class="token interpolation"><span class="token punctuation">{</span>room<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span> message<span class="token punctuation">)</span>
    
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">start_listening</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Background task to listen for Redis pub/sub messages"""</span>
        self<span class="token punctuation">.</span>redis_client <span class="token operator">=</span> <span class="token keyword">await</span> redis<span class="token punctuation">.</span>from_url<span class="token punctuation">(</span>settings<span class="token punctuation">.</span>REDIS_URL<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>pubsub <span class="token operator">=</span> self<span class="token punctuation">.</span>redis_client<span class="token punctuation">.</span>pubsub<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">await</span> self<span class="token punctuation">.</span>pubsub<span class="token punctuation">.</span>psubscribe<span class="token punctuation">(</span><span class="token string">"room:*"</span><span class="token punctuation">)</span>
        
        <span class="token keyword">async</span> <span class="token keyword">for</span> message <span class="token keyword">in</span> self<span class="token punctuation">.</span>pubsub<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> message<span class="token punctuation">[</span><span class="token string">"type"</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"pmessage"</span><span class="token punctuation">:</span>
                channel <span class="token operator">=</span> message<span class="token punctuation">[</span><span class="token string">"channel"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>
                room <span class="token operator">=</span> channel<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
                data <span class="token operator">=</span> message<span class="token punctuation">[</span><span class="token string">"data"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">await</span> self<span class="token punctuation">.</span>broadcast_to_room<span class="token punctuation">(</span>room<span class="token punctuation">,</span> data<span class="token punctuation">)</span>

manager <span class="token operator">=</span> ConnectionManager<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@asynccontextmanager</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">lifespan</span><span class="token punctuation">(</span>app<span class="token punctuation">:</span> FastAPI<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Start Redis listener</span>
    task <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>manager<span class="token punctuation">.</span>start_listening<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">yield</span>
    <span class="token comment"># Cleanup</span>
    task<span class="token punctuation">.</span>cancel<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> manager<span class="token punctuation">.</span>pubsub<span class="token punctuation">:</span>
        <span class="token keyword">await</span> manager<span class="token punctuation">.</span>pubsub<span class="token punctuation">.</span>unsubscribe<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> manager<span class="token punctuation">.</span>redis_client<span class="token punctuation">:</span>
        <span class="token keyword">await</span> manager<span class="token punctuation">.</span>redis_client<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

app <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span>lifespan<span class="token operator">=</span>lifespan<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>websocket</span><span class="token punctuation">(</span><span class="token string">"/ws/{room}"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">websocket_endpoint</span><span class="token punctuation">(</span>websocket<span class="token punctuation">:</span> WebSocket<span class="token punctuation">,</span> room<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">await</span> manager<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>websocket<span class="token punctuation">,</span> room<span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            data <span class="token operator">=</span> <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>receive_text<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment"># Publish to Redis, broadcasts to ALL workers</span>
            <span class="token keyword">await</span> manager<span class="token punctuation">.</span>publish<span class="token punctuation">(</span>room<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
    <span class="token keyword">except</span> WebSocketDisconnect<span class="token punctuation">:</span>
        manager<span class="token punctuation">.</span>disconnect<span class="token punctuation">(</span>websocket<span class="token punctuation">,</span> room<span class="token punctuation">)</span>
</code></pre>
<p><strong>This scales to:</strong></p>
<ul>
<li>50,000+ connections (distributed across workers)</li>
<li>Horizontal scaling (add more servers, Redis handles coordination)</li>
<li>Survives deploys (clients reconnect, state in Redis)</li>
</ul>
<h3 id="backpressure-and-dead-connection-cleanup">Backpressure and Dead Connection Cleanup</h3>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">send_with_backpressure</span><span class="token punctuation">(</span>websocket<span class="token punctuation">:</span> WebSocket<span class="token punctuation">,</span> message<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> timeout<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> <span class="token number">5.0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Send with timeout to prevent slow clients from blocking"""</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>wait_for<span class="token punctuation">(</span>
            websocket<span class="token punctuation">.</span>send_text<span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">,</span>
            timeout<span class="token operator">=</span>timeout
        <span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">True</span>
    <span class="token keyword">except</span> asyncio<span class="token punctuation">.</span>TimeoutError<span class="token punctuation">:</span>
        <span class="token comment"># Client too slow, drop the connection</span>
        <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>close<span class="token punctuation">(</span>code<span class="token operator">=</span><span class="token number">1008</span><span class="token punctuation">,</span> reason<span class="token operator">=</span><span class="token string">"Client too slow"</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>

<span class="token comment"># In ConnectionManager</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">broadcast_to_room</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> room<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> message<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> room <span class="token keyword">in</span> self<span class="token punctuation">.</span>active_connections<span class="token punctuation">:</span>
        tasks <span class="token operator">=</span> <span class="token punctuation">[</span>
            send_with_backpressure<span class="token punctuation">(</span>conn<span class="token punctuation">,</span> message<span class="token punctuation">)</span>
            <span class="token keyword">for</span> conn <span class="token keyword">in</span> self<span class="token punctuation">.</span>active_connections<span class="token punctuation">[</span>room<span class="token punctuation">]</span>
        <span class="token punctuation">]</span>
        results <span class="token operator">=</span> <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>gather<span class="token punctuation">(</span><span class="token operator">*</span>tasks<span class="token punctuation">,</span> return_exceptions<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        
        <span class="token comment"># Remove failed connections</span>
        failed <span class="token operator">=</span> <span class="token punctuation">[</span>
            conn <span class="token keyword">for</span> conn<span class="token punctuation">,</span> success <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>active_connections<span class="token punctuation">[</span>room<span class="token punctuation">]</span><span class="token punctuation">,</span> results<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> success
        <span class="token punctuation">]</span>
        <span class="token keyword">for</span> conn <span class="token keyword">in</span> failed<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>active_connections<span class="token punctuation">[</span>room<span class="token punctuation">]</span><span class="token punctuation">.</span>discard<span class="token punctuation">(</span>conn<span class="token punctuation">)</span>
</code></pre>
<p><strong>GCP e2-standard-4 numbers (4 vCPU, 16GB RAM, 4 workers):</strong></p>
<ul>
<li>12,000 concurrent WebSocket connections</li>
<li>~300ms p99 broadcast latency (100-byte message)</li>
<li>680MB memory per worker</li>
</ul>
<h2 id="13-openapi-redoc-and-stopping-the-but-the-docs-say-arguments">13. OpenAPI, Redoc, and Stopping the “But the docs say…” Arguments</h2>
<p>FastAPI’s auto-generated docs are great until you need custom examples, deprecation warnings, or multiple API versions.</p>
<h3 id="custom-openapi-spec">Custom OpenAPI Spec</h3>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token keyword">from</span> fastapi<span class="token punctuation">.</span>openapi<span class="token punctuation">.</span>utils <span class="token keyword">import</span> get_openapi

<span class="token keyword">def</span> <span class="token function">custom_openapi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> app<span class="token punctuation">.</span>openapi_schema<span class="token punctuation">:</span>
        <span class="token keyword">return</span> app<span class="token punctuation">.</span>openapi_schema
    
    openapi_schema <span class="token operator">=</span> get_openapi<span class="token punctuation">(</span>
        title<span class="token operator">=</span><span class="token string">"My API"</span><span class="token punctuation">,</span>
        version<span class="token operator">=</span><span class="token string">"2.1.0"</span><span class="token punctuation">,</span>
        description<span class="token operator">=</span><span class="token triple-quoted-string string">"""
        Production API for MyApp.
        
        ## Authentication
        All endpoints require Bearer token in Authorization header.
        
        ## Rate Limits
        - 100 requests/minute per IP
        - 1000 requests/hour per API key
        
        ## Support
        Issues: https://github.com/myorg/myapp/issues
        """</span><span class="token punctuation">,</span>
        routes<span class="token operator">=</span>app<span class="token punctuation">.</span>routes<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    
    <span class="token comment"># Add security schemes</span>
    openapi_schema<span class="token punctuation">[</span><span class="token string">"components"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"securitySchemes"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">"BearerAuth"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"http"</span><span class="token punctuation">,</span>
            <span class="token string">"scheme"</span><span class="token punctuation">:</span> <span class="token string">"bearer"</span><span class="token punctuation">,</span>
            <span class="token string">"bearerFormat"</span><span class="token punctuation">:</span> <span class="token string">"JWT"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment"># Add global security requirement</span>
    openapi_schema<span class="token punctuation">[</span><span class="token string">"security"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"BearerAuth"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
    
    <span class="token comment"># Custom server URLs</span>
    openapi_schema<span class="token punctuation">[</span><span class="token string">"servers"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span><span class="token string">"url"</span><span class="token punctuation">:</span> <span class="token string">"https://api.myapp.com"</span><span class="token punctuation">,</span> <span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"Production"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"url"</span><span class="token punctuation">:</span> <span class="token string">"https://staging-api.myapp.com"</span><span class="token punctuation">,</span> <span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"Staging"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"url"</span><span class="token punctuation">:</span> <span class="token string">"http://localhost:8000"</span><span class="token punctuation">,</span> <span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"Development"</span><span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
    
    app<span class="token punctuation">.</span>openapi_schema <span class="token operator">=</span> openapi_schema
    <span class="token keyword">return</span> app<span class="token punctuation">.</span>openapi_schema

app<span class="token punctuation">.</span>openapi <span class="token operator">=</span> custom_openapi
</code></pre>
<h3 id="rich-response-examples">Rich Response Examples</h3>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token keyword">from</span> pydantic <span class="token keyword">import</span> BaseModel<span class="token punctuation">,</span> Field

<span class="token keyword">class</span> <span class="token class-name">UserResponse</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token builtin">id</span><span class="token punctuation">:</span> <span class="token builtin">int</span>
    email<span class="token punctuation">:</span> <span class="token builtin">str</span>
    full_name<span class="token punctuation">:</span> <span class="token builtin">str</span>
    is_active<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>description<span class="token operator">=</span><span class="token string">"Whether the user account is active"</span><span class="token punctuation">)</span>
    
    model_config <span class="token operator">=</span> ConfigDict<span class="token punctuation">(</span>
        json_schema_extra<span class="token operator">=</span><span class="token punctuation">{</span>
            <span class="token string">"examples"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{</span>
                    <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token number">123</span><span class="token punctuation">,</span>
                    <span class="token string">"email"</span><span class="token punctuation">:</span> <span class="token string">"jane@example.com"</span><span class="token punctuation">,</span>
                    <span class="token string">"full_name"</span><span class="token punctuation">:</span> <span class="token string">"Jane Doe"</span><span class="token punctuation">,</span>
                    <span class="token string">"is_active"</span><span class="token punctuation">:</span> <span class="token boolean">True</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span>
    <span class="token string">"/users/{user_id}"</span><span class="token punctuation">,</span>
    response_model<span class="token operator">=</span>UserResponse<span class="token punctuation">,</span>
    responses<span class="token operator">=</span><span class="token punctuation">{</span>
        <span class="token number">200</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"User found"</span><span class="token punctuation">,</span>
            <span class="token string">"content"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                <span class="token string">"application/json"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                    <span class="token string">"example"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                        <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token number">123</span><span class="token punctuation">,</span>
                        <span class="token string">"email"</span><span class="token punctuation">:</span> <span class="token string">"jane@example.com"</span><span class="token punctuation">,</span>
                        <span class="token string">"full_name"</span><span class="token punctuation">:</span> <span class="token string">"Jane Doe"</span><span class="token punctuation">,</span>
                        <span class="token string">"is_active"</span><span class="token punctuation">:</span> <span class="token boolean">True</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token number">404</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"User not found"</span><span class="token punctuation">,</span>
            <span class="token string">"content"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                <span class="token string">"application/json"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                    <span class="token string">"example"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"detail"</span><span class="token punctuation">:</span> <span class="token string">"User not found"</span><span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_user</span><span class="token punctuation">(</span>user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span>
</code></pre>
<h3 id="painless-api-versioning">Painless API Versioning</h3>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token comment"># api/v1/users.py</span>
<span class="token keyword">from</span> fastapi <span class="token keyword">import</span> APIRouter

router <span class="token operator">=</span> APIRouter<span class="token punctuation">(</span>prefix<span class="token operator">=</span><span class="token string">"/users"</span><span class="token punctuation">,</span> tags<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"users-v1"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/{user_id}"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_user_v1</span><span class="token punctuation">(</span>user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Old implementation</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">"id"</span><span class="token punctuation">:</span> user_id<span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"User"</span><span class="token punctuation">}</span>

<span class="token comment"># api/v2/users.py</span>
router <span class="token operator">=</span> APIRouter<span class="token punctuation">(</span>
    prefix<span class="token operator">=</span><span class="token string">"/users"</span><span class="token punctuation">,</span>
    tags<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"users-v2"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    deprecated<span class="token operator">=</span><span class="token boolean">False</span>  <span class="token comment"># Mark v1 as deprecated once v2 is stable</span>
<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/{user_id}"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_user_v2</span><span class="token punctuation">(</span>user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># New implementation with additional fields</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token string">"id"</span><span class="token punctuation">:</span> user_id<span class="token punctuation">,</span>
        <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"User"</span><span class="token punctuation">,</span>
        <span class="token string">"created_at"</span><span class="token punctuation">:</span> <span class="token string">"2025-01-01T00:00:00Z"</span><span class="token punctuation">,</span>
        <span class="token string">"updated_at"</span><span class="token punctuation">:</span> <span class="token string">"2025-01-01T00:00:00Z"</span>
    <span class="token punctuation">}</span>

<span class="token comment"># main.py</span>
<span class="token keyword">from</span> api<span class="token punctuation">.</span>v1 <span class="token keyword">import</span> users <span class="token keyword">as</span> users_v1
<span class="token keyword">from</span> api<span class="token punctuation">.</span>v2 <span class="token keyword">import</span> users <span class="token keyword">as</span> users_v2

app<span class="token punctuation">.</span>include_router<span class="token punctuation">(</span>users_v1<span class="token punctuation">.</span>router<span class="token punctuation">,</span> prefix<span class="token operator">=</span><span class="token string">"/api/v1"</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span>include_router<span class="token punctuation">(</span>users_v2<span class="token punctuation">.</span>router<span class="token punctuation">,</span> prefix<span class="token operator">=</span><span class="token string">"/api/v2"</span><span class="token punctuation">)</span>
</code></pre>
<p><strong>Deprecation workflow:</strong></p>
<ol>
<li>Ship v2 alongside v1</li>
<li>Add deprecation warnings to v1 OpenAPI schema</li>
<li>Monitor v1 usage metrics</li>
<li>Send emails to API consumers using v1</li>
<li>Sunset v1 after 6 months</li>
</ol>
<h3 id="hiding-docs-in-production">Hiding Docs in Production</h3>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python">app <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span>
    docs_url<span class="token operator">=</span><span class="token string">"/api/docs"</span> <span class="token keyword">if</span> settings<span class="token punctuation">.</span>ENVIRONMENT <span class="token operator">!=</span> <span class="token string">"production"</span> <span class="token keyword">else</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    redoc_url<span class="token operator">=</span><span class="token string">"/api/redoc"</span> <span class="token keyword">if</span> settings<span class="token punctuation">.</span>ENVIRONMENT <span class="token operator">!=</span> <span class="token string">"production"</span> <span class="token keyword">else</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    openapi_url<span class="token operator">=</span><span class="token string">"/api/openapi.json"</span> <span class="token keyword">if</span> settings<span class="token punctuation">.</span>ENVIRONMENT <span class="token operator">!=</span> <span class="token string">"production"</span> <span class="token keyword">else</span> <span class="token boolean">None</span>
<span class="token punctuation">)</span>

<span class="token comment"># Or with authentication:</span>
<span class="token keyword">from</span> fastapi <span class="token keyword">import</span> Depends<span class="token punctuation">,</span> HTTPException
<span class="token keyword">from</span> fastapi<span class="token punctuation">.</span>openapi<span class="token punctuation">.</span>docs <span class="token keyword">import</span> get_swagger_ui_html

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/api/docs"</span><span class="token punctuation">,</span> include_in_schema<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">custom_docs</span><span class="token punctuation">(</span>admin<span class="token punctuation">:</span> User <span class="token operator">=</span> Depends<span class="token punctuation">(</span>require_admin<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> get_swagger_ui_html<span class="token punctuation">(</span>openapi_url<span class="token operator">=</span><span class="token string">"/api/openapi.json"</span><span class="token punctuation">,</span> title<span class="token operator">=</span><span class="token string">"API Docs"</span><span class="token punctuation">)</span>
</code></pre>
<h2 id="14-testing-strategy-that-scales">14. Testing Strategy That Scales</h2>
<h3 id="httpx-vs-testclient---the-right-choice">httpx vs TestClient - The Right Choice</h3>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token comment"># BAD: TestClient is synchronous</span>
<span class="token keyword">from</span> fastapi<span class="token punctuation">.</span>testclient <span class="token keyword">import</span> TestClient

<span class="token keyword">def</span> <span class="token function">test_get_user</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    client <span class="token operator">=</span> TestClient<span class="token punctuation">(</span>app<span class="token punctuation">)</span>
    response <span class="token operator">=</span> client<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"/users/1"</span><span class="token punctuation">)</span>
    <span class="token keyword">assert</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span>

<span class="token comment"># GOOD: httpx.AsyncClient works with real async</span>
<span class="token keyword">import</span> pytest
<span class="token keyword">from</span> httpx <span class="token keyword">import</span> AsyncClient<span class="token punctuation">,</span> ASGITransport

<span class="token decorator annotation punctuation">@pytest<span class="token punctuation">.</span>mark<span class="token punctuation">.</span>asyncio</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">test_get_user</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">async</span> <span class="token keyword">with</span> AsyncClient<span class="token punctuation">(</span>
        transport<span class="token operator">=</span>ASGITransport<span class="token punctuation">(</span>app<span class="token operator">=</span>app<span class="token punctuation">)</span><span class="token punctuation">,</span>
        base_url<span class="token operator">=</span><span class="token string">"http://test"</span>
    <span class="token punctuation">)</span> <span class="token keyword">as</span> client<span class="token punctuation">:</span>
        response <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"/users/1"</span><span class="token punctuation">)</span>
        <span class="token keyword">assert</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span>
</code></pre>
<p><strong>Why httpx wins:</strong></p>
<ul>
<li>Tests actual async code paths</li>
<li>Catches async/sync mixing bugs</li>
<li>Same client you use in production</li>
<li>Faster (no thread pool overhead)</li>
</ul>
<h3 id="non-flaky-async-tests">Non-Flaky Async Tests</h3>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token comment"># conftest.py</span>
<span class="token keyword">import</span> pytest
<span class="token keyword">import</span> asyncio
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>ext<span class="token punctuation">.</span>asyncio <span class="token keyword">import</span> create_async_engine<span class="token punctuation">,</span> async_sessionmaker

<span class="token decorator annotation punctuation">@pytest<span class="token punctuation">.</span>fixture</span><span class="token punctuation">(</span>scope<span class="token operator">=</span><span class="token string">"session"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">event_loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Create event loop for entire test session"""</span>
    loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop_policy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>new_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">yield</span> loop
    loop<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@pytest<span class="token punctuation">.</span>fixture</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">db_session</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Fresh database session per test"""</span>
    engine <span class="token operator">=</span> create_async_engine<span class="token punctuation">(</span>
        <span class="token string">"postgresql+asyncpg://test:test@localhost/test_db"</span><span class="token punctuation">,</span>
        echo<span class="token operator">=</span><span class="token boolean">False</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">async</span> <span class="token keyword">with</span> engine<span class="token punctuation">.</span>begin<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> conn<span class="token punctuation">:</span>
        <span class="token keyword">await</span> conn<span class="token punctuation">.</span>run_sync<span class="token punctuation">(</span>Base<span class="token punctuation">.</span>metadata<span class="token punctuation">.</span>drop_all<span class="token punctuation">)</span>
        <span class="token keyword">await</span> conn<span class="token punctuation">.</span>run_sync<span class="token punctuation">(</span>Base<span class="token punctuation">.</span>metadata<span class="token punctuation">.</span>create_all<span class="token punctuation">)</span>
    
    AsyncSessionLocal <span class="token operator">=</span> async_sessionmaker<span class="token punctuation">(</span>engine<span class="token punctuation">,</span> expire_on_commit<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    <span class="token keyword">async</span> <span class="token keyword">with</span> AsyncSessionLocal<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> session<span class="token punctuation">:</span>
        <span class="token keyword">yield</span> session
    
    <span class="token keyword">await</span> engine<span class="token punctuation">.</span>dispose<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@pytest<span class="token punctuation">.</span>fixture</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">client</span><span class="token punctuation">(</span>db_session<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Test client with mocked dependencies"""</span>
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">override_get_db</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">yield</span> db_session
    
    app<span class="token punctuation">.</span>dependency_overrides<span class="token punctuation">[</span>get_db<span class="token punctuation">]</span> <span class="token operator">=</span> override_get_db
    
    <span class="token keyword">async</span> <span class="token keyword">with</span> AsyncClient<span class="token punctuation">(</span>
        transport<span class="token operator">=</span>ASGITransport<span class="token punctuation">(</span>app<span class="token operator">=</span>app<span class="token punctuation">)</span><span class="token punctuation">,</span>
        base_url<span class="token operator">=</span><span class="token string">"http://test"</span>
    <span class="token punctuation">)</span> <span class="token keyword">as</span> ac<span class="token punctuation">:</span>
        <span class="token keyword">yield</span> ac
    
    app<span class="token punctuation">.</span>dependency_overrides<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># test_users.py</span>
<span class="token decorator annotation punctuation">@pytest<span class="token punctuation">.</span>mark<span class="token punctuation">.</span>asyncio</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">test_create_user</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> db_session<span class="token punctuation">)</span><span class="token punctuation">:</span>
    response <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span>post<span class="token punctuation">(</span>
        <span class="token string">"/api/v1/users"</span><span class="token punctuation">,</span>
        json<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"email"</span><span class="token punctuation">:</span> <span class="token string">"test@example.com"</span><span class="token punctuation">,</span> <span class="token string">"password"</span><span class="token punctuation">:</span> <span class="token string">"Secret123"</span><span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">assert</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">201</span>
    
    <span class="token comment"># Verify in database</span>
    result <span class="token operator">=</span> <span class="token keyword">await</span> db_session<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>
        select<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>User<span class="token punctuation">.</span>email <span class="token operator">==</span> <span class="token string">"test@example.com"</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    user <span class="token operator">=</span> result<span class="token punctuation">.</span>scalar_one<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">assert</span> user<span class="token punctuation">.</span>email <span class="token operator">==</span> <span class="token string">"test@example.com"</span>
</code></pre>
<h3 id="schemathesis-contract-testing">Schemathesis Contract Testing</h3>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token keyword">import</span> schemathesis
<span class="token keyword">from</span> hypothesis <span class="token keyword">import</span> settings

schema <span class="token operator">=</span> schemathesis<span class="token punctuation">.</span>from_asgi<span class="token punctuation">(</span><span class="token string">"/api/openapi.json"</span><span class="token punctuation">,</span> app<span class="token operator">=</span>app<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@schema<span class="token punctuation">.</span>parametrize</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator annotation punctuation">@settings</span><span class="token punctuation">(</span>max_examples<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">test_api_contract</span><span class="token punctuation">(</span><span class="token keyword">case</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Property-based testing against OpenAPI spec"""</span>
    response <span class="token operator">=</span> <span class="token keyword">case</span><span class="token punctuation">.</span>call_asgi<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">case</span><span class="token punctuation">.</span>validate_response<span class="token punctuation">(</span>response<span class="token punctuation">)</span>

<span class="token comment"># This automatically:</span>
<span class="token comment"># - Generates random valid inputs</span>
<span class="token comment"># - Tests all endpoints</span>
<span class="token comment"># - Validates responses match schema</span>
<span class="token comment"># - Catches edge cases you'd never think of</span>
</code></pre>
<p><strong>Real bug this caught:</strong> We had an endpoint that returned <code>user_id</code> as string in one code path, int in another. Schemathesis found it in 12 examples.</p>
<h3 id="integration-tests-worth-writing">Integration Tests Worth Writing</h3>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token decorator annotation punctuation">@pytest<span class="token punctuation">.</span>mark<span class="token punctuation">.</span>asyncio</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">test_user_flow_end_to_end</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Test complete user journey"""</span>
    <span class="token comment"># 1. Register</span>
    response <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span>post<span class="token punctuation">(</span><span class="token string">"/api/v1/auth/register"</span><span class="token punctuation">,</span> json<span class="token operator">=</span><span class="token punctuation">{</span>
        <span class="token string">"email"</span><span class="token punctuation">:</span> <span class="token string">"newuser@example.com"</span><span class="token punctuation">,</span>
        <span class="token string">"password"</span><span class="token punctuation">:</span> <span class="token string">"Secret123"</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">assert</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">201</span>
    
    <span class="token comment"># 2. Login</span>
    response <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span>post<span class="token punctuation">(</span><span class="token string">"/api/v1/auth/login"</span><span class="token punctuation">,</span> json<span class="token operator">=</span><span class="token punctuation">{</span>
        <span class="token string">"email"</span><span class="token punctuation">:</span> <span class="token string">"newuser@example.com"</span><span class="token punctuation">,</span>
        <span class="token string">"password"</span><span class="token punctuation">:</span> <span class="token string">"Secret123"</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">assert</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span>
    token <span class="token operator">=</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"access_token"</span><span class="token punctuation">]</span>
    
    <span class="token comment"># 3. Access protected endpoint</span>
    response <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span>get<span class="token punctuation">(</span>
        <span class="token string">"/api/v1/users/me"</span><span class="token punctuation">,</span>
        headers<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"Authorization"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"Bearer </span><span class="token interpolation"><span class="token punctuation">{</span>token<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">assert</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span>
    <span class="token keyword">assert</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"email"</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"newuser@example.com"</span>
    
    <span class="token comment"># 4. Update profile</span>
    response <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span>patch<span class="token punctuation">(</span>
        <span class="token string">"/api/v1/users/me"</span><span class="token punctuation">,</span>
        headers<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"Authorization"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"Bearer </span><span class="token interpolation"><span class="token punctuation">{</span>token<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        json<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"full_name"</span><span class="token punctuation">:</span> <span class="token string">"New User"</span><span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">assert</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span>
</code></pre>
<h2 id="15-observability---traces-metrics-logs">15. Observability - Traces, Metrics, Logs</h2>
<h3 id="opentelemetry-auto-instrumentation">OpenTelemetry Auto-Instrumentation</h3>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token comment"># main.py</span>
<span class="token keyword">from</span> opentelemetry <span class="token keyword">import</span> trace
<span class="token keyword">from</span> opentelemetry<span class="token punctuation">.</span>instrumentation<span class="token punctuation">.</span>fastapi <span class="token keyword">import</span> FastAPIInstrumentor
<span class="token keyword">from</span> opentelemetry<span class="token punctuation">.</span>instrumentation<span class="token punctuation">.</span>sqlalchemy <span class="token keyword">import</span> SQLAlchemyInstrumentor
<span class="token keyword">from</span> opentelemetry<span class="token punctuation">.</span>instrumentation<span class="token punctuation">.</span>httpx <span class="token keyword">import</span> HTTPXClientInstrumentor
<span class="token keyword">from</span> opentelemetry<span class="token punctuation">.</span>sdk<span class="token punctuation">.</span>trace <span class="token keyword">import</span> TracerProvider
<span class="token keyword">from</span> opentelemetry<span class="token punctuation">.</span>sdk<span class="token punctuation">.</span>trace<span class="token punctuation">.</span>export <span class="token keyword">import</span> BatchSpanProcessor
<span class="token keyword">from</span> opentelemetry<span class="token punctuation">.</span>exporter<span class="token punctuation">.</span>otlp<span class="token punctuation">.</span>proto<span class="token punctuation">.</span>grpc<span class="token punctuation">.</span>trace_exporter <span class="token keyword">import</span> OTLPSpanExporter

<span class="token comment"># Setup tracing</span>
trace<span class="token punctuation">.</span>set_tracer_provider<span class="token punctuation">(</span>TracerProvider<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
tracer <span class="token operator">=</span> trace<span class="token punctuation">.</span>get_tracer<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

<span class="token comment"># OTLP exporter (works with Jaeger, Tempo, etc.)</span>
otlp_exporter <span class="token operator">=</span> OTLPSpanExporter<span class="token punctuation">(</span>
    endpoint<span class="token operator">=</span>settings<span class="token punctuation">.</span>OTEL_ENDPOINT<span class="token punctuation">,</span>  <span class="token comment"># e.g., "http://jaeger:4317"</span>
    insecure<span class="token operator">=</span><span class="token boolean">True</span>
<span class="token punctuation">)</span>
trace<span class="token punctuation">.</span>get_tracer_provider<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>add_span_processor<span class="token punctuation">(</span>
    BatchSpanProcessor<span class="token punctuation">(</span>otlp_exporter<span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token comment"># Auto-instrument</span>
FastAPIInstrumentor<span class="token punctuation">.</span>instrument_app<span class="token punctuation">(</span>app<span class="token punctuation">)</span>
SQLAlchemyInstrumentor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>instrument<span class="token punctuation">(</span>engine<span class="token operator">=</span>engine<span class="token punctuation">.</span>sync_engine<span class="token punctuation">)</span>
HTTPXClientInstrumentor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>instrument<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># Custom spans</span>
<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/users/{user_id}"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_user</span><span class="token punctuation">(</span>user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> db<span class="token punctuation">:</span> AsyncSession <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_db<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> tracer<span class="token punctuation">.</span>start_as_current_span<span class="token punctuation">(</span><span class="token string">"fetch_user_from_db"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        result <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>select<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>User<span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token operator">==</span> user_id<span class="token punctuation">)</span><span class="token punctuation">)</span>
        user <span class="token operator">=</span> result<span class="token punctuation">.</span>scalar_one_or_none<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">if</span> user<span class="token punctuation">:</span>
        <span class="token keyword">with</span> tracer<span class="token punctuation">.</span>start_as_current_span<span class="token punctuation">(</span><span class="token string">"fetch_user_orders"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            result <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>
                select<span class="token punctuation">(</span>Order<span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>Order<span class="token punctuation">.</span>user_id <span class="token operator">==</span> user_id<span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
            orders <span class="token operator">=</span> result<span class="token punctuation">.</span>scalars<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">"user"</span><span class="token punctuation">:</span> user<span class="token punctuation">,</span> <span class="token string">"orders"</span><span class="token punctuation">:</span> orders<span class="token punctuation">}</span>
</code></pre>
<h3 id="must-have-prometheus-metrics">Must-Have Prometheus Metrics</h3>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token keyword">from</span> prometheus_client <span class="token keyword">import</span> Counter<span class="token punctuation">,</span> Histogram<span class="token punctuation">,</span> Gauge<span class="token punctuation">,</span> generate_latest
<span class="token keyword">from</span> prometheus_client <span class="token keyword">import</span> CONTENT_TYPE_LATEST
<span class="token keyword">import</span> time

<span class="token comment"># Metrics</span>
http_requests_total <span class="token operator">=</span> Counter<span class="token punctuation">(</span>
    <span class="token string">'http_requests_total'</span><span class="token punctuation">,</span>
    <span class="token string">'Total HTTP requests'</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token string">'method'</span><span class="token punctuation">,</span> <span class="token string">'endpoint'</span><span class="token punctuation">,</span> <span class="token string">'status'</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span>

http_request_duration_seconds <span class="token operator">=</span> Histogram<span class="token punctuation">(</span>
    <span class="token string">'http_request_duration_seconds'</span><span class="token punctuation">,</span>
    <span class="token string">'HTTP request duration'</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token string">'method'</span><span class="token punctuation">,</span> <span class="token string">'endpoint'</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span>

active_connections <span class="token operator">=</span> Gauge<span class="token punctuation">(</span>
    <span class="token string">'active_websocket_connections'</span><span class="token punctuation">,</span>
    <span class="token string">'Active WebSocket connections'</span>
<span class="token punctuation">)</span>

db_connection_pool_size <span class="token operator">=</span> Gauge<span class="token punctuation">(</span>
    <span class="token string">'db_connection_pool_size'</span><span class="token punctuation">,</span>
    <span class="token string">'Database connection pool size'</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token string">'state'</span><span class="token punctuation">]</span>  <span class="token comment"># 'checked_out', 'available', 'total'</span>
<span class="token punctuation">)</span>

<span class="token comment"># Middleware to track metrics</span>
<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>middleware</span><span class="token punctuation">(</span><span class="token string">"http"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">metrics_middleware</span><span class="token punctuation">(</span>request<span class="token punctuation">:</span> Request<span class="token punctuation">,</span> call_next<span class="token punctuation">)</span><span class="token punctuation">:</span>
    start_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    response <span class="token operator">=</span> <span class="token keyword">await</span> call_next<span class="token punctuation">(</span>request<span class="token punctuation">)</span>
    duration <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start_time
    
    http_requests_total<span class="token punctuation">.</span>labels<span class="token punctuation">(</span>
        method<span class="token operator">=</span>request<span class="token punctuation">.</span>method<span class="token punctuation">,</span>
        endpoint<span class="token operator">=</span>request<span class="token punctuation">.</span>url<span class="token punctuation">.</span>path<span class="token punctuation">,</span>
        status<span class="token operator">=</span>response<span class="token punctuation">.</span>status_code
    <span class="token punctuation">)</span><span class="token punctuation">.</span>inc<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    http_request_duration_seconds<span class="token punctuation">.</span>labels<span class="token punctuation">(</span>
        method<span class="token operator">=</span>request<span class="token punctuation">.</span>method<span class="token punctuation">,</span>
        endpoint<span class="token operator">=</span>request<span class="token punctuation">.</span>url<span class="token punctuation">.</span>path
    <span class="token punctuation">)</span><span class="token punctuation">.</span>observe<span class="token punctuation">(</span>duration<span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> response

<span class="token comment"># Expose metrics endpoint</span>
<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/metrics"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">metrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Update DB pool metrics</span>
    pool <span class="token operator">=</span> engine<span class="token punctuation">.</span>pool
    db_connection_pool_size<span class="token punctuation">.</span>labels<span class="token punctuation">(</span>state<span class="token operator">=</span><span class="token string">"checked_out"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>checkedout<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    db_connection_pool_size<span class="token punctuation">.</span>labels<span class="token punctuation">(</span>state<span class="token operator">=</span><span class="token string">"available"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> pool<span class="token punctuation">.</span>checkedout<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    db_connection_pool_size<span class="token punctuation">.</span>labels<span class="token punctuation">(</span>state<span class="token operator">=</span><span class="token string">"total"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> Response<span class="token punctuation">(</span>content<span class="token operator">=</span>generate_latest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> media_type<span class="token operator">=</span>CONTENT_TYPE_LATEST<span class="token punctuation">)</span>
</code></pre>
<p><strong>Critical alerts to set up:</strong></p>
<pre class="language-yaml" data-language="yaml"><code is:raw="" class="language-yaml"><span class="token comment"># prometheus/alerts.yml</span>
<span class="token key atrule">groups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> fastapi
    <span class="token key atrule">rules</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">alert</span><span class="token punctuation">:</span> HighErrorRate
        <span class="token key atrule">expr</span><span class="token punctuation">:</span> rate(http_requests_total<span class="token punctuation">{</span>status=~"5.."<span class="token punctuation">}</span><span class="token punctuation">[</span>5m<span class="token punctuation">]</span>) <span class="token punctuation">></span> 0.05
        <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
          <span class="token key atrule">summary</span><span class="token punctuation">:</span> <span class="token string">"Error rate above 5%"</span>
      
      <span class="token punctuation">-</span> <span class="token key atrule">alert</span><span class="token punctuation">:</span> SlowRequests
        <span class="token key atrule">expr</span><span class="token punctuation">:</span> histogram_quantile(0.99<span class="token punctuation">,</span> http_request_duration_seconds) <span class="token punctuation">></span> 1.0
        <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
          <span class="token key atrule">summary</span><span class="token punctuation">:</span> <span class="token string">"p99 latency above 1s"</span>
      
      <span class="token punctuation">-</span> <span class="token key atrule">alert</span><span class="token punctuation">:</span> DatabasePoolExhausted
        <span class="token key atrule">expr</span><span class="token punctuation">:</span> db_connection_pool_size<span class="token punctuation">{</span>state="available"<span class="token punctuation">}</span> == 0
        <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
          <span class="token key atrule">summary</span><span class="token punctuation">:</span> <span class="token string">"No available DB connections"</span>
</code></pre>
<h3 id="structured-logging-with-logfire">Structured Logging with logfire</h3>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token keyword">import</span> logfire

<span class="token comment"># Configure logfire (or use structlog as alternative)</span>
logfire<span class="token punctuation">.</span>configure<span class="token punctuation">(</span>service_name<span class="token operator">=</span><span class="token string">"myapp"</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/users"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">create_user</span><span class="token punctuation">(</span>user<span class="token punctuation">:</span> UserCreate<span class="token punctuation">,</span> db<span class="token punctuation">:</span> AsyncSession <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_db<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    logfire<span class="token punctuation">.</span>info<span class="token punctuation">(</span>
        <span class="token string">"Creating user"</span><span class="token punctuation">,</span>
        email<span class="token operator">=</span>user<span class="token punctuation">.</span>email<span class="token punctuation">,</span>
        <span class="token comment"># Never log passwords!</span>
    <span class="token punctuation">)</span>
    
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        new_user <span class="token operator">=</span> <span class="token keyword">await</span> user_service<span class="token punctuation">.</span>create_user<span class="token punctuation">(</span>db<span class="token punctuation">,</span> user<span class="token punctuation">)</span>
        logfire<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"User created"</span><span class="token punctuation">,</span> user_id<span class="token operator">=</span>new_user<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span> email<span class="token operator">=</span>new_user<span class="token punctuation">.</span>email<span class="token punctuation">)</span>
        <span class="token keyword">return</span> new_user
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        logfire<span class="token punctuation">.</span>error<span class="token punctuation">(</span>
            <span class="token string">"Failed to create user"</span><span class="token punctuation">,</span>
            email<span class="token operator">=</span>user<span class="token punctuation">.</span>email<span class="token punctuation">,</span>
            error<span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">,</span>
            exc_info<span class="token operator">=</span><span class="token boolean">True</span>
        <span class="token punctuation">)</span>
        <span class="token keyword">raise</span>
</code></pre>
<p><strong>Alternative with structlog:</strong></p>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token keyword">import</span> structlog

logger <span class="token operator">=</span> structlog<span class="token punctuation">.</span>get_logger<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/users"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">create_user</span><span class="token punctuation">(</span>user<span class="token punctuation">:</span> UserCreate<span class="token punctuation">)</span><span class="token punctuation">:</span>
    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"user.create.start"</span><span class="token punctuation">,</span> email<span class="token operator">=</span>user<span class="token punctuation">.</span>email<span class="token punctuation">)</span>
    <span class="token comment"># ...</span>
    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"user.create.success"</span><span class="token punctuation">,</span> user_id<span class="token operator">=</span>new_user<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span> duration_ms<span class="token operator">=</span><span class="token number">123</span><span class="token punctuation">)</span>
</code></pre>
<h2 id="16-deployment-targets-in-2025">16. Deployment Targets in 2025</h2>
<h3 id="docker-multi-stage-build">Docker Multi-Stage Build</h3>
<pre class="language-dockerfile" data-language="dockerfile"><code is:raw="" class="language-dockerfile"><span class="token comment"># Dockerfile</span>
<span class="token instruction"><span class="token keyword">FROM</span> python:3.12-slim <span class="token keyword">as</span> builder</span>

<span class="token instruction"><span class="token keyword">WORKDIR</span> /app</span>

<span class="token comment"># Install build dependencies</span>
<span class="token instruction"><span class="token keyword">RUN</span> apt-get update &#x26;&#x26; apt-get install -y --no-install-recommends <span class="token operator">\</span>
    gcc <span class="token operator">\</span>
    postgresql-client <span class="token operator">\</span>
    &#x26;&#x26; rm -rf /var/lib/apt/lists/*</span>

<span class="token comment"># Install Python dependencies</span>
<span class="token instruction"><span class="token keyword">COPY</span> requirements.txt .</span>
<span class="token instruction"><span class="token keyword">RUN</span> pip install --no-cache-dir --user -r requirements.txt</span>

<span class="token comment"># Final stage</span>
<span class="token instruction"><span class="token keyword">FROM</span> python:3.12-slim</span>

<span class="token instruction"><span class="token keyword">WORKDIR</span> /app</span>

<span class="token comment"># Copy only installed packages</span>
<span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">builder</span></span> /root/.local /root/.local</span>
<span class="token instruction"><span class="token keyword">ENV</span> PATH=/root/.local/bin:<span class="token variable">$PATH</span></span>

<span class="token comment"># Copy application</span>
<span class="token instruction"><span class="token keyword">COPY</span> ./src /app/src</span>

<span class="token comment"># Non-root user</span>
<span class="token instruction"><span class="token keyword">RUN</span> useradd -m -u 1000 appuser &#x26;&#x26; chown -R appuser:appuser /app</span>
<span class="token instruction"><span class="token keyword">USER</span> appuser</span>

<span class="token comment"># Health check</span>
<span class="token instruction"><span class="token keyword">HEALTHCHECK</span> <span class="token options"><span class="token property">--interval</span><span class="token punctuation">=</span><span class="token string">30s</span> <span class="token property">--timeout</span><span class="token punctuation">=</span><span class="token string">3s</span> <span class="token property">--start-period</span><span class="token punctuation">=</span><span class="token string">5s</span> <span class="token property">--retries</span><span class="token punctuation">=</span><span class="token string">3</span></span> <span class="token operator">\</span>
    <span class="token keyword">CMD</span> python -c <span class="token string">"import httpx; httpx.get('http://localhost:8000/health')"</span></span>

<span class="token instruction"><span class="token keyword">CMD</span> [<span class="token string">"gunicorn"</span>, <span class="token string">"src.myapp.main:app"</span>, <span class="token operator">\</span>
     <span class="token string">"--workers"</span>, <span class="token string">"4"</span>, <span class="token operator">\</span>
     <span class="token string">"--worker-class"</span>, <span class="token string">"uvicorn.workers.UvicornWorker"</span>, <span class="token operator">\</span>
     <span class="token string">"--bind"</span>, <span class="token string">"0.0.0.0:8000"</span>, <span class="token operator">\</span>
     <span class="token string">"--timeout"</span>, <span class="token string">"60"</span>, <span class="token operator">\</span>
     <span class="token string">"--graceful-timeout"</span>, <span class="token string">"30"</span>]</span>
</code></pre>
<p><strong>Image size comparison:</strong></p>
<ul>
<li>Without multi-stage: 1.2GB</li>
<li>With multi-stage: 380MB</li>
<li>With alpine base: 280MB (but slower builds, C extension issues)</li>
</ul>
<h3 id="kubernetes-deployment">Kubernetes Deployment</h3>
<pre class="language-yaml" data-language="yaml"><code is:raw="" class="language-yaml"><span class="token comment"># k8s/deployment.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> fastapi<span class="token punctuation">-</span>app
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate
    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>
      <span class="token key atrule">maxSurge</span><span class="token punctuation">:</span> <span class="token number">1</span>
      <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> <span class="token number">0</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> fastapi<span class="token punctuation">-</span>app
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> fastapi<span class="token punctuation">-</span>app
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> app
        <span class="token key atrule">image</span><span class="token punctuation">:</span> myapp<span class="token punctuation">:</span>latest
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8000</span>
        <span class="token key atrule">env</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> DATABASE_URL
          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
            <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span>
              <span class="token key atrule">name</span><span class="token punctuation">:</span> app<span class="token punctuation">-</span>secrets
              <span class="token key atrule">key</span><span class="token punctuation">:</span> database<span class="token punctuation">-</span>url
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> REDIS_URL
          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
            <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span>
              <span class="token key atrule">name</span><span class="token punctuation">:</span> app<span class="token punctuation">-</span>secrets
              <span class="token key atrule">key</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>url
        <span class="token key atrule">resources</span><span class="token punctuation">:</span>
          <span class="token key atrule">requests</span><span class="token punctuation">:</span>
            <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">"512Mi"</span>
            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"500m"</span>
          <span class="token key atrule">limits</span><span class="token punctuation">:</span>
            <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">"1Gi"</span>
            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"1000m"</span>
        <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
          <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /health
            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8000</span>
          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>
          <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>
        <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>
          <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /health
            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8000</span>
          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>
          <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> fastapi<span class="token punctuation">-</span>service
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> fastapi<span class="token punctuation">-</span>app
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8000</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> LoadBalancer
</code></pre>
<h3 id="aws-lambda--powertools-cold-start-reality">AWS Lambda + Powertools (Cold Start Reality)</h3>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token comment"># lambda_handler.py</span>
<span class="token keyword">from</span> mangum <span class="token keyword">import</span> Mangum
<span class="token keyword">from</span> aws_lambda_powertools <span class="token keyword">import</span> Logger<span class="token punctuation">,</span> Tracer
<span class="token keyword">from</span> aws_lambda_powertools<span class="token punctuation">.</span>event_handler <span class="token keyword">import</span> APIGatewayRestResolver

<span class="token keyword">from</span> src<span class="token punctuation">.</span>myapp<span class="token punctuation">.</span>main <span class="token keyword">import</span> app

logger <span class="token operator">=</span> Logger<span class="token punctuation">(</span><span class="token punctuation">)</span>
tracer <span class="token operator">=</span> Tracer<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># Wrap FastAPI for Lambda</span>
handler <span class="token operator">=</span> Mangum<span class="token punctuation">(</span>app<span class="token punctuation">,</span> lifespan<span class="token operator">=</span><span class="token string">"off"</span><span class="token punctuation">)</span>

<span class="token comment"># Cold start benchmark (Lambda 1024MB, Python 3.12):</span>
<span class="token comment"># - First request: 800-1200ms (includes package import)</span>
<span class="token comment"># - Warm requests: 8-15ms</span>
<span class="token comment"># - Cold start frequency: ~1% with 100 RPS</span>
</code></pre>
<p><strong>When Lambda makes sense:</strong></p>
<ul>
<li>Sporadic traffic (&#x3C;1000 RPS)</li>
<li>Cost-sensitive (pay per request)</li>
<li>Serverless ecosystem (API Gateway, DynamoDB)</li>
</ul>
<p><strong>When Lambda is stupid:</strong></p>
<ul>
<li>Sustained high traffic (EC2/ECS cheaper)</li>
<li>WebSocket-heavy (connection limits)</li>
<li>Large dependencies (cold starts kill you)</li>
</ul>
<p><strong>Real cost comparison (10,000 RPS):</strong></p>
<ul>
<li>AWS Lambda: ~$2,800/month</li>
<li>ECS Fargate (4 tasks): ~$180/month</li>
<li>EC2 c6i.2xlarge (2 instances): ~$240/month</li>
</ul>
<h2 id="17-security-checklist-nobody-reads-until-breach">17. Security Checklist Nobody Reads Until Breach</h2>
<h3 id="cors-configuration-done-right">CORS Configuration Done Right</h3>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token keyword">from</span> fastapi<span class="token punctuation">.</span>middleware<span class="token punctuation">.</span>cors <span class="token keyword">import</span> CORSMiddleware

app<span class="token punctuation">.</span>add_middleware<span class="token punctuation">(</span>
    CORSMiddleware<span class="token punctuation">,</span>
    allow_origins<span class="token operator">=</span><span class="token punctuation">[</span>
        <span class="token string">"https://myapp.com"</span><span class="token punctuation">,</span>
        <span class="token string">"https://www.myapp.com"</span><span class="token punctuation">,</span>
        <span class="token string">"https://staging.myapp.com"</span>
    <span class="token punctuation">]</span> <span class="token keyword">if</span> settings<span class="token punctuation">.</span>ENVIRONMENT <span class="token operator">==</span> <span class="token string">"production"</span> <span class="token keyword">else</span> <span class="token punctuation">[</span><span class="token string">"*"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    allow_credentials<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    allow_methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"GET"</span><span class="token punctuation">,</span> <span class="token string">"POST"</span><span class="token punctuation">,</span> <span class="token string">"PUT"</span><span class="token punctuation">,</span> <span class="token string">"DELETE"</span><span class="token punctuation">,</span> <span class="token string">"PATCH"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    allow_headers<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"*"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    max_age<span class="token operator">=</span><span class="token number">3600</span>
<span class="token punctuation">)</span>
</code></pre>
<p><strong>NEVER do this in production:</strong></p>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token comment"># DISASTER:</span>
app<span class="token punctuation">.</span>add_middleware<span class="token punctuation">(</span>
    CORSMiddleware<span class="token punctuation">,</span>
    allow_origins<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"*"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># Any domain can call your API</span>
    allow_credentials<span class="token operator">=</span><span class="token boolean">True</span>  <span class="token comment"># And send cookies!</span>
<span class="token punctuation">)</span>
</code></pre>
<h3 id="rate-limiting">Rate Limiting</h3>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token keyword">from</span> slowapi <span class="token keyword">import</span> Limiter<span class="token punctuation">,</span> _rate_limit_exceeded_handler
<span class="token keyword">from</span> slowapi<span class="token punctuation">.</span>util <span class="token keyword">import</span> get_remote_address
<span class="token keyword">from</span> slowapi<span class="token punctuation">.</span>errors <span class="token keyword">import</span> RateLimitExceeded

limiter <span class="token operator">=</span> Limiter<span class="token punctuation">(</span>key_func<span class="token operator">=</span>get_remote_address<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>state<span class="token punctuation">.</span>limiter <span class="token operator">=</span> limiter
app<span class="token punctuation">.</span>add_exception_handler<span class="token punctuation">(</span>RateLimitExceeded<span class="token punctuation">,</span> _rate_limit_exceeded_handler<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/api/v1/users"</span><span class="token punctuation">)</span>
<span class="token decorator annotation punctuation">@limiter<span class="token punctuation">.</span>limit</span><span class="token punctuation">(</span><span class="token string">"100/minute"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_users</span><span class="token punctuation">(</span>request<span class="token punctuation">:</span> Request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span>

<span class="token comment"># Per-user rate limiting</span>
<span class="token keyword">def</span> <span class="token function">get_user_id</span><span class="token punctuation">(</span>request<span class="token punctuation">:</span> Request<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">str</span><span class="token punctuation">:</span>
    token <span class="token operator">=</span> request<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"Authorization"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"Bearer "</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
    <span class="token comment"># Extract user_id from token</span>
    <span class="token keyword">return</span> user_id <span class="token keyword">or</span> get_remote_address<span class="token punctuation">(</span>request<span class="token punctuation">)</span>

limiter_user <span class="token operator">=</span> Limiter<span class="token punctuation">(</span>key_func<span class="token operator">=</span>get_user_id<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/api/v1/orders"</span><span class="token punctuation">)</span>
<span class="token decorator annotation punctuation">@limiter_user<span class="token punctuation">.</span>limit</span><span class="token punctuation">(</span><span class="token string">"10/minute"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">create_order</span><span class="token punctuation">(</span>request<span class="token punctuation">:</span> Request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span>
</code></pre>
<h3 id="jwt-vs-opaque-tokens-vs-paseto">JWT vs Opaque Tokens vs PASETO</h3>
<p><strong>JWT (what we use):</strong></p>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime<span class="token punctuation">,</span> timedelta
<span class="token keyword">from</span> jose <span class="token keyword">import</span> jwt

<span class="token keyword">def</span> <span class="token function">create_access_token</span><span class="token punctuation">(</span>user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">str</span><span class="token punctuation">:</span>
    payload <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">"sub"</span><span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">(</span>user_id<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">"exp"</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>utcnow<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> timedelta<span class="token punctuation">(</span>hours<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">"iat"</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>utcnow<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> jwt<span class="token punctuation">.</span>encode<span class="token punctuation">(</span>payload<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>SECRET_KEY<span class="token punctuation">,</span> algorithm<span class="token operator">=</span><span class="token string">"HS256"</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">verify_token</span><span class="token punctuation">(</span>token<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">int</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        payload <span class="token operator">=</span> jwt<span class="token punctuation">.</span>decode<span class="token punctuation">(</span>token<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>SECRET_KEY<span class="token punctuation">,</span> algorithms<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"HS256"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token builtin">int</span><span class="token punctuation">(</span>payload<span class="token punctuation">[</span><span class="token string">"sub"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> jwt<span class="token punctuation">.</span>JWTError<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>status_code<span class="token operator">=</span><span class="token number">401</span><span class="token punctuation">,</span> detail<span class="token operator">=</span><span class="token string">"Invalid token"</span><span class="token punctuation">)</span>
</code></pre>
<p><strong>Pros:</strong> Stateless, no database lookup
<strong>Cons:</strong> Can’t revoke before expiry, larger payload</p>
<p><strong>Opaque tokens (for high-security):</strong></p>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token keyword">import</span> secrets
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime<span class="token punctuation">,</span> timedelta

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">create_session</span><span class="token punctuation">(</span>db<span class="token punctuation">:</span> AsyncSession<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">str</span><span class="token punctuation">:</span>
    token <span class="token operator">=</span> secrets<span class="token punctuation">.</span>token_urlsafe<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span>
    session <span class="token operator">=</span> Session<span class="token punctuation">(</span>
        token<span class="token operator">=</span>token<span class="token punctuation">,</span>
        user_id<span class="token operator">=</span>user_id<span class="token punctuation">,</span>
        expires_at<span class="token operator">=</span>datetime<span class="token punctuation">.</span>utcnow<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> timedelta<span class="token punctuation">(</span>hours<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    db<span class="token punctuation">.</span>add<span class="token punctuation">(</span>session<span class="token punctuation">)</span>
    <span class="token keyword">await</span> db<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> token

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">verify_session</span><span class="token punctuation">(</span>db<span class="token punctuation">:</span> AsyncSession<span class="token punctuation">,</span> token<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">int</span><span class="token punctuation">:</span>
    result <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>
        select<span class="token punctuation">(</span>Session<span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>
            Session<span class="token punctuation">.</span>token <span class="token operator">==</span> token<span class="token punctuation">,</span>
            Session<span class="token punctuation">.</span>expires_at <span class="token operator">></span> datetime<span class="token punctuation">.</span>utcnow<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    session <span class="token operator">=</span> result<span class="token punctuation">.</span>scalar_one_or_none<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> session<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>status_code<span class="token operator">=</span><span class="token number">401</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> session<span class="token punctuation">.</span>user_id
</code></pre>
<p><strong>Pros:</strong> Instant revocation, smaller tokens
<strong>Cons:</strong> Database hit on every request</p>
<h3 id="dependency-scanning">Dependency Scanning</h3>
<pre class="language-bash" data-language="bash"><code is:raw="" class="language-bash"><span class="token comment"># Add to CI/CD pipeline</span>
pip <span class="token function">install</span> pip-audit safety

<span class="token comment"># Check for CVEs</span>
pip-audit <span class="token parameter variable">--desc</span>
safety check <span class="token parameter variable">--json</span>

<span class="token comment"># In GitHub Actions:</span>
<span class="token comment"># .github/workflows/security.yml</span>
name: Security Scan
on: <span class="token punctuation">[</span>push, pull_request<span class="token punctuation">]</span>
jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Run pip-audit
        run: <span class="token operator">|</span>
          pip <span class="token function">install</span> pip-audit
          pip-audit <span class="token parameter variable">--desc</span> <span class="token parameter variable">--format</span> json
</code></pre>
<h2 id="18-performance-benchmarks---2025-hardware-numbers">18. Performance Benchmarks - 2025 Hardware Numbers</h2>
<h3 id="json-serialization-shootout">JSON Serialization Shootout</h3>
<p>AWS c6i.2xlarge (8 vCPU, 16GB RAM), 10,000 iterations:</p>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token keyword">import</span> orjson
<span class="token keyword">import</span> msgspec
<span class="token keyword">import</span> json

data <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">"users"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span><span class="token string">"id"</span><span class="token punctuation">:</span> i<span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"User </span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span> <span class="token string">"email"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"user</span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token punctuation">}</span></span><span class="token string">@example.com"</span></span><span class="token punctuation">}</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token comment"># std json:    42ms</span>
<span class="token comment"># orjson:      8ms   (5.2x faster)</span>
<span class="token comment"># msgspec:     6ms   (7.0x faster)</span>
</code></pre>
<p><strong>Production setup with orjson:</strong></p>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token keyword">from</span> fastapi<span class="token punctuation">.</span>responses <span class="token keyword">import</span> ORJSONResponse

app <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span>default_response_class<span class="token operator">=</span>ORJSONResponse<span class="token punctuation">)</span>

<span class="token comment"># Or per-endpoint:</span>
<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/users"</span><span class="token punctuation">,</span> response_class<span class="token operator">=</span>ORJSONResponse<span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_users</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">"users"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
</code></pre>
<h3 id="rps-vs-connection-pool-size">RPS vs Connection Pool Size</h3>
<p>PostgreSQL on AWS RDS db.r6g.xlarge, FastAPI on c6i.2xlarge (4 workers):</p>















































<table><thead><tr><th>Pool Size</th><th>RPS</th><th>p50</th><th>p99</th><th>DB CPU%</th></tr></thead><tbody><tr><td>5</td><td>2,100</td><td>12ms</td><td>450ms</td><td>15%</td></tr><tr><td>10</td><td>4,800</td><td>8ms</td><td>85ms</td><td>28%</td></tr><tr><td>20</td><td>8,200</td><td>6ms</td><td>22ms</td><td>42%</td></tr><tr><td>40</td><td>9,100</td><td>5ms</td><td>18ms</td><td>51%</td></tr><tr><td>80</td><td>9,400</td><td>6ms</td><td>24ms</td><td>58%</td></tr></tbody></table>
<p><strong>Sweet spot:</strong> pool_size = 20 per worker. Beyond that, diminishing returns.</p>
<h3 id="cold-start-comparison">Cold Start Comparison</h3>



































<table><thead><tr><th>Platform</th><th>Cold Start</th><th>Warm p99</th><th>Cost (10k RPS)</th></tr></thead><tbody><tr><td>AWS Lambda 1024MB</td><td>800ms</td><td>12ms</td><td>$2,800/mo</td></tr><tr><td>ECS Fargate 1vCPU</td><td>4s</td><td>8ms</td><td>$180/mo</td></tr><tr><td>EC2 c6i.2xlarge</td><td>0ms</td><td>6ms</td><td>$120/mo</td></tr><tr><td>GCP Cloud Run 1CPU</td><td>600ms</td><td>10ms</td><td>$220/mo</td></tr></tbody></table>
<h2 id="19-the-official-do-not-do-this-in-production-list">19. The Official “Do Not Do This in Production” List</h2>
<h3 id="1-blocking-io-in-async-routes">1. Blocking I/O in async Routes</h3>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token comment"># WRONG:</span>
<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/data"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"https://api.example.com/data"</span><span class="token punctuation">)</span>  <span class="token comment"># BLOCKS EVENT LOOP</span>
    <span class="token keyword">return</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># RIGHT:</span>
<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/data"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_data</span><span class="token punctuation">(</span>client<span class="token punctuation">:</span> httpx<span class="token punctuation">.</span>AsyncClient <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_http_client<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    response <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"https://api.example.com/data"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="2-storing-secrets-in-code">2. Storing Secrets in Code</h3>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token comment"># WRONG:</span>
SECRET_KEY <span class="token operator">=</span> <span class="token string">"super-secret-key-123"</span>

<span class="token comment"># RIGHT:</span>
<span class="token keyword">from</span> pydantic_settings <span class="token keyword">import</span> BaseSettings

<span class="token keyword">class</span> <span class="token class-name">Settings</span><span class="token punctuation">(</span>BaseSettings<span class="token punctuation">)</span><span class="token punctuation">:</span>
    SECRET_KEY<span class="token punctuation">:</span> <span class="token builtin">str</span>
    
    <span class="token keyword">class</span> <span class="token class-name">Config</span><span class="token punctuation">:</span>
        env_file <span class="token operator">=</span> <span class="token string">".env"</span>
</code></pre>
<h3 id="3-no-database-connection-pooling">3. No Database Connection Pooling</h3>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token comment"># WRONG:</span>
<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/users"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_users</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    conn <span class="token operator">=</span> <span class="token keyword">await</span> asyncpg<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token string">"postgresql://..."</span><span class="token punctuation">)</span>  <span class="token comment"># New connection every request</span>
    users <span class="token operator">=</span> <span class="token keyword">await</span> conn<span class="token punctuation">.</span>fetch<span class="token punctuation">(</span><span class="token string">"SELECT * FROM users"</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> users

<span class="token comment"># RIGHT: Use SQLAlchemy engine with pool (see section 7)</span>
</code></pre>
<h3 id="4-returning-sqlalchemy-models-directly">4. Returning SQLAlchemy Models Directly</h3>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token comment"># WRONG:</span>
<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/users/{user_id}"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_user</span><span class="token punctuation">(</span>user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> db<span class="token punctuation">:</span> AsyncSession <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_db<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    user <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span>get<span class="token punctuation">(</span>User<span class="token punctuation">,</span> user_id<span class="token punctuation">)</span>
    <span class="token keyword">return</span> user  <span class="token comment"># Exposes all DB columns, including hashed_password!</span>

<span class="token comment"># RIGHT:</span>
<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/users/{user_id}"</span><span class="token punctuation">,</span> response_model<span class="token operator">=</span>UserResponse<span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_user</span><span class="token punctuation">(</span>user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> db<span class="token punctuation">:</span> AsyncSession <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_db<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    user <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span>get<span class="token punctuation">(</span>User<span class="token punctuation">,</span> user_id<span class="token punctuation">)</span>
    <span class="token keyword">return</span> UserResponse<span class="token punctuation">.</span>model_validate<span class="token punctuation">(</span>user<span class="token punctuation">)</span>
</code></pre>
<h3 id="5-no-request-timeout">5. No Request Timeout</h3>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token comment"># WRONG:</span>
<span class="token keyword">async</span> <span class="token keyword">with</span> httpx<span class="token punctuation">.</span>AsyncClient<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> client<span class="token punctuation">:</span>
    response <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"https://slow-api.com"</span><span class="token punctuation">)</span>  <span class="token comment"># Waits forever</span>

<span class="token comment"># RIGHT:</span>
<span class="token keyword">async</span> <span class="token keyword">with</span> httpx<span class="token punctuation">.</span>AsyncClient<span class="token punctuation">(</span>timeout<span class="token operator">=</span>httpx<span class="token punctuation">.</span>Timeout<span class="token punctuation">(</span><span class="token number">10.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> client<span class="token punctuation">:</span>
    response <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"https://slow-api.com"</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="6-allow_origins-with-credentials">6. allow_origins=[”*”] with Credentials</h3>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token comment"># CRITICAL SECURITY ISSUE:</span>
app<span class="token punctuation">.</span>add_middleware<span class="token punctuation">(</span>
    CORSMiddleware<span class="token punctuation">,</span>
    allow_origins<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"*"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    allow_credentials<span class="token operator">=</span><span class="token boolean">True</span>  <span class="token comment"># Any site can steal user tokens</span>
<span class="token punctuation">)</span>

<span class="token comment"># RIGHT:</span>
app<span class="token punctuation">.</span>add_middleware<span class="token punctuation">(</span>
    CORSMiddleware<span class="token punctuation">,</span>
    allow_origins<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"https://myapp.com"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    allow_credentials<span class="token operator">=</span><span class="token boolean">True</span>
<span class="token punctuation">)</span>
</code></pre>
<h3 id="7-no-input-validation">7. No Input Validation</h3>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token comment"># WRONG:</span>
<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/users/{user_id}"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_user</span><span class="token punctuation">(</span>user_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># Should be int</span>
    user <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span>get<span class="token punctuation">(</span>User<span class="token punctuation">,</span> user_id<span class="token punctuation">)</span>  <span class="token comment"># SQL injection risk</span>

<span class="token comment"># RIGHT:</span>
<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/users/{user_id}"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_user</span><span class="token punctuation">(</span>user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># FastAPI validates</span>
    user <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span>get<span class="token punctuation">(</span>User<span class="token punctuation">,</span> user_id<span class="token punctuation">)</span>
</code></pre>
<h3 id="8-logging-sensitive-data">8. Logging Sensitive Data</h3>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token comment"># WRONG:</span>
logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"User login: </span><span class="token interpolation"><span class="token punctuation">{</span>email<span class="token punctuation">}</span></span><span class="token string"> with password </span><span class="token interpolation"><span class="token punctuation">{</span>password<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

<span class="token comment"># RIGHT:</span>
logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"User login attempt"</span><span class="token punctuation">,</span> extra<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"email"</span><span class="token punctuation">:</span> email<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="9-no-database-migration-strategy">9. No Database Migration Strategy</h3>
<pre class="language-python" data-language="python"><code is:raw="" class="language-python"><span class="token comment"># WRONG: Creating tables in code</span>
<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>on_event</span><span class="token punctuation">(</span><span class="token string">"startup"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">startup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">async</span> <span class="token keyword">with</span> engine<span class="token punctuation">.</span>begin<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> conn<span class="token punctuation">:</span>
        <span class="token keyword">await</span> conn<span class="token punctuation">.</span>run_sync<span class="token punctuation">(</span>Base<span class="token punctuation">.</span>metadata<span class="token punctuation">.</span>create_all<span class="token punctuation">)</span>  <span class="token comment"># Breaks in production</span>

<span class="token comment"># RIGHT: Use Alembic for migrations</span>
</code></pre>
<h3 id="10-forgetting-to-set-processworker-limits">10. Forgetting to Set process/worker Limits</h3>
<pre class="language-bash" data-language="bash"><code is:raw="" class="language-bash"><span class="token comment"># WRONG:</span>
uvicorn main:app  <span class="token comment"># Single process, single thread</span>

<span class="token comment"># RIGHT:</span>
gunicorn main:app <span class="token punctuation">\</span>
    <span class="token parameter variable">--workers</span> <span class="token number">4</span> <span class="token punctuation">\</span>
    --worker-class uvicorn.workers.UvicornWorker <span class="token punctuation">\</span>
    <span class="token parameter variable">--timeout</span> <span class="token number">60</span>
</code></pre>
<h2 id="20-final-production-checklist">20. Final Production Checklist</h2>
<p>Copy this into your PR template:</p>
<h3 id="before-deployment">Before Deployment</h3>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled> All secrets in environment variables (not code)</li>
<li class="task-list-item"><input type="checkbox" disabled> Database connection pooling configured (pool_size >= 10)</li>
<li class="task-list-item"><input type="checkbox" disabled> Response models defined (not returning ORM objects)</li>
<li class="task-list-item"><input type="checkbox" disabled> CORS configured with explicit origins (not ”*”)</li>
<li class="task-list-item"><input type="checkbox" disabled> Rate limiting enabled on public endpoints</li>
<li class="task-list-item"><input type="checkbox" disabled> Request timeouts set (httpx, database, external APIs)</li>
<li class="task-list-item"><input type="checkbox" disabled> Health check endpoint implemented (<code>/health</code>)</li>
<li class="task-list-item"><input type="checkbox" disabled> Metrics endpoint exposed (<code>/metrics</code>)</li>
<li class="task-list-item"><input type="checkbox" disabled> Structured logging configured (JSON format)</li>
<li class="task-list-item"><input type="checkbox" disabled> OpenTelemetry/tracing enabled</li>
<li class="task-list-item"><input type="checkbox" disabled> Error handling for all external service calls</li>
<li class="task-list-item"><input type="checkbox" disabled> Database migrations tested (Alembic)</li>
<li class="task-list-item"><input type="checkbox" disabled> Tests passing (>80% coverage)</li>
<li class="task-list-item"><input type="checkbox" disabled> No blocking I/O in async routes</li>
<li class="task-list-item"><input type="checkbox" disabled> Dependencies scanned (pip-audit, safety)</li>
</ul>
<h3 id="infrastructure">Infrastructure</h3>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled> Multi-stage Dockerfile (&#x3C;500MB image)</li>
<li class="task-list-item"><input type="checkbox" disabled> Non-root user in container</li>
<li class="task-list-item"><input type="checkbox" disabled> Health check in Dockerfile</li>
<li class="task-list-item"><input type="checkbox" disabled> Resource limits set (CPU, memory)</li>
<li class="task-list-item"><input type="checkbox" disabled> Graceful shutdown configured (lifespan)</li>
<li class="task-list-item"><input type="checkbox" disabled> Workers = CPU cores (Gunicorn config)</li>
<li class="task-list-item"><input type="checkbox" disabled> Log aggregation setup (CloudWatch, DataDog, etc.)</li>
<li class="task-list-item"><input type="checkbox" disabled> Prometheus metrics scraped</li>
<li class="task-list-item"><input type="checkbox" disabled> Alerts configured (error rate, latency, DB pool)</li>
<li class="task-list-item"><input type="checkbox" disabled> Horizontal autoscaling rules defined</li>
<li class="task-list-item"><input type="checkbox" disabled> Database connection limit checked (workers × pool_size &#x3C; max_connections)</li>
</ul>
<h3 id="security">Security</h3>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled> HTTPS enforced (not HTTP)</li>
<li class="task-list-item"><input type="checkbox" disabled> JWT/session tokens expire (&#x3C;24h)</li>
<li class="task-list-item"><input type="checkbox" disabled> Password hashing (bcrypt, not MD5)</li>
<li class="task-list-item"><input type="checkbox" disabled> SQL injection prevented (SQLAlchemy ORM, no raw SQL)</li>
<li class="task-list-item"><input type="checkbox" disabled> CORS with explicit origins</li>
<li class="task-list-item"><input type="checkbox" disabled> Rate limiting per IP and per user</li>
<li class="task-list-item"><input type="checkbox" disabled> Input validation on all endpoints</li>
<li class="task-list-item"><input type="checkbox" disabled> No sensitive data in logs</li>
<li class="task-list-item"><input type="checkbox" disabled> Security headers (CSP, X-Frame-Options, etc.)</li>
<li class="task-list-item"><input type="checkbox" disabled> Dependencies up-to-date (no critical CVEs)</li>
</ul>
<h3 id="documentation">Documentation</h3>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled> OpenAPI spec accessible (/docs for internal, authenticated for production)</li>
<li class="task-list-item"><input type="checkbox" disabled> API versioning strategy documented</li>
<li class="task-list-item"><input type="checkbox" disabled> README with local setup instructions</li>
<li class="task-list-item"><input type="checkbox" disabled> Environment variables documented</li>
<li class="task-list-item"><input type="checkbox" disabled> Architecture diagram exists</li>
<li class="task-list-item"><input type="checkbox" disabled> Runbook for common issues</li>
</ul>
<h3 id="performance">Performance</h3>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled> Database indexes on frequently queried columns</li>
<li class="task-list-item"><input type="checkbox" disabled> N+1 queries eliminated (use selectinload)</li>
<li class="task-list-item"><input type="checkbox" disabled> Caching strategy for expensive queries (Redis)</li>
<li class="task-list-item"><input type="checkbox" disabled> Background tasks offloaded (Celery/Arq for >30s tasks)</li>
<li class="task-list-item"><input type="checkbox" disabled> Response sizes reasonable (&#x3C;1MB)</li>
<li class="task-list-item"><input type="checkbox" disabled> Pagination on list endpoints</li>
<li class="task-list-item"><input type="checkbox" disabled> orjson or msgspec for JSON serialization</li>
</ul>
<hr> </div>    <section class="related-posts" data-astro-cid-dpgbfi7r> <h2 data-astro-cid-dpgbfi7r>Related Posts</h2> <div class="related-posts-grid" data-astro-cid-dpgbfi7r> <article class="related-post-card" data-astro-cid-dpgbfi7r> <a href="/python-sqlite-full-guide/" class="related-post-link" data-astro-cid-dpgbfi7r> <h3 data-astro-cid-dpgbfi7r>Python and SQLite in the Real World</h3> <p class="related-excerpt" data-astro-cid-dpgbfi7r>TL;DR – When to Use SQLite and When to Run Away SQLite is the most deployed database engine in the world, with billions…</p> <div class="related-meta" data-astro-cid-dpgbfi7r> <time datetime="2025-11-22T00:00:00.000Z" data-astro-cid-dpgbfi7r> Nov 22, 2025 </time> <span data-astro-cid-dpgbfi7r>•</span> <span data-astro-cid-dpgbfi7r>23 min read</span> </div> </a> </article><article class="related-post-card" data-astro-cid-dpgbfi7r> <a href="/ai-news/2025-11-10-build-a-docusaurus-like-site-with-fastapi-step-5-handling-static-files/" class="related-post-link" data-astro-cid-dpgbfi7r> <h3 data-astro-cid-dpgbfi7r>Handling Static Files in FastAPI for Markdown Documentation Sites</h3> <p class="related-excerpt" data-astro-cid-dpgbfi7r>Handling Static Files in FastAPI for Markdown Documentation Sites This article explains how to enable FastAPI to serve…</p> <div class="related-meta" data-astro-cid-dpgbfi7r> <time datetime="2025-11-10T00:00:00.000Z" data-astro-cid-dpgbfi7r> Nov 10, 2025 </time> <span data-astro-cid-dpgbfi7r>•</span> <span data-astro-cid-dpgbfi7r>2 min read</span> </div> </a> </article><article class="related-post-card" data-astro-cid-dpgbfi7r> <a href="/rest-response-structure/" class="related-post-link" data-astro-cid-dpgbfi7r> <h3 data-astro-cid-dpgbfi7r>Stop Sending Nulls in Your API Responses</h3> <p class="related-excerpt" data-astro-cid-dpgbfi7r>If you&#39;ve sat through backend architecture reviews, you&#39;ve witnessed The Great Null Debate. Someone cleans up a JSON…</p> <div class="related-meta" data-astro-cid-dpgbfi7r> <time datetime="2025-12-23T00:00:00.000Z" data-astro-cid-dpgbfi7r> Dec 23, 2025 </time> <span data-astro-cid-dpgbfi7r>•</span> <span data-astro-cid-dpgbfi7r>4 min read</span> </div> </a> </article><article class="related-post-card" data-astro-cid-dpgbfi7r> <a href="/sqlalchemy-full-guide/" class="related-post-link" data-astro-cid-dpgbfi7r> <h3 data-astro-cid-dpgbfi7r>SQLAlchemy 2.0 in Production - Full Guide</h3> <p class="related-excerpt" data-astro-cid-dpgbfi7r>Introduction This document describes how SQLAlchemy 2.0 operates in production systems. It assumes you understand…</p> <div class="related-meta" data-astro-cid-dpgbfi7r> <time datetime="2026-01-20T00:00:00.000Z" data-astro-cid-dpgbfi7r> Jan 20, 2026 </time> <span data-astro-cid-dpgbfi7r>•</span> <span data-astro-cid-dpgbfi7r>28 min read</span> </div> </a> </article> </div> </section>  </article> </div> <div class="back-link" data-astro-cid-yvbahnfj><a href="/" data-astro-cid-yvbahnfj>← Back to home</a></div>  </main> <!-- Site Footer --> <footer class="site-footer container"> <p>
© 2025 AREZKI El Mehdi •
<a href="https://github.com/earezki">GitHub</a> •
<a href="/rss.xml">RSS</a> •
<a href="/tags/">Tags</a> •
<a href="/sitemap-index.xml">Sitemap</a> •
<button id="footer-subscribe-btn" class="footer-subscribe-btn" aria-label="Subscribe to newsletter">
📬 Subscribe
</button> </p> </footer> <!-- Footer Subscribe Button Handler --> <script type="module">const e=document.getElementById("themeToggle"),o=n=>{if(!e)return;const t=e.querySelector(".theme-icon");t&&(t.textContent=n==="dark"?"☀":"☾")};if(e){const n=document.documentElement.getAttribute("data-theme")||"dark";o(n),e.addEventListener("click",()=>{const t=document.documentElement,c=t.getAttribute("data-theme")==="dark"?"light":"dark";t.setAttribute("data-theme",c),localStorage.setItem("theme",c),o(c)})}</script> <!-- Theme Toggle --> <script type="module">document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("footer-subscribe-btn");e&&e.addEventListener("click",n=>{n.preventDefault();const t=document.getElementById("subscription-popup");t&&(t.setAttribute("data-state","visible"),document.body.style.overflow="hidden")})});</script> <!-- Article read/unread tracking --> <script>
      (function() {
        const KEY = 'readArticles';
        
        function getRead() {
          try {
            const d = localStorage.getItem(KEY);
            return d ? JSON.parse(d) : [];
          } catch (e) {
            return [];
          }
        }
        
        function markRead(url) {
          try {
            const read = getRead();
            if (!read.includes(url)) {
              read.push(url);
              localStorage.setItem(KEY, JSON.stringify(read));
            }
          } catch (e) {}
        }
        
        function updateCards() {
          const read = new Set(getRead());
          const cards = document.querySelectorAll('.post-card[data-article-url]');
          cards.forEach(function(card) {
            const url = card.getAttribute('data-article-url');
            if (!url) return;
            const isRead = read.has(url);
            card.classList.toggle('read', isRead);
            card.classList.toggle('unread', !isRead);
          });
        }
        
        function markCurrent() {
          if (document.querySelector('.post-body')) {
            markRead(window.location.pathname);
          }
        }
        
        function init() {
          updateCards();
          markCurrent();
        }
        
        function clearRead(url) {
          try {
            const read = new Set(getRead());
            if (read.has(url)) {
              read.delete(url);
              localStorage.setItem(KEY, JSON.stringify(Array.from(read)));
              updateCards();
            }
          } catch (e) {}
        }
        
        window.clearReadArticle = clearRead;
        document.addEventListener('DOMContentLoaded', init);
        window.addEventListener('pageshow', function(e) {
          if (e.persisted) init();
        });
      })();
    </script> <!-- Clear read button handler --> <script>
      (function() {
        document.addEventListener('click', function(e) {
          var tgt = e.target, btn = null;
          while (tgt && tgt !== document) {
            if (tgt.classList && tgt.classList.contains('clear-read-btn')) {
              btn = tgt;
              break;
            }
            tgt = tgt.parentNode;
          }
          if (!btn) return;
          e.preventDefault();
          e.stopPropagation();
          var url = btn.getAttribute('data-article-url');
          if (url && window.clearReadArticle) window.clearReadArticle(url);
        });
      })();
    </script> <!-- External links open in new tab --> <script>
      (function() {
        function makeExternal() {
          const domain = window.location.hostname;
          const links = document.querySelectorAll('a[href]');
          links.forEach(function(link) {
            const href = link.getAttribute('href');
            if (!href || link.hasAttribute('target')) return;
            const isExt = (href.startsWith('http://') || href.startsWith('https://')) && !href.includes(domain);
            if (isExt) {
              link.setAttribute('target', '_blank');
              link.setAttribute('rel', 'noopener noreferrer');
            }
          });
        }
        document.addEventListener('DOMContentLoaded', makeExternal);
        if (window.MutationObserver) {
          const obs = new MutationObserver(function(muts) {
            muts.forEach(function(mut) {
              if (mut.addedNodes.length) makeExternal();
            });
          });
          obs.observe(document.body, { childList: true, subtree: true });
        }
      })();
    </script> <!-- Code copy buttons --> <script>
      (function() {
        function createBtn() {
          const btn = document.createElement('button');
          btn.className = 'copy-code-button';
          btn.setAttribute('aria-label', 'Copy code to clipboard');
          btn.innerHTML = `
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
              <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
            <span>Copy</span>
          `;
          return btn;
        }
        
        function checkIcon() {
          return `
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
            <span>Copied!</span>
          `;
        }
        
        async function copyText(txt) {
          try {
            await navigator.clipboard.writeText(txt);
            return true;
          } catch (err) {
            const ta = document.createElement('textarea');
            ta.value = txt;
            ta.style.position = 'fixed';
            ta.style.left = '-999999px';
            document.body.appendChild(ta);
            ta.select();
            try {
              document.execCommand('copy');
              document.body.removeChild(ta);
              return true;
            } catch (e) {
              document.body.removeChild(ta);
              return false;
            }
          }
        }
        
        async function handleCopy(btn, code) {
          const txt = code.textContent || '';
          const ok = await copyText(txt);
          if (ok) {
            const orig = btn.innerHTML;
            btn.classList.add('copied');
            btn.innerHTML = checkIcon();
            setTimeout(function() {
              btn.classList.remove('copied');
              btn.innerHTML = orig;
            }, 2000);
          }
        }
        
        function addBtns() {
          const blocks = document.querySelectorAll('.post-body pre');
          blocks.forEach(function(pre) {
            if (pre.querySelector('.copy-code-button')) return;
            const btn = createBtn();
            const code = pre.querySelector('code');
            if (code) {
              btn.addEventListener('click', function() {
                handleCopy(btn, code);
              });
              pre.appendChild(btn);
            }
          });
        }
        
        document.addEventListener('DOMContentLoaded', addBtns);
      })();
    </script> <!-- Newsletter Subscription Popup --> <div id="subscription-popup" class="subscription-popup" data-state="hidden" data-auto-trigger="true" data-astro-cid-we5gmdnp> <div class="popup-overlay" id="popup-overlay" data-astro-cid-we5gmdnp></div> <div class="popup-container" data-astro-cid-we5gmdnp> <div class="popup-content" data-astro-cid-we5gmdnp> <div class="popup-icon" data-astro-cid-we5gmdnp> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-astro-cid-we5gmdnp> <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" data-astro-cid-we5gmdnp></path> <polyline points="22,6 12,13 2,6" data-astro-cid-we5gmdnp></polyline> </svg> </div> <h2 class="popup-title" data-astro-cid-we5gmdnp>Stay Updated with Dev|Journal</h2> <p class="popup-description" id="popup-description" data-astro-cid-we5gmdnp>
Join our community of developers and engineers. Get insights on:
</p> <ul class="popup-features" data-astro-cid-we5gmdnp> <li data-astro-cid-we5gmdnp> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-astro-cid-we5gmdnp> <polyline points="20 6 9 17 4 12" data-astro-cid-we5gmdnp></polyline> </svg>
Software Architecture & Design Patterns
</li> <li data-astro-cid-we5gmdnp> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-astro-cid-we5gmdnp> <polyline points="20 6 9 17 4 12" data-astro-cid-we5gmdnp></polyline> </svg>
Backend Development Best Practices
</li> <li data-astro-cid-we5gmdnp> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-astro-cid-we5gmdnp> <polyline points="20 6 9 17 4 12" data-astro-cid-we5gmdnp></polyline> </svg>
AI & Tech Industry Analysis
</li> </ul> <form id="subscription-form" class="popup-form" data-astro-cid-we5gmdnp> <div class="form-group" data-astro-cid-we5gmdnp> <input type="text" id="subscriber-name" name="name" placeholder="Your name" required autocomplete="name" data-astro-cid-we5gmdnp> </div> <div class="form-group" data-astro-cid-we5gmdnp> <input type="email" id="subscriber-email" name="email" placeholder="your.email@example.com" required autocomplete="email" data-astro-cid-we5gmdnp> </div> <div id="form-message" class="form-message" data-astro-cid-we5gmdnp></div> <div class="popup-actions" data-astro-cid-we5gmdnp> <button type="submit" class="btn btn-primary" id="subscribe-btn" data-astro-cid-we5gmdnp> <span class="btn-text" data-astro-cid-we5gmdnp>Subscribe</span> <span class="btn-loader" data-astro-cid-we5gmdnp> <svg class="spinner" viewBox="0 0 24 24" data-astro-cid-we5gmdnp> <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none" data-astro-cid-we5gmdnp></circle> </svg> </span> </button> <button type="button" class="btn btn-secondary" id="not-now-btn" data-astro-cid-we5gmdnp>Not Now</button> <button type="button" class="btn btn-text" id="cancel-btn" data-astro-cid-we5gmdnp>Don't Show Again</button> </div> </form> </div> </div> </div>  <script>
  // Configuration
  const CONFIG = {
    graceDelay: 5000, // 5 seconds delay before showing popup
    notNowDelay: 24 * 60 * 60 * 1000, // 1 day in milliseconds
    apiUrl: 'https://api.earezki.com/blog/api',
  };

  const STORAGE_KEYS = {
    subscribed: 'newsletter_subscribed',
    cancelled: 'newsletter_cancelled',
    notNowUntil: 'newsletter_not_now_until',
  };

  // State management
  let popupTimeout = null;

  function showPopup() {
    const popup = document.getElementById('subscription-popup');
    if (popup) {
      popup.setAttribute('data-state', 'visible');
      document.body.style.overflow = 'hidden';
    }
  }

  function hidePopup() {
    const popup = document.getElementById('subscription-popup');
    if (popup) {
      popup.setAttribute('data-state', 'hidden');
      document.body.style.overflow = '';
    }
  }

  function shouldShowPopup() {
    // Check if user has already subscribed
    if (localStorage.getItem(STORAGE_KEYS.subscribed) === 'true') {
      return false;
    }

    // Check if user clicked "Don't show again"
    if (localStorage.getItem(STORAGE_KEYS.cancelled) === 'true') {
      return false;
    }

    // Check if user clicked "Not now" and delay hasn't passed
    const notNowUntil = localStorage.getItem(STORAGE_KEYS.notNowUntil);
    if (notNowUntil) {
      const notNowTime = parseInt(notNowUntil, 10);
      if (Date.now() < notNowTime) {
        return false;
      }
    }

    return true;
  }

  async function getSubscriberStats() {
    try {
      const response = await fetch(`${CONFIG.apiUrl}/subscribers/stats`, {
        method: 'GET',
        headers: {
          'Accept': 'application/json',
        },
      });
      
      if (!response.ok) {
        return null;
      }
      
      const data = await response.json();
      return data.subscriber_count || null;
    } catch (error) {
      console.error('Failed to fetch subscriber stats:', error);
      return null;
    }
  }

  async function schedulePopup() {
    if (!shouldShowPopup()) {
      return;
    }

    // Fetch subscriber stats before scheduling popup
    const subscriberCount = await getSubscriberStats();
    if (subscriberCount === null) {
      console.log('Failed to fetch subscriber stats, not showing subscription popup');
      return;
    }

    // Update popup with subscriber count
    updatePopupWithStats(subscriberCount);

    // Show popup after grace period
    popupTimeout = window.setTimeout(() => {
      showPopup();
    }, CONFIG.graceDelay);
  }

  function updatePopupWithStats(count) {
    const descriptionEl = document.querySelector('.popup-description');
    if (descriptionEl) {
      const formattedCount = new Intl.NumberFormat('en-US').format(count);
      descriptionEl.innerHTML = `Join a community of <strong>${formattedCount}+</strong> developers and engineers who are growing together. Get insights on:`;
    }
  }

  async function handleSubscribe(event) {
    event.preventDefault();
    
    const form = event.target;
    const nameInput = form.querySelector('#subscriber-name');
    const emailInput = form.querySelector('#subscriber-email');
    const submitBtn = form.querySelector('#subscribe-btn');
    const messageEl = document.getElementById('form-message');

    const name = nameInput.value.trim();
    const email = emailInput.value.trim();

    if (!name || !email) {
      if (messageEl) {
        messageEl.textContent = 'Please fill in all fields.';
        messageEl.className = 'form-message error';
      }
      return;
    }

    // Show loading state
    submitBtn.classList.add('loading');
    submitBtn.disabled = true;
    if (messageEl) {
      messageEl.textContent = '';
      messageEl.className = 'form-message';
    }

    try {
      const response = await fetch(`${CONFIG.apiUrl}/subscribe`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ name, email }),
      });

      const data = await response.json();

      if (data.success) {
        localStorage.setItem(STORAGE_KEYS.subscribed, 'true');
        
        if (messageEl) {
          messageEl.textContent = '🎉 Successfully subscribed! Thank you for joining us.';
          messageEl.className = 'form-message success';
        }

        // Hide popup after 2 seconds
        setTimeout(() => {
          hidePopup();
        }, 2000);
      } else {
        if (messageEl) {
          messageEl.textContent = data.error || 'Subscription failed. Please try again.';
          messageEl.className = 'form-message error';
        }
      }
    } catch (error) {
      console.error('Subscription error:', error);
      if (messageEl) {
        messageEl.textContent = 'Network error. Please check your connection and try again.';
        messageEl.className = 'form-message error';
      }
    } finally {
      submitBtn.classList.remove('loading');
      submitBtn.disabled = false;
    }
  }

  function handleNotNow() {
    const notNowUntil = Date.now() + CONFIG.notNowDelay;
    localStorage.setItem(STORAGE_KEYS.notNowUntil, notNowUntil.toString());
    hidePopup();
  }

  function handleCancel() {
    localStorage.setItem(STORAGE_KEYS.cancelled, 'true');
    hidePopup();
  }

  // Initialize popup
  document.addEventListener('DOMContentLoaded', () => {
    const popup = document.getElementById('subscription-popup');
    const autoTrigger = popup?.getAttribute('data-auto-trigger') === 'true';
    
    // Schedule popup to show after grace period only if autoTrigger is enabled
    if (autoTrigger) {
      schedulePopup();
    }

    // Event listeners
    const form = document.getElementById('subscription-form');
    const overlay = document.getElementById('popup-overlay');
    const notNowBtn = document.getElementById('not-now-btn');
    const cancelBtn = document.getElementById('cancel-btn');

    if (form) {
      form.addEventListener('submit', handleSubscribe);
    }

    if (overlay) {
      overlay.addEventListener('click', handleNotNow);
    }

    if (notNowBtn) {
      notNowBtn.addEventListener('click', handleNotNow);
    }

    if (cancelBtn) {
      cancelBtn.addEventListener('click', handleCancel);
    }

    // Clean up on page unload
    window.addEventListener('beforeunload', () => {
      if (popupTimeout) {
        clearTimeout(popupTimeout);
      }
    });
  });
</script> </body></html> 