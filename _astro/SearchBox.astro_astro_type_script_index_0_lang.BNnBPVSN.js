let L=null,T=!1;const U="earezki-search-db",z=1,I="search-index",H="search-data",V="index-version",O=document.querySelector(".header-search"),P=O?.dataset.searchApiUrl||"",F=parseInt(O?.dataset.searchTimeout||"2000",10),C=new Map,K=10;function $(){return new Promise((e,t)=>{const r=indexedDB.open(U,z);r.onerror=()=>t(r.error),r.onsuccess=()=>e(r.result),r.onupgradeneeded=n=>{const s=n.target.result;s.objectStoreNames.contains(I)||s.createObjectStore(I)}})}async function D(){try{const r=(await $()).transaction(I,"readonly").objectStore(I);return new Promise(n=>{const s=r.get(H),c=r.get(V);let u=0,v=null,x=null;s.onsuccess=()=>{v=s.result||null,++u===2&&n({data:v,version:x})},c.onsuccess=()=>{x=c.result||null,++u===2&&n({data:v,version:x})},s.onerror=c.onerror=()=>n({data:null,version:null})})}catch(e){return console.warn("[Search] IndexedDB failed:",e),{data:null,version:null}}}async function W(e,t){try{const n=(await $()).transaction(I,"readwrite"),s=n.objectStore(I);return s.put(e,H),s.put(t,V),new Promise((c,u)=>{n.oncomplete=()=>c(),n.onerror=()=>u(n.error)})}catch(r){console.warn("[Search] Cache failed:",r)}}async function X(){try{const e=await fetch("/search.json",{method:"HEAD"});return e.headers.get("ETag")||e.headers.get("Last-Modified")}catch(e){return console.warn("[Search] Version check failed:",e),null}}async function R(){if(L)return L;if(T)return await new Promise(e=>setTimeout(e,100)),R();T=!0;try{const e=await X(),{data:t,version:r}=await D();if(t&&r&&e&&r===e)return L=t,t;console.log("[Search] Fetching index");const n=await fetch("/search.json");if(!n.ok){if(t)return console.warn("[Search] Fetch failed, using stale cache"),L=t,t;throw new Error(`Fetch failed: ${n.status}`)}const s=await n.json();return L=s,e&&await W(s,e),s}catch(e){console.error("[Search] Load failed:",e);const{data:t}=await D();return t?(L=t,t):{categories:[],articles:[]}}finally{T=!1}}function _(e){return e.replace(/^["']|["']$/g,"").replace(/\\"/g,'"').replace(/\\'/g,"'")}function Y(e){return e.endsWith("/")?e:e+"/"}async function J(e){if(!P)return null;try{const t=new AbortController,r=setTimeout(()=>t.abort(),F),n=await fetch(`${P}?k=${encodeURIComponent(e)}`,{signal:t.signal,headers:{Accept:"application/json"}});return clearTimeout(r),n.ok?(await n.json()).map(c=>{const u=Y(c.url);return{title:_(c.title),excerpt:_(c.description),pubDate:c.published_at,url:u,categories:[]}}):(console.warn("[Search] Server API returned error:",n.status),null)}catch(t){return t instanceof Error&&t.name==="AbortError"?console.warn("[Search] Server API timeout, falling back to client search"):console.warn("[Search] Server API error, falling back to client search:",t),null}}const N=new Map;function Q(e){if(N.has(e))return N.get(e);try{const r=JSON.parse(localStorage.getItem("readArticles")||"[]").includes(e);return N.set(e,r),r}catch{return!1}}document.addEventListener("DOMContentLoaded",async function(){const e=document.getElementById("search-box"),t=document.getElementById("search-input"),r=document.getElementById("clear-search"),n=document.getElementById("search-results"),s=document.querySelector(".header-search"),c=document.querySelector(".site-header");if(!t||!n||!e)return;await R();let u="",v="";t.addEventListener("focus",function(){e.classList.add("vibrating"),setTimeout(()=>e.classList.remove("vibrating"),200),c&&c.classList.add("search-active"),s&&s.classList.add("search-active"),t.value.trim().length>=3&&x(t.value)}),t.addEventListener("blur",function(){setTimeout(()=>{c&&c.classList.remove("search-active"),s&&s.classList.remove("search-active")},100)});async function x(o){if(o=o.trim(),!o||o.length<3){n.style.display="none",r&&(r.style.display=o.length>0?"flex":"none"),u=v="";return}if(o===u&&n.style.display==="block")return;if(u=o,r&&(r.style.display="flex"),C.has(o)){const d=C.get(o);M(d.results,d.isAPI);return}let p=await J(o),h=!!p;if(!p){const d=await R(),w=o.toLowerCase().split(/\s+/).filter(i=>i.length>=2),b=new Map;for(const i of w){const l=new Set;d.categories.forEach((m,f)=>{m.toLowerCase().includes(i)&&l.add(f)}),b.set(i,l)}p=d.articles.map(i=>{const l=i.title.toLowerCase(),m=i.excerpt.toLowerCase();let f=0,g=0;for(const y of w){l.includes(y)&&(f+=10,g++);const E=b.get(y);E&&i.categories.some(S=>E.has(S))&&(f+=5,g++),m.includes(y)&&(f+=2,g++)}return g>=w.length?{art:i,score:f}:null}).filter(Boolean).sort((i,l)=>l.score-i.score).map(i=>i.art),h=!1}if(C.size>=K){const d=C.keys().next().value;d&&C.delete(d)}C.set(o,{results:p,isAPI:h});const k=p.slice(0,6).map(d=>d.url).join("|");(k!==v||n.style.display!=="block")&&(v=k,M(p,h))}function M(o,p=!1){n.innerHTML="";const h=document.createElement("div");if(h.className="search-results-scroll",o.length===0){const a=document.createElement("div");a.className="search-no-results",a.innerHTML=`
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
          <div>No results found. Try different keywords.</div>
        `,h.appendChild(a),n.appendChild(h),n.style.display="flex";return}const k=o.length;if(o.slice(0,6).forEach(function(a){const w=new Date(a.pubDate).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"}),b=(a.excerpt||"").split(" "),B=b.slice(0,10).join(" ")+(b.length>10?"...":""),i=Q(a.url),l=document.createElement("a");l.href=a.url,l.className="search-result-card";const m=document.createElement("div");m.className="search-result-content";const f=document.createElement("div");f.className="search-result-date",f.textContent=w;const g=document.createElement("h3");g.className="search-result-title",g.textContent=a.title;const y=document.createElement("p");y.className="search-result-excerpt",y.textContent=B,m.appendChild(f),m.appendChild(g),m.appendChild(y);const E=document.createElement("div");if(E.className="search-result-actions",i){const A=document.createElement("div");A.className="search-result-icon read-indicator",A.title="Already read",A.innerHTML=`
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
          `,E.appendChild(A)}const S=document.createElement("div");S.className="search-result-icon go-icon",S.title="Read article",S.innerHTML=`
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="9 18 15 12 9 6"></polyline>
          </svg>
        `,E.appendChild(S),l.appendChild(m),l.appendChild(E),h.appendChild(l)}),k>6){const a=document.createElement("div");a.className="search-more-results";const w=k-6;a.innerHTML=`<strong>+${w}</strong> more result${w!==1?"s":""} not shown`,h.appendChild(a)}if(n.appendChild(h),p){const a=document.createElement("div");a.className="search-footer",a.innerHTML="<small>âœ¨ Powered by AI Search</small>",n.appendChild(a)}n.style.display="flex"}let j;t.addEventListener("input",function(o){clearTimeout(j),j=window.setTimeout(()=>{x(o.target.value)},300)}),r&&r.addEventListener("click",function(){t.value="",n.style.display="none",r.style.display="none",c&&c.classList.remove("search-active"),s&&s.classList.remove("search-active"),t.focus()}),document.addEventListener("click",function(o){s&&!s.contains(o.target)&&(n.style.display="none",c&&c.classList.remove("search-active"),s&&s.classList.remove("search-active"))})});
